<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æœ‰é™å…ƒç´ ç”»å¸ƒ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background: #f5f5f5;
            padding: 20px;
            min-height: 100vh;
        }

        .app-header {
            max-width: 1600px;
            margin: 0 auto 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: white;
            padding: 15px 20px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .app-header h1 {
            font-size: 24px;
            color: #1a1a1a;
        }

        .header-actions {
            display: flex;
            gap: 10px;
        }

        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s;
        }

        .btn-primary {
            background: #3b82f6;
            color: white;
        }

        .btn-primary:hover {
            background: #2563eb;
        }

        .btn-success {
            background: #10b981;
            color: white;
        }

        .btn-success:hover {
            background: #059669;
        }

        .btn-secondary {
            background: #6b7280;
            color: white;
        }

        .btn-secondary:hover {
            background: #4b5563;
        }

        .app-container {
            display: flex;
            gap: 15px;
            max-width: 100%;
            margin: 0 auto;
            height: calc(100vh - 120px);
        }

        /* å·¦ä¾§å…ƒç´ åˆ—è¡¨é¢æ¿ */
        .element-list-panel {
            flex: 0 0 280px;
            background: white;
            border-radius: 12px;
            padding: 15px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .element-list-panel h2 {
            font-size: 18px;
            margin-bottom: 15px;
            color: #1a1a1a;
            padding-bottom: 10px;
            border-bottom: 2px solid #f0f0f0;
        }

        .element-list {
            flex: 1;
            overflow-y: auto;
            margin-bottom: 15px;
        }

        /* ä¸­é—´ç”»å¸ƒé¢æ¿ */
        .canvas-panel {
            flex: 1;
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            display: flex;
            flex-direction: column;
            position: relative;
            overflow: hidden;
        }

        /* å³ä¾§ç¼–è¾‘é¢æ¿ */
        .edit-panel {
            flex: 0 0 380px;
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            overflow-y: auto;
        }

        .edit-panel h2 {
            font-size: 18px;
            margin-bottom: 15px;
            color: #1a1a1a;
            padding-bottom: 10px;
            border-bottom: 2px solid #f0f0f0;
        }

        .edit-panel-empty {
            text-align: center;
            padding: 40px 20px;
            color: #999;
        }

        .edit-panel-empty-icon {
            font-size: 48px;
            margin-bottom: 10px;
        }

        /* å…ƒç´ åˆ—è¡¨é¡¹ */
        .element-list-item {
            background: #f9fafb;
            border: 2px solid #e5e5e5;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
        }

        .element-list-item:hover {
            border-color: #3b82f6;
            background: #eff6ff;
        }

        .element-list-item.selected {
            border-color: #3b82f6;
            background: #dbeafe;
            box-shadow: 0 2px 8px rgba(59, 130, 246, 0.3);
        }

        .element-list-item-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 6px;
        }

        .element-list-item-icon {
            font-size: 20px;
        }

        .element-list-item-title {
            flex: 1;
            font-weight: 500;
            font-size: 14px;
            color: #333;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .element-list-item-preview {
            font-size: 12px;
            color: #666;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .element-list-item-drag {
            position: absolute;
            top: 8px;
            right: 8px;
            color: #999;
            cursor: move;
            font-size: 16px;
        }

        /* é…ç½®é¢æ¿ï¼ˆä¿ç•™å…¼å®¹æ€§ï¼‰ */
        .config-panel {
            display: none; /* æ—§ç‰ˆé…ç½®é¢æ¿éšè— */
        }

        .config-panel h2 {
            font-size: 20px;
            margin-bottom: 20px;
            color: #1a1a1a;
        }

        .config-name-group {
            margin-bottom: 20px;
            padding: 15px;
            background: #f9fafb;
            border-radius: 8px;
        }

        .config-name-group label {
            display: block;
            font-size: 14px;
            font-weight: 500;
            color: #555;
            margin-bottom: 8px;
        }

        .config-name-group input {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
        }

        .item-config {
            border: 2px solid #e5e5e5;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            background: #fafafa;
            cursor: move;
            position: relative;
            transition: all 0.2s;
        }

        .item-config:hover {
            border-color: #3b82f6;
            box-shadow: 0 2px 8px rgba(59, 130, 246, 0.2);
        }

        .item-config.dragging {
            opacity: 0.5;
            border-color: #3b82f6;
        }

        .item-config.error {
            border-color: #ef4444;
        }

        .drag-handle {
            position: absolute;
            top: 10px;
            right: 50px;
            cursor: move;
            color: #999;
            font-size: 18px;
        }

        .item-config-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .item-config-title {
            font-weight: 600;
            color: #333;
        }

        .btn-delete {
            background: #ef4444;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
        }

        .btn-delete:hover {
            background: #dc2626;
        }

        .form-group {
            margin-bottom: 12px;
        }

        .form-group label {
            display: block;
            font-size: 14px;
            font-weight: 500;
            color: #555;
            margin-bottom: 5px;
        }

        .form-group label .required {
            color: #ef4444;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
        }

        .form-group input:invalid,
        .form-group textarea:invalid {
            border-color: #ef4444;
        }

        .form-group textarea {
            min-height: 60px;
            resize: vertical;
        }

        .style-help {
            font-size: 12px;
            color: #666;
            margin-top: 5px;
            padding: 8px;
            background: #f9fafb;
            border-radius: 4px;
        }

        .style-help code {
            background: #e5e7eb;
            padding: 2px 4px;
            border-radius: 3px;
            font-size: 11px;
        }

        .form-group input[type="color"] {
            height: 40px;
            cursor: pointer;
        }

        .error-message {
            color: #ef4444;
            font-size: 12px;
            margin-top: 4px;
        }

        /* æŒ‰é’®ç»„æ ·å¼ */
        .button-group {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .button-group .option-btn {
            flex: 1;
            min-width: 100px;
            padding: 10px 16px;
            border: 2px solid #ddd;
            background: white;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            color: #555;
            transition: all 0.2s;
            text-align: center;
        }

        .button-group .option-btn:hover {
            border-color: #3b82f6;
            color: #3b82f6;
            background: #eff6ff;
        }

        .button-group .option-btn.active {
            background: #3b82f6;
            color: white;
            border-color: #3b82f6;
        }

        .emoji-input-group {
            display: flex;
            gap: 5px;
            flex-wrap: wrap;
            margin-bottom: 8px;
        }

        .emoji-display {
            position: relative;
            display: inline-block;
        }

        .emoji-display input {
            width: 60px;
            text-align: center;
            font-size: 24px;
        }

        .btn-pick-emoji {
            background: #8b5cf6;
            color: white;
            border: none;
            padding: 6px 10px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            margin-left: 5px;
        }

        .btn-pick-emoji:hover {
            background: #7c3aed;
        }

        .btn-remove-emoji {
            background: #ef4444;
            color: white;
            border: none;
            padding: 4px 8px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
        }

        .btn-remove-emoji:hover {
            background: #dc2626;
        }

        .btn-add-emoji {
            background: #10b981;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            width: 100%;
            margin-top: 5px;
        }

        .btn-add-emoji:hover {
            background: #059669;
        }

        .btn-add-item {
            width: 100%;
            background: #3b82f6;
            color: white;
            border: none;
            padding: 12px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            margin-top: 10px;
        }

        .btn-add-item:hover {
            background: #2563eb;
        }

        /* Emojié€‰æ‹©å™¨å¼¹çª— */
        .emoji-picker-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 3000;
            align-items: center;
            justify-content: center;
        }

        .emoji-picker-modal.show {
            display: flex;
        }

        .emoji-picker-content {
            background: white;
            border-radius: 12px;
            padding: 20px;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
        }

        .emoji-picker-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .emoji-picker-header h3 {
            font-size: 18px;
            color: #1a1a1a;
        }

        .btn-close-picker {
            background: #ef4444;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
        }

        .emoji-categories {
            display: flex;
            gap: 8px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }

        .category-btn {
            padding: 6px 12px;
            border: 2px solid #ddd;
            background: white;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s;
        }

        .category-btn:hover {
            border-color: #3b82f6;
            color: #3b82f6;
        }

        .category-btn.active {
            background: #3b82f6;
            color: white;
            border-color: #3b82f6;
        }

        .emoji-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(50px, 1fr));
            gap: 10px;
            max-height: 400px;
            overflow-y: auto;
            padding: 10px;
            background: #f9fafb;
            border-radius: 8px;
        }

        .emoji-item {
            font-size: 32px;
            padding: 10px;
            text-align: center;
            cursor: pointer;
            border-radius: 6px;
            transition: all 0.2s;
            background: white;
        }

        .emoji-item:hover {
            background: #e0e7ff;
            transform: scale(1.1);
        }

        /* é¢„è§ˆé¢æ¿ */
        .preview-panel {
            flex: 1;
            background: white;
            border-radius: 12px;
            padding: 40px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
            min-height: 600px;
            position: relative;
            overflow: auto;
        }

        /* ç”»å¸ƒå·¥å…·æ  */
        .canvas-toolbar {
            position: absolute;
            top: 15px;
            right: 15px;
            z-index: 100;
            display: flex;
            gap: 8px;
        }

        .canvas-toolbar .btn {
            background: white;
            border: 2px solid #3b82f6;
            color: #3b82f6;
            padding: 8px 16px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            transition: all 0.2s;
        }

        .canvas-toolbar .btn:hover {
            background: #3b82f6;
            color: white;
        }

        /* å…ƒç´ æ“ä½œæŒ‰é’® */
        .item-actions {
            position: absolute;
            top: -12px;
            right: -12px;
            display: none;
            gap: 4px;
            z-index: 20;
        }

        .comparison-item:hover .item-actions {
            display: flex;
        }

        .item-action-btn {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            border: none;
            cursor: pointer;
            font-size: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
            transition: all 0.2s;
        }

        .item-action-btn.edit {
            background: #3b82f6;
            color: white;
        }

        .item-action-btn.edit:hover {
            background: #2563eb;
            transform: scale(1.1);
        }

        .item-action-btn.delete {
            background: #ef4444;
            color: white;
        }

        .item-action-btn.delete:hover {
            background: #dc2626;
            transform: scale(1.1);
        }

        .item-action-btn.add-sticker {
            background: #8b5cf6;
            color: white;
        }

        .item-action-btn.add-sticker:hover {
            background: #7c3aed;
            transform: scale(1.1);
        }

        /* è£…é¥°emojiæ ·å¼ */
        .decorative-emoji-item {
            position: absolute;
            cursor: move;
            user-select: none;
            z-index: 10;
            display: inline-block;
        }

        .decorative-emoji-item.selected {
            outline: 2px dashed #3b82f6;
            outline-offset: 4px;
            border-radius: 4px;
        }

        .decorative-emoji-item.dragging {
            opacity: 0.7;
            z-index: 100;
        }

        .decorative-emoji-delete {
            position: absolute;
            top: -12px;
            right: -12px;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: #ef4444;
            color: white;
            border: none;
            font-size: 14px;
            cursor: pointer;
            display: none;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
            z-index: 10;
        }

        .decorative-emoji-item.selected .decorative-emoji-delete {
            display: flex;
        }

        .decorative-emoji-delete:hover {
            background: #dc2626;
        }

        /* è°ƒæ•´æ‰‹æŸ„æ ·å¼ */
        .resize-handle {
            position: absolute;
            width: 12px;
            height: 12px;
            background: white;
            border: 2px solid #3b82f6;
            border-radius: 50%;
            display: none;
            z-index: 11;
        }

        .decorative-emoji-item.selected .resize-handle {
            display: block;
        }

        .resize-handle.se {
            bottom: -6px;
            right: -6px;
            cursor: nwse-resize;
        }

        .resize-handle:hover {
            background: #3b82f6;
            transform: scale(1.2);
        }

        /* æ–‡æœ¬æ¡†é€‰ä¸­æ ·å¼å’Œè°ƒæ•´æ‰‹æŸ„ */
        .text-box-container.selected {
            outline: 2px solid #3b82f6;
            outline-offset: 4px;
            border-radius: 8px;
        }

        .text-box-resize-handle {
            position: absolute;
            width: 10px;
            height: 10px;
            background: white;
            border: 2px solid #3b82f6;
            border-radius: 2px;
            display: none;
            z-index: 20;
        }

        .text-box-container.selected .text-box-resize-handle {
            display: block;
        }

        .text-box-resize-handle.e {
            right: -5px;
            top: 50%;
            transform: translateY(-50%);
            cursor: ew-resize;
        }

        .text-box-resize-handle.s {
            bottom: -5px;
            left: 50%;
            transform: translateX(-50%);
            cursor: ns-resize;
        }

        .text-box-resize-handle.se {
            bottom: -5px;
            right: -5px;
            cursor: nwse-resize;
        }

        .text-box-resize-handle:hover {
            background: #3b82f6;
        }

        /* æµ®åŠ¨ç¼–è¾‘é¢æ¿ */
        .floating-editor {
            display: none;
            position: fixed;
            top: 20px;
            right: 20px;
            bottom: 20px;
            transform: translateX(0);
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
            z-index: 2000;
            width: 400px;
            max-height: calc(100vh - 40px);
            overflow-y: auto;
            transition: transform 0.3s ease;
        }

        .floating-editor.show {
            display: block;
            animation: slideInRight 0.3s ease;
        }

        @keyframes slideInRight {
            from {
                transform: translateX(100%);
            }
            to {
                transform: translateX(0);
            }
        }

        .floating-editor-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #e5e5e5;
        }

        .floating-editor-header h3 {
            font-size: 18px;
            color: #1a1a1a;
            margin: 0;
        }

        .btn-close-editor {
            background: #ef4444;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
        }

        .btn-close-editor:hover {
            background: #dc2626;
        }

        .floating-editor-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.2);
            z-index: 1999;
            pointer-events: none;
        }

        .floating-editor-overlay.show {
            display: block;
        }

        .version-controls {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            align-items: center;
        }

        .version-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .version-btn {
            padding: 10px 20px;
            border: 2px solid #ddd;
            background: white;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            color: #333;
            transition: all 0.2s;
            position: relative;
        }

        .version-btn:hover {
            border-color: #3b82f6;
            color: #3b82f6;
        }

        .version-btn.active {
            background: #3b82f6;
            color: white;
            border-color: #3b82f6;
        }

        .version-btn .btn-delete-version {
            position: absolute;
            top: -8px;
            right: -8px;
            width: 20px;
            height: 20px;
            background: #ef4444;
            color: white;
            border: none;
            border-radius: 50%;
            cursor: pointer;
            font-size: 12px;
            display: none;
            align-items: center;
            justify-content: center;
        }

        .version-btn:hover .btn-delete-version {
            display: flex;
        }

        .btn-add-version {
            padding: 10px 20px;
            border: 2px dashed #3b82f6;
            background: white;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            color: #3b82f6;
            transition: all 0.2s;
        }

        .btn-add-version:hover {
            background: #eff6ff;
        }

        .comparison-container {
            position: relative;
            width: 100%;
            min-height: 500px;
            padding: 20px;
            box-sizing: border-box;
        }

        .comparison-container.vertical {
            display: flex;
            flex-direction: column;
        }

        .comparison-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
            position: absolute;
            min-width: 200px;
            max-width: 350px;
            transition: all 0.2s;
        }

        .comparison-item.draggable {
            cursor: move;
        }

        .comparison-item.dragging {
            opacity: 0.7;
            z-index: 1000;
        }

        .comparison-item.selected {
            outline: 3px solid #3b82f6;
            outline-offset: 3px;
            border-radius: 8px;
        }

        .comparison-item:hover {
            transform: scale(1.02);
        }

        /* å›¾æ ‡æ ·å¼ */
        .icon-container {
            min-width: 120px;
            min-height: 120px;
            width: auto;
            height: auto;
            max-width: 200px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-wrap: wrap;
            gap: 4px;
            padding: 8px;
            font-weight: normal;
        }

        .icon-container .emoji-item {
            line-height: 1;
            flex-shrink: 0;
        }

        /* æ ¹æ®emojiæ•°é‡è‡ªé€‚åº”å¤§å° */
        .icon-container[data-emoji-count="1"] .emoji-item {
            font-size: 60px;
        }

        .icon-container[data-emoji-count="2"] .emoji-item {
            font-size: 45px;
        }

        .icon-container[data-emoji-count="3"] .emoji-item {
            font-size: 35px;
        }

        .icon-container[data-emoji-count="4"] .emoji-item {
            font-size: 30px;
        }

        .icon-container[data-emoji-count]:not([data-emoji-count="1"]):not([data-emoji-count="2"]):not([data-emoji-count="3"]):not([data-emoji-count="4"]) .emoji-item {
            font-size: 24px;
        }

        .icon-container.circle {
            border-radius: 50%;
        }

        .icon-container.square {
            border-radius: 12px;
        }

        /* æ–‡æœ¬æ¡†æ ·å¼ */
        .text-box-container {
            position: relative;
            width: 100%;
            min-height: 120px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .text-box {
            padding: 20px 30px;
            border-radius: 12px;
            min-width: 200px;
            text-align: center;
            font-size: 24px;
            font-weight: 600;
            line-height: 1.4;
            word-wrap: break-word;
        }

        .text-box.rounded {
            border-radius: 12px;
        }

        .text-box.rectangle {
            border-radius: 4px;
        }

        /* æ¡†å¤–emoji */
        .external-emojis-container {
            position: absolute;
            display: flex;
            gap: 8px;
            z-index: 10;
            flex-wrap: nowrap;
            white-space: nowrap;
        }

        .external-emojis-container.top {
            left: 50%;
            transform: translateX(-50%);
        }

        .external-emojis-container.bottom {
            left: 50%;
            transform: translateX(-50%);
        }

        .external-emojis-container.left {
            top: 50%;
            transform: translateY(-50%);
            flex-direction: column;
        }

        .external-emojis-container.right {
            top: 50%;
            transform: translateY(-50%);
            flex-direction: column;
        }

        .external-emoji-item {
            font-size: 48px;
            line-height: 1;
        }

        .text-content {
            text-align: center;
        }

        .title {
            font-size: 32px;
            font-weight: 700;
            color: #1a1a1a;
            margin-bottom: 4px;
        }

        .subtitle {
            font-size: 20px;
            font-weight: 500;
            color: #666;
        }

        /* å½“åªæœ‰æ ‡é¢˜æˆ–åªæœ‰å‰¯æ ‡é¢˜æ—¶ï¼Œç§»é™¤åº•éƒ¨è¾¹è· */
        .title:last-child {
            margin-bottom: 0;
        }

        .empty-state {
            text-align: center;
            color: #999;
            font-size: 18px;
        }

        .hidden {
            display: none;
        }

        @media (max-width: 1024px) {
            .app-container {
                flex-direction: column;
            }

            .config-panel {
                flex: 1;
                max-height: none;
            }

            .app-header {
                flex-direction: column;
                gap: 10px;
            }

            .header-actions {
                width: 100%;
                flex-wrap: wrap;
            }
        }

        @media (max-width: 768px) {
            .preview-panel {
                padding: 20px;
            }

            .comparison-container {
                flex-direction: column;
                gap: 30px;
            }

            .icon-container {
                width: 100px;
                height: 100px;
                font-size: 50px;
            }

            .text-box {
                font-size: 20px;
                padding: 15px 20px;
            }

            .title {
                font-size: 28px;
            }

            .subtitle {
                font-size: 18px;
            }
        }

        /* è¾“å…¥æ¡†æ¸…é™¤æŒ‰é’®æ ·å¼ */
        .input-wrapper {
            position: relative;
            display: flex;
            align-items: center;
        }

        .input-wrapper input,
        .input-wrapper textarea {
            flex: 1;
            padding-right: 35px !important;
        }

        .btn-clear-input {
            position: absolute;
            right: 8px;
            top: 8px;
            background: #ef4444;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            opacity: 0;
            pointer-events: none;
        }

        .input-wrapper input:not(:placeholder-shown) + .btn-clear-input,
        .input-wrapper textarea:not(:placeholder-shown) + .btn-clear-input {
            opacity: 1;
            pointer-events: auto;
        }

        .btn-clear-input:hover {
            background: #dc2626;
            transform: scale(1.1);
        }

        /* æŠ˜å åŒºåŸŸæ ·å¼ */
        .collapsible-section {
            margin-bottom: 15px;
        }

        .collapsible-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 12px;
            background: #f9fafb;
            border-radius: 6px;
            cursor: pointer;
            user-select: none;
            transition: all 0.2s;
        }

        .collapsible-header:hover {
            background: #f3f4f6;
        }

        .collapsible-header-title {
            font-weight: 500;
            font-size: 14px;
            color: #333;
        }

        .collapsible-toggle {
            font-size: 12px;
            color: #666;
            transition: transform 0.2s;
        }

        .collapsible-section.collapsed .collapsible-toggle {
            transform: rotate(-90deg);
        }

        .collapsible-content {
            max-height: 2000px;
            overflow: hidden;
            transition: max-height 0.3s ease-out, opacity 0.3s;
            opacity: 1;
            padding-top: 12px;
        }

        .collapsible-section.collapsed .collapsible-content {
            max-height: 0;
            opacity: 0;
            padding-top: 0;
        }

        /* å¯¹é½çº¿æ ·å¼ */
        .alignment-guide {
            position: absolute;
            background: #3b82f6;
            z-index: 999;
            pointer-events: none;
        }

        .alignment-guide.vertical {
            width: 1px;
            height: 100%;
            top: 0;
        }

        .alignment-guide.horizontal {
            height: 1px;
            width: 100%;
            left: 0;
        }

        /* å¤åˆ¶æŒ‰é’®æ ·å¼ */
        .btn-duplicate {
            background: #10b981;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            margin-right: 8px;
        }

        .btn-duplicate:hover {
            background: #059669;
        }

        /* å†å²è®°å½•æŒ‰é’®æ ·å¼ */
        .btn-history {
            background: #6b7280;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s;
        }

        .btn-history:hover {
            background: #4b5563;
        }

        .btn-history:disabled {
            background: #d1d5db;
            cursor: not-allowed;
            opacity: 0.5;
        }

        /* è‡ªåŠ¨æ’ç‰ˆæŒ‰é’®æ ·å¼ */
        .btn-auto-layout {
            background: #8b5cf6;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s;
        }

        .btn-auto-layout:hover {
            background: #7c3aed;
        }
    </style>
</head>
<body>
    <div class="app-header">
        <h1>ğŸ¨ æœ‰é™å…ƒç´ ç”»å¸ƒ</h1>
        <div class="header-actions">
            <button class="btn btn-history" id="undoBtn" onclick="undo()" disabled>â†¶ æ’¤é”€</button>
            <button class="btn btn-history" id="redoBtn" onclick="redo()" disabled>â†· é‡åš</button>
            <button class="btn btn-auto-layout" onclick="autoLayout()">âœ¨ ä¸€é”®æ’ç‰ˆ</button>
            <button class="btn btn-success" onclick="saveConfig()">ğŸ’¾ ä¿å­˜é…ç½®</button>
            <button class="btn btn-secondary" onclick="loadConfig()">ğŸ“‚ åŠ è½½é…ç½®</button>
            <button class="btn btn-primary" onclick="exportHTML()">ğŸ“„ å¯¼å‡ºHTML</button>
            <button class="btn btn-secondary" onclick="exportJSON()">ğŸ“‹ å¯¼å‡ºJSON</button>
        </div>
    </div>

    <div class="app-container">
        <!-- å·¦ä¾§ï¼šå…ƒç´ åˆ—è¡¨ -->
        <div class="element-list-panel">
            <h2>å…ƒç´ åˆ—è¡¨</h2>
            <div class="element-list" id="elementList">
                <!-- å…ƒç´ åˆ—è¡¨é¡¹å°†é€šè¿‡JSç”Ÿæˆ -->
            </div>
            <button class="btn-add-item" onclick="addItem()">+ æ·»åŠ å…ƒç´ </button>
        </div>

        <!-- ä¸­é—´ï¼šç”»å¸ƒåŒºåŸŸ -->
        <div class="canvas-panel">
            <div class="config-name-group" style="margin-bottom: 15px;">
                <label>é…ç½®åç§°</label>
                <div class="input-wrapper">
                    <input type="text" id="configName" placeholder="ç•™ç©ºè‡ªåŠ¨ä½¿ç”¨ç¬¬ä¸€ä¸ªæ–‡æœ¬æ¡†å†…å®¹"
                           value="" oninput="updateConfigName()">
                    <button class="btn-clear-input" type="button" onclick="document.getElementById('configName').value = ''; updateConfigName();">Ã—</button>
                </div>
            </div>

            <div class="version-controls" style="margin-bottom: 15px;">
                <div class="version-buttons" id="versionButtons"></div>
            </div>

            <div class="comparison-container" id="previewContainer" style="flex: 1; position: relative; overflow: auto;">
                <div class="empty-state">ç‚¹å‡»å·¦ä¾§"+ æ·»åŠ å…ƒç´ "å¼€å§‹åˆ›å»º</div>
            </div>
        </div>

        <!-- å³ä¾§ï¼šç¼–è¾‘é¢æ¿ -->
        <div class="edit-panel">
            <div id="editPanelContent">
                <div class="edit-panel-empty">
                    <div class="edit-panel-empty-icon">âœï¸</div>
                    <div>é€‰æ‹©ä¸€ä¸ªå…ƒç´ å¼€å§‹ç¼–è¾‘</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Emojié€‰æ‹©å™¨å¼¹çª— -->
    <div class="emoji-picker-modal" id="emojiPickerModal">
        <div class="emoji-picker-content">
            <div class="emoji-picker-header">
                <h3>é€‰æ‹© Emoji</h3>
                <button class="btn-close-picker" onclick="closeEmojiPicker()">å…³é—­</button>
            </div>
            <div class="emoji-categories" id="emojiCategories"></div>
            <div class="emoji-grid" id="emojiGrid"></div>
        </div>
    </div>

    <!-- æµ®åŠ¨ç¼–è¾‘å™¨é®ç½© -->
    <div class="floating-editor-overlay" id="floatingEditorOverlay" onclick="closeFloatingEditor()"></div>

    <!-- æµ®åŠ¨ç¼–è¾‘å™¨ -->
    <div class="floating-editor" id="floatingEditor">
        <div class="floating-editor-header">
            <h3>ç¼–è¾‘å…ƒç´ </h3>
            <button class="btn-close-editor" onclick="closeFloatingEditor()">å…³é—­</button>
        </div>
        <div id="floatingEditorContent"></div>
    </div>

    <!-- éšè—çš„æ–‡ä»¶è¾“å…¥ -->
    <input type="file" id="fileInput" accept=".json" class="hidden" onchange="handleFileImport(event)">

    <script>
        // Emojiåˆ†ç±»æ•°æ®
        const emojiCategories = {
            'è¡¨æƒ…': ['ğŸ˜€', 'ğŸ˜ƒ', 'ğŸ˜„', 'ğŸ˜', 'ğŸ˜†', 'ğŸ˜…', 'ğŸ¤£', 'ğŸ˜‚', 'ğŸ™‚', 'ğŸ™ƒ', 'ğŸ˜‰', 'ğŸ˜Š', 'ğŸ˜‡', 'ğŸ¥°', 'ğŸ˜', 'ğŸ¤©', 'ğŸ˜˜', 'ğŸ˜—', 'ğŸ˜š', 'ğŸ˜™', 'ğŸ˜‹', 'ğŸ˜›', 'ğŸ˜œ', 'ğŸ¤ª', 'ğŸ˜', 'ğŸ¤‘', 'ğŸ¤—', 'ğŸ¤­', 'ğŸ¤«', 'ğŸ¤”', 'ğŸ¤', 'ğŸ¤¨', 'ğŸ˜', 'ğŸ˜‘', 'ğŸ˜¶', 'ğŸ˜', 'ğŸ˜’', 'ğŸ™„', 'ğŸ˜¬', 'ğŸ¤¥', 'ğŸ˜Œ', 'ğŸ˜”', 'ğŸ˜ª', 'ğŸ¤¤', 'ğŸ˜´', 'ğŸ˜·', 'ğŸ¤’', 'ğŸ¤•', 'ğŸ¤¢', 'ğŸ¤®', 'ğŸ¤§', 'ğŸ¥µ', 'ğŸ¥¶', 'ğŸ˜¶â€ğŸŒ«ï¸', 'ğŸ˜µ', 'ğŸ˜µâ€ğŸ’«', 'ğŸ¤¯', 'ğŸ¤ ', 'ğŸ¥³', 'ğŸ˜', 'ğŸ¤“', 'ğŸ§', 'ğŸ˜•', 'ğŸ˜Ÿ', 'ğŸ™', 'â˜¹ï¸', 'ğŸ˜®', 'ğŸ˜¯', 'ğŸ˜²', 'ğŸ˜³', 'ğŸ¥º', 'ğŸ˜¦', 'ğŸ˜§', 'ğŸ˜¨', 'ğŸ˜°', 'ğŸ˜¥', 'ğŸ˜¢', 'ğŸ˜­', 'ğŸ˜±', 'ğŸ˜–', 'ğŸ˜£', 'ğŸ˜', 'ğŸ˜“', 'ğŸ˜©', 'ğŸ˜«', 'ğŸ¥±', 'ğŸ˜¤', 'ğŸ˜¡', 'ğŸ˜ ', 'ğŸ¤¬', 'ğŸ˜ˆ', 'ğŸ‘¿', 'ğŸ’€', 'â˜ ï¸', 'ğŸ’©', 'ğŸ¤¡', 'ğŸ‘¹', 'ğŸ‘º', 'ğŸ‘»', 'ğŸ‘½', 'ğŸ‘¾', 'ğŸ¤–', 'ğŸ˜º', 'ğŸ˜¸', 'ğŸ˜¹', 'ğŸ˜»', 'ğŸ˜¼', 'ğŸ˜½', 'ğŸ™€', 'ğŸ˜¿', 'ğŸ˜¾'],
            'äººç‰©': ['ğŸ‘¶', 'ğŸ‘§', 'ğŸ§’', 'ğŸ‘¦', 'ğŸ‘©', 'ğŸ§‘', 'ğŸ‘¨', 'ğŸ‘©â€ğŸ¦±', 'ğŸ‘¨â€ğŸ¦±', 'ğŸ‘©â€ğŸ¦°', 'ğŸ‘¨â€ğŸ¦°', 'ğŸ‘±â€â™€ï¸', 'ğŸ‘±', 'ğŸ‘±â€â™‚ï¸', 'ğŸ‘©â€ğŸ¦³', 'ğŸ‘¨â€ğŸ¦³', 'ğŸ‘©â€ğŸ¦²', 'ğŸ‘¨â€ğŸ¦²', 'ğŸ§”', 'ğŸ‘µ', 'ğŸ§“', 'ğŸ‘´', 'ğŸ‘²', 'ğŸ‘³â€â™€ï¸', 'ğŸ‘³', 'ğŸ‘³â€â™‚ï¸', 'ğŸ§•', 'ğŸ‘®â€â™€ï¸', 'ğŸ‘®', 'ğŸ‘®â€â™‚ï¸', 'ğŸ‘·â€â™€ï¸', 'ğŸ‘·', 'ğŸ‘·â€â™‚ï¸', 'ğŸ’‚â€â™€ï¸', 'ğŸ’‚', 'ğŸ’‚â€â™‚ï¸', 'ğŸ•µï¸â€â™€ï¸', 'ğŸ•µï¸', 'ğŸ•µï¸â€â™‚ï¸', 'ğŸ‘©â€âš•ï¸', 'ğŸ‘¨â€âš•ï¸', 'ğŸ‘©â€ğŸŒ¾', 'ğŸ‘¨â€ğŸŒ¾', 'ğŸ‘©â€ğŸ³', 'ğŸ‘¨â€ğŸ³', 'ğŸ‘©â€ğŸ“', 'ğŸ‘¨â€ğŸ“', 'ğŸ‘©â€ğŸ¤', 'ğŸ‘¨â€ğŸ¤', 'ğŸ‘©â€ğŸ«', 'ğŸ‘¨â€ğŸ«', 'ğŸ‘©â€ğŸ­', 'ğŸ‘¨â€ğŸ­', 'ğŸ‘©â€ğŸ’»', 'ğŸ‘¨â€ğŸ’»', 'ğŸ‘©â€ğŸ’¼', 'ğŸ‘¨â€ğŸ’¼', 'ğŸ‘©â€ğŸ”§', 'ğŸ‘¨â€ğŸ”§', 'ğŸ‘©â€ğŸ”¬', 'ğŸ‘¨â€ğŸ”¬', 'ğŸ‘©â€ğŸ¨', 'ğŸ‘¨â€ğŸ¨', 'ğŸ‘©â€ğŸš’', 'ğŸ‘¨â€ğŸš’', 'ğŸ‘©â€âœˆï¸', 'ğŸ‘¨â€âœˆï¸', 'ğŸ‘©â€ğŸš€', 'ğŸ‘¨â€ğŸš€', 'ğŸ‘©â€âš–ï¸', 'ğŸ‘¨â€âš–ï¸', 'ğŸ¤¶', 'ğŸ…', 'ğŸ‘¸', 'ğŸ¤´', 'ğŸ‘°', 'ğŸ¤µ', 'ğŸ‘¼', 'ğŸ¤°', 'ğŸ¤±', 'ğŸ‘©â€ğŸ¼', 'ğŸ‘¨â€ğŸ¼', 'ğŸ§™â€â™€ï¸', 'ğŸ§™', 'ğŸ§™â€â™‚ï¸', 'ğŸ§šâ€â™€ï¸', 'ğŸ§š', 'ğŸ§šâ€â™‚ï¸', 'ğŸ§›â€â™€ï¸', 'ğŸ§›', 'ğŸ§›â€â™‚ï¸', 'ğŸ§œâ€â™€ï¸', 'ğŸ§œ', 'ğŸ§œâ€â™‚ï¸', 'ğŸ§â€â™€ï¸', 'ğŸ§', 'ğŸ§â€â™‚ï¸', 'ğŸ§â€â™€ï¸', 'ğŸ§', 'ğŸ§â€â™‚ï¸', 'ğŸ§Ÿâ€â™€ï¸', 'ğŸ§Ÿ', 'ğŸ§Ÿâ€â™‚ï¸'],
            'æ‰‹åŠ¿': ['ğŸ‘‹', 'ğŸ¤š', 'ğŸ–', 'âœ‹', 'ğŸ––', 'ğŸ‘Œ', 'ğŸ¤Œ', 'ğŸ¤', 'âœŒï¸', 'ğŸ¤', 'ğŸ¤Ÿ', 'ğŸ¤˜', 'ğŸ¤™', 'ğŸ‘ˆ', 'ğŸ‘‰', 'ğŸ‘†', 'ğŸ–•', 'ğŸ‘‡', 'â˜ï¸', 'ğŸ‘', 'ğŸ‘', 'âœŠ', 'ğŸ‘Š', 'ğŸ¤›', 'ğŸ¤œ', 'ğŸ‘', 'ğŸ™Œ', 'ğŸ‘', 'ğŸ¤²', 'ğŸ¤', 'ğŸ™', 'âœï¸', 'ğŸ’ª', 'ğŸ¦¾', 'ğŸ¦¿', 'ğŸ¦µ', 'ğŸ¦¶', 'ğŸ‘‚', 'ğŸ¦»', 'ğŸ‘ƒ', 'ğŸ‘¶', 'ğŸ§ ', 'ğŸ«€', 'ğŸ«', 'ğŸ¦·', 'ğŸ¦´', 'ğŸ‘€', 'ğŸ‘ï¸', 'ğŸ‘…', 'ğŸ‘„', 'ğŸ’‹', 'ğŸ©¸'],
            'åŠ¨ç‰©': ['ğŸ¶', 'ğŸ±', 'ğŸ­', 'ğŸ¹', 'ğŸ°', 'ğŸ¦Š', 'ğŸ»', 'ğŸ¼', 'ğŸ¨', 'ğŸ¯', 'ğŸ¦', 'ğŸ®', 'ğŸ·', 'ğŸ½', 'ğŸ¸', 'ğŸµ', 'ğŸ™ˆ', 'ğŸ™‰', 'ğŸ™Š', 'ğŸ’', 'ğŸ”', 'ğŸ§', 'ğŸ¦', 'ğŸ¤', 'ğŸ£', 'ğŸ¥', 'ğŸ¦†', 'ğŸ¦…', 'ğŸ¦‰', 'ğŸ¦‡', 'ğŸº', 'ğŸ—', 'ğŸ´', 'ğŸ¦„', 'ğŸ', 'ğŸ›', 'ğŸ¦‹', 'ğŸŒ', 'ğŸ', 'ğŸœ', 'ğŸ¦Ÿ', 'ğŸ¦—', 'ğŸ•·ï¸', 'ğŸ•¸ï¸', 'ğŸ¦‚', 'ğŸ¢', 'ğŸ', 'ğŸ¦', 'ğŸ¦–', 'ğŸ¦•', 'ğŸ™', 'ğŸ¦‘', 'ğŸ¦', 'ğŸ¦', 'ğŸ¦€', 'ğŸ¡', 'ğŸ ', 'ğŸŸ', 'ğŸ¬', 'ğŸ³', 'ğŸ‹', 'ğŸ¦ˆ', 'ğŸŠ', 'ğŸ…', 'ğŸ†', 'ğŸ¦“', 'ğŸ¦', 'ğŸ¦§', 'ğŸ˜', 'ğŸ¦›', 'ğŸ¦', 'ğŸª', 'ğŸ«', 'ğŸ¦’', 'ğŸ¦˜', 'ğŸƒ', 'ğŸ‚', 'ğŸ„', 'ğŸ', 'ğŸ–', 'ğŸ', 'ğŸ‘', 'ğŸ¦™', 'ğŸ', 'ğŸ¦Œ', 'ğŸ•', 'ğŸ©', 'ğŸ¦®', 'ğŸ•â€ğŸ¦º', 'ğŸˆ', 'ğŸˆâ€â¬›', 'ğŸ“', 'ğŸ¦ƒ', 'ğŸ¦š', 'ğŸ¦œ', 'ğŸ¦¢', 'ğŸ¦©', 'ğŸ•Šï¸', 'ğŸ‡', 'ğŸ¦', 'ğŸ¦¨', 'ğŸ¦¡', 'ğŸ¦«', 'ğŸ¦¦', 'ğŸ¦¥', 'ğŸ', 'ğŸ€', 'ğŸ¿ï¸', 'ğŸ¦”'],
            'é£Ÿç‰©': ['ğŸ', 'ğŸ', 'ğŸŠ', 'ğŸ‹', 'ğŸŒ', 'ğŸ‰', 'ğŸ‡', 'ğŸ“', 'ğŸ«', 'ğŸˆ', 'ğŸ’', 'ğŸ‘', 'ğŸ¥­', 'ğŸ', 'ğŸ¥¥', 'ğŸ¥', 'ğŸ…', 'ğŸ†', 'ğŸ¥‘', 'ğŸ¥¦', 'ğŸ¥¬', 'ğŸ¥’', 'ğŸŒ¶ï¸', 'ğŸ«‘', 'ğŸŒ½', 'ğŸ¥•', 'ğŸ«’', 'ğŸ§„', 'ğŸ§…', 'ğŸ¥”', 'ğŸ ', 'ğŸ¥', 'ğŸ¥¯', 'ğŸ', 'ğŸ¥–', 'ğŸ¥¨', 'ğŸ§€', 'ğŸ¥š', 'ğŸ³', 'ğŸ§ˆ', 'ğŸ¥', 'ğŸ§‡', 'ğŸ¥“', 'ğŸ¥©', 'ğŸ—', 'ğŸ–', 'ğŸ¦´', 'ğŸŒ­', 'ğŸ”', 'ğŸŸ', 'ğŸ•', 'ğŸ«“', 'ğŸ¥ª', 'ğŸ¥™', 'ğŸ§†', 'ğŸŒ®', 'ğŸŒ¯', 'ğŸ«”', 'ğŸ¥—', 'ğŸ¥˜', 'ğŸ«•', 'ğŸ¥«', 'ğŸ', 'ğŸœ', 'ğŸ²', 'ğŸ›', 'ğŸ£', 'ğŸ±', 'ğŸ¥Ÿ', 'ğŸ¦ª', 'ğŸ¤', 'ğŸ™', 'ğŸš', 'ğŸ˜', 'ğŸ¥', 'ğŸ¥ ', 'ğŸ¥®', 'ğŸ¢', 'ğŸ¡', 'ğŸ§', 'ğŸ¨', 'ğŸ¦', 'ğŸ¥§', 'ğŸ§', 'ğŸ°', 'ğŸ‚', 'ğŸ®', 'ğŸ­', 'ğŸ¬', 'ğŸ«', 'ğŸ¿', 'ğŸ©', 'ğŸª', 'ğŸŒ°', 'ğŸ¥œ', 'ğŸ¯'],
            'é¥®æ–™': ['ğŸ¼', 'ğŸ¥›', 'â˜•', 'ğŸ«–', 'ğŸµ', 'ğŸ¶', 'ğŸ¾', 'ğŸ·', 'ğŸ¸', 'ğŸ¹', 'ğŸº', 'ğŸ»', 'ğŸ¥‚', 'ğŸ¥ƒ', 'ğŸ¥¤', 'ğŸ§‹', 'ğŸ§ƒ', 'ğŸ§‰', 'ğŸ§Š'],
            'è¿åŠ¨': ['âš½', 'ğŸ€', 'ğŸˆ', 'âš¾', 'ğŸ¥', 'ğŸ¾', 'ğŸ', 'ğŸ‰', 'ğŸ¥', 'ğŸ±', 'ğŸª€', 'ğŸ“', 'ğŸ¸', 'ğŸ’', 'ğŸ‘', 'ğŸ¥', 'ğŸ', 'ğŸªƒ', 'ğŸ¥…', 'â›³', 'ğŸª', 'ğŸ¹', 'ğŸ£', 'ğŸ¤¿', 'ğŸ¥Š', 'ğŸ¥‹', 'ğŸ½', 'ğŸ›¹', 'ğŸ›¼', 'ğŸ›·', 'â›¸ï¸', 'ğŸ¥Œ', 'ğŸ¿', 'â›·ï¸', 'ğŸ‚', 'ğŸª‚', 'ğŸ‹ï¸â€â™€ï¸', 'ğŸ‹ï¸', 'ğŸ‹ï¸â€â™‚ï¸', 'ğŸ¤¼â€â™€ï¸', 'ğŸ¤¼', 'ğŸ¤¼â€â™‚ï¸', 'ğŸ¤¸â€â™€ï¸', 'ğŸ¤¸', 'ğŸ¤¸â€â™‚ï¸', 'â›¹ï¸â€â™€ï¸', 'â›¹ï¸', 'â›¹ï¸â€â™‚ï¸', 'ğŸ¤º', 'ğŸ¤¾â€â™€ï¸', 'ğŸ¤¾', 'ğŸ¤¾â€â™‚ï¸', 'ğŸŒï¸â€â™€ï¸', 'ğŸŒï¸', 'ğŸŒï¸â€â™‚ï¸', 'ğŸ‡', 'ğŸ§˜â€â™€ï¸', 'ğŸ§˜', 'ğŸ§˜â€â™‚ï¸', 'ğŸ„â€â™€ï¸', 'ğŸ„', 'ğŸ„â€â™‚ï¸', 'ğŸŠâ€â™€ï¸', 'ğŸŠ', 'ğŸŠâ€â™‚ï¸', 'ğŸ¤½â€â™€ï¸', 'ğŸ¤½', 'ğŸ¤½â€â™‚ï¸', 'ğŸš£â€â™€ï¸', 'ğŸš£', 'ğŸš£â€â™‚ï¸', 'ğŸ§—â€â™€ï¸', 'ğŸ§—', 'ğŸ§—â€â™‚ï¸', 'ğŸšµâ€â™€ï¸', 'ğŸšµ', 'ğŸšµâ€â™‚ï¸', 'ğŸš´â€â™€ï¸', 'ğŸš´', 'ğŸš´â€â™‚ï¸', 'ğŸ†', 'ğŸ¥‡', 'ğŸ¥ˆ', 'ğŸ¥‰', 'ğŸ…', 'ğŸ–ï¸', 'ğŸµï¸', 'ğŸ—ï¸'],
            'äº¤é€š': ['ğŸš—', 'ğŸš•', 'ğŸš™', 'ğŸšŒ', 'ğŸš', 'ğŸï¸', 'ğŸš“', 'ğŸš‘', 'ğŸš’', 'ğŸš', 'ğŸ›»', 'ğŸšš', 'ğŸš›', 'ğŸšœ', 'ğŸ¦¯', 'ğŸ¦½', 'ğŸ¦¼', 'ğŸ©¼', 'ğŸ›´', 'ğŸš²', 'ğŸ›µ', 'ğŸï¸', 'ğŸ›º', 'ğŸš¨', 'ğŸš”', 'ğŸš', 'ğŸš˜', 'ğŸš–', 'ğŸš¡', 'ğŸš ', 'ğŸšŸ', 'ğŸšƒ', 'ğŸš‹', 'ğŸš', 'ğŸš', 'ğŸš„', 'ğŸš…', 'ğŸšˆ', 'ğŸš‚', 'ğŸš†', 'ğŸš‡', 'ğŸšŠ', 'ğŸš‰', 'âœˆï¸', 'ğŸ›«', 'ğŸ›¬', 'ğŸ›©ï¸', 'ğŸ’º', 'ğŸ›°ï¸', 'ğŸš€', 'ğŸ›¸', 'ğŸš', 'ğŸ›¶', 'â›µ', 'ğŸš¤', 'ğŸ›¥ï¸', 'ğŸ›³ï¸', 'â›´ï¸', 'ğŸš¢', 'âš“', 'â›½', 'ğŸš§', 'ğŸš¦', 'ğŸš¥', 'ğŸš', 'ğŸ—ºï¸', 'ğŸ—¿', 'ğŸ—½', 'ğŸ—¼', 'ğŸ°', 'ğŸ¯', 'ğŸŸï¸', 'ğŸ¡', 'ğŸ¢', 'ğŸ ', 'â›²', 'â›±ï¸', 'ğŸ–ï¸', 'ğŸï¸', 'ğŸœï¸', 'ğŸŒ‹', 'â›°ï¸', 'ğŸ”ï¸', 'ğŸ—»', 'ğŸ•ï¸', 'â›º', 'ğŸ ', 'ğŸ¡', 'ğŸ˜ï¸', 'ğŸšï¸', 'ğŸ—ï¸', 'ğŸ­', 'ğŸ¢', 'ğŸ¬', 'ğŸ£', 'ğŸ¤', 'ğŸ¥', 'ğŸ¦', 'ğŸ¨', 'ğŸª', 'ğŸ«', 'ğŸ©', 'ğŸ’’', 'ğŸ›ï¸', 'â›ª', 'ğŸ•Œ', 'ğŸ•', 'ğŸ›•', 'ğŸ•‹'],
            'ç‰©ä½“': ['âŒš', 'ğŸ“±', 'ğŸ“²', 'ğŸ’»', 'âŒ¨ï¸', 'ğŸ–¥ï¸', 'ğŸ–¨ï¸', 'ğŸ–±ï¸', 'ğŸ–²ï¸', 'ğŸ•¹ï¸', 'ğŸ—œï¸', 'ğŸ’¾', 'ğŸ’¿', 'ğŸ“€', 'ğŸ“¼', 'ğŸ“·', 'ğŸ“¸', 'ğŸ“¹', 'ğŸ¥', 'ğŸ“½ï¸', 'ğŸï¸', 'ğŸ“', 'â˜ï¸', 'ğŸ“Ÿ', 'ğŸ“ ', 'ğŸ“º', 'ğŸ“»', 'ğŸ™ï¸', 'ğŸšï¸', 'ğŸ›ï¸', 'ğŸ§­', 'â±ï¸', 'â²ï¸', 'â°', 'ğŸ•°ï¸', 'âŒ›', 'â³', 'ğŸ“¡', 'ğŸ”‹', 'ğŸ”Œ', 'ğŸ’¡', 'ğŸ”¦', 'ğŸ•¯ï¸', 'ğŸª”', 'ğŸ§¯', 'ğŸ›¢ï¸', 'ğŸ’¸', 'ğŸ’µ', 'ğŸ’´', 'ğŸ’¶', 'ğŸ’·', 'ğŸª™', 'ğŸ’°', 'ğŸ’³', 'ğŸ’', 'âš–ï¸', 'ğŸªœ', 'ğŸ§°', 'ğŸª›', 'ğŸ”§', 'ğŸ”¨', 'âš’ï¸', 'ğŸ› ï¸', 'â›ï¸', 'ğŸªš', 'ğŸ”©', 'âš™ï¸', 'ğŸª¤', 'ğŸ§±', 'â›“ï¸', 'ğŸ§²', 'ğŸ”«', 'ğŸ’£', 'ğŸ§¨', 'ğŸª“', 'ğŸ”ª', 'ğŸ—¡ï¸', 'âš”ï¸', 'ğŸ›¡ï¸', 'ğŸš¬', 'âš°ï¸', 'ğŸª¦', 'âš±ï¸', 'ğŸº', 'ğŸ”®', 'ğŸ“¿', 'ğŸ§¿', 'ğŸ’ˆ', 'âš—ï¸', 'ğŸ”­', 'ğŸ”¬', 'ğŸ•³ï¸', 'ğŸ©¹', 'ğŸ©º', 'ğŸ’Š', 'ğŸ’‰', 'ğŸ©¸', 'ğŸ§¬', 'ğŸ¦ ', 'ğŸ§«', 'ğŸ§ª', 'ğŸŒ¡ï¸', 'ğŸ§¹', 'ğŸª ', 'ğŸ§º', 'ğŸ§»', 'ğŸš½', 'ğŸš°', 'ğŸš¿', 'ğŸ›', 'ğŸ›€', 'ğŸ§¼', 'ğŸª’', 'ğŸ§½', 'ğŸª£', 'ğŸ§´', 'ğŸ›ï¸', 'ğŸ”‘', 'ğŸ—ï¸', 'ğŸšª', 'ğŸª‘', 'ğŸ›‹ï¸', 'ğŸ›ï¸', 'ğŸ›Œ', 'ğŸ§¸', 'ğŸ–¼ï¸', 'ğŸª†', 'ğŸª¡', 'ğŸ§µ', 'ğŸª¢', 'ğŸ§¶', 'ğŸ›ï¸', 'ğŸ‘‘', 'ğŸ‘’', 'ğŸ©', 'ğŸ“', 'ğŸ§¢', 'ğŸª–', 'â›‘ï¸', 'ğŸ“¿', 'ğŸ’„', 'ğŸ’', 'ğŸ’¼'],
            'ç¬¦å·': ['â¤ï¸', 'ğŸ§¡', 'ğŸ’›', 'ğŸ’š', 'ğŸ’™', 'ğŸ’œ', 'ğŸ–¤', 'ğŸ¤', 'ğŸ¤', 'ğŸ’”', 'â£ï¸', 'ğŸ’•', 'ğŸ’', 'ğŸ’“', 'ğŸ’—', 'ğŸ’–', 'ğŸ’˜', 'ğŸ’', 'ğŸ’Ÿ', 'â˜®ï¸', 'âœï¸', 'â˜ªï¸', 'ğŸ•‰ï¸', 'â˜¸ï¸', 'âœ¡ï¸', 'ğŸ”¯', 'ğŸ•', 'â˜¯ï¸', 'â˜¦ï¸', 'ğŸ›', 'â›', 'â™ˆ', 'â™‰', 'â™Š', 'â™‹', 'â™Œ', 'â™', 'â™', 'â™', 'â™', 'â™‘', 'â™’', 'â™“', 'ğŸ†”', 'âš›ï¸', 'ğŸ‰‘', 'â˜¢ï¸', 'â˜£ï¸', 'ğŸ“´', 'ğŸ“³', 'ğŸˆ¶', 'ğŸˆš', 'ğŸˆ¸', 'ğŸˆº', 'ğŸˆ·ï¸', 'âœ´ï¸', 'ğŸ†š', 'ğŸ’®', 'ğŸ‰', 'ãŠ™ï¸', 'ãŠ—ï¸', 'ğŸˆ´', 'ğŸˆµ', 'ğŸˆ¹', 'ğŸˆ²', 'ğŸ…°ï¸', 'ğŸ…±ï¸', 'ğŸ†', 'ğŸ†‘', 'ğŸ…¾ï¸', 'ğŸ†˜', 'âŒ', 'â­•', 'ğŸ›‘', 'â›”', 'ğŸ“›', 'ğŸš«', 'ğŸ’¯', 'ğŸ’¢', 'â™¨ï¸', 'ğŸš·', 'ğŸš¯', 'ğŸš³', 'ğŸš±', 'ğŸ”', 'ğŸ“µ', 'ğŸš­', 'â—', 'â•', 'â“', 'â”', 'â€¼ï¸', 'â‰ï¸', 'ğŸ”…', 'ğŸ”†', 'ã€½ï¸', 'âš ï¸', 'ğŸš¸', 'ğŸ”±', 'âšœï¸', 'ğŸ”°', 'â™»ï¸', 'âœ…', 'ğŸˆ¯', 'ğŸ’¹', 'â‡ï¸', 'âœ³ï¸', 'â', 'ğŸŒ', 'ğŸ’ ', 'â“‚ï¸', 'ğŸŒ€', 'ğŸ’¤', 'ğŸ§', 'ğŸš¾', 'â™¿', 'ğŸ…¿ï¸', 'ğŸˆ³', 'ğŸˆ‚ï¸', 'ğŸ›‚', 'ğŸ›ƒ', 'ğŸ›„', 'ğŸ›…', 'ğŸš¹', 'ğŸšº', 'ğŸš¼', 'âš§ï¸', 'ğŸš»', 'ğŸš®', 'ğŸ¦', 'ğŸ“¶', 'ğŸˆ', 'ğŸ”£', 'â„¹ï¸', 'ğŸ”¤', 'ğŸ”¡', 'ğŸ” ', 'ğŸ†–', 'ğŸ†—', 'ğŸ†™', 'ğŸ†’', 'ğŸ†•', 'ğŸ†“', '0ï¸âƒ£', '1ï¸âƒ£', '2ï¸âƒ£', '3ï¸âƒ£', '4ï¸âƒ£', '5ï¸âƒ£', '6ï¸âƒ£', '7ï¸âƒ£', '8ï¸âƒ£', '9ï¸âƒ£', 'ğŸ”Ÿ', 'ğŸ”¢', '#ï¸âƒ£', '*ï¸âƒ£', 'âï¸', 'â–¶ï¸', 'â¸ï¸', 'â¯ï¸', 'â¹ï¸', 'âºï¸', 'â­ï¸', 'â®ï¸', 'â©', 'âª', 'â«', 'â¬', 'â—€ï¸', 'ğŸ”¼', 'ğŸ”½', 'â¡ï¸', 'â¬…ï¸', 'â¬†ï¸', 'â¬‡ï¸', 'â†—ï¸', 'â†˜ï¸', 'â†™ï¸', 'â†–ï¸', 'â†•ï¸', 'â†”ï¸', 'â†ªï¸', 'â†©ï¸', 'â¤´ï¸', 'â¤µï¸', 'ğŸ”€', 'ğŸ”', 'ğŸ”‚', 'ğŸ”„', 'ğŸ”ƒ', 'ğŸµ', 'ğŸ¶', 'â•', 'â–', 'â—', 'âœ–ï¸', 'â™¾ï¸', 'ğŸ’²', 'ğŸ’±', 'â„¢ï¸', 'Â©ï¸', 'Â®ï¸', 'ã€°ï¸', 'â°', 'â¿', 'ğŸ”š', 'ğŸ”™', 'ğŸ”›', 'ğŸ”', 'ğŸ”œ', 'âœ”ï¸', 'â˜‘ï¸', 'ğŸ”˜', 'ğŸ”´', 'ğŸŸ ', 'ğŸŸ¡', 'ğŸŸ¢', 'ğŸ”µ', 'ğŸŸ£', 'âš«', 'âšª', 'ğŸŸ¤', 'ğŸ”º', 'ğŸ”»', 'ğŸ”¸', 'ğŸ”¹', 'ğŸ”¶', 'ğŸ”·', 'ğŸ”³', 'ğŸ”²', 'â–ªï¸', 'â–«ï¸', 'â—¾', 'â—½', 'â—¼ï¸', 'â—»ï¸', 'ğŸŸ¥', 'ğŸŸ§', 'ğŸŸ¨', 'ğŸŸ©', 'ğŸŸ¦', 'ğŸŸª', 'â¬›', 'â¬œ', 'ğŸŸ«', 'ğŸ”ˆ', 'ğŸ”‡', 'ğŸ”‰', 'ğŸ”Š', 'ğŸ””', 'ğŸ”•', 'ğŸ“£', 'ğŸ“¢', 'ğŸ’¬', 'ğŸ’­', 'ğŸ—¯ï¸', 'â™ ï¸', 'â™£ï¸', 'â™¥ï¸', 'â™¦ï¸', 'ğŸƒ', 'ğŸ´', 'ğŸ€„'],
            'æ€è€ƒ': ['ğŸ§ ', 'ğŸ’­', 'ğŸ’¡', 'ğŸ”', 'ğŸ”', 'ğŸ“', 'âœï¸', 'âœ’ï¸', 'ğŸ–Šï¸', 'ğŸ–‹ï¸', 'ğŸ–Œï¸', 'ğŸ–ï¸', 'ğŸ“„', 'ğŸ“ƒ', 'ğŸ“‘', 'ğŸ“Š', 'ğŸ“ˆ', 'ğŸ“‰', 'ğŸ—“ï¸', 'ğŸ“†', 'ğŸ“…', 'ğŸ“‹', 'ğŸ“Œ', 'ğŸ“', 'ğŸ“', 'ğŸ–‡ï¸', 'ğŸ“', 'ğŸ“', 'âœ‚ï¸', 'ğŸ—ƒï¸', 'ğŸ—„ï¸', 'ğŸ—‚ï¸', 'ğŸ“‚', 'ğŸ“', 'ğŸ“°', 'ğŸ—ï¸', 'ğŸ““', 'ğŸ“”', 'ğŸ“’', 'ğŸ“•', 'ğŸ“—', 'ğŸ“˜', 'ğŸ“™', 'ğŸ“š', 'ğŸ“–', 'ğŸ”–', 'ğŸ§·', 'ğŸ”—', 'ğŸ“§', 'ğŸ“¨', 'ğŸ“©', 'ğŸ“¤', 'ğŸ“¥', 'ğŸ“¦', 'ğŸ“«', 'ğŸ“ª', 'ğŸ“¬', 'ğŸ“­', 'ğŸ“®', 'ğŸ—³ï¸'],
            'è‡ªç„¶': ['â­', 'ğŸŒŸ', 'ğŸ’«', 'âœ¨', 'âš¡', 'â˜„ï¸', 'ğŸ’¥', 'ğŸ”¥', 'ğŸŒˆ', 'â˜€ï¸', 'ğŸŒ¤ï¸', 'â›…', 'ğŸŒ¥ï¸', 'â˜ï¸', 'ğŸŒ¦ï¸', 'ğŸŒ§ï¸', 'â›ˆï¸', 'ğŸŒ©ï¸', 'ğŸŒ¨ï¸', 'â„ï¸', 'â˜ƒï¸', 'â›„', 'ğŸŒ¬ï¸', 'ğŸ’¨', 'ğŸ’§', 'ğŸ’¦', 'â˜”', 'â˜‚ï¸', 'ğŸŒŠ', 'ğŸŒ«ï¸', 'ğŸŒªï¸', 'ğŸŒ€', 'ğŸŒˆ', 'ğŸŒ‚', 'â›±ï¸', 'âš¡', 'â„ï¸', 'â˜ƒï¸', 'â›„', 'â˜„ï¸', 'ğŸ”¥', 'ğŸ’§', 'ğŸŒŠ', 'ğŸ„', 'ğŸ‹', 'ğŸ', 'ğŸŒ»', 'ğŸŒº', 'ğŸŒ¸', 'ğŸŒ·', 'ğŸŒ¹', 'ğŸ¥€', 'ğŸµï¸', 'ğŸ’', 'ğŸŒ¼', 'ğŸŒ±', 'ğŸŒ²', 'ğŸŒ³', 'ğŸŒ´', 'ğŸŒµ', 'ğŸŒ¾', 'ğŸŒ¿', 'â˜˜ï¸', 'ğŸ€', 'ğŸ', 'ğŸ‚', 'ğŸƒ', 'ğŸŒ‘', 'ğŸŒ’', 'ğŸŒ“', 'ğŸŒ”', 'ğŸŒ•', 'ğŸŒ–', 'ğŸŒ—', 'ğŸŒ˜', 'ğŸŒ™', 'ğŸŒš', 'ğŸŒ›', 'ğŸŒœ', 'ğŸŒ¡ï¸', 'â˜€ï¸', 'ğŸŒ', 'ğŸŒ', 'ğŸª', 'â­', 'ğŸŒŸ', 'ğŸŒ ', 'ğŸŒŒ', 'â˜ï¸', 'â›…', 'â›ˆï¸', 'ğŸŒ¤ï¸', 'ğŸŒ¥ï¸', 'ğŸŒ¦ï¸', 'ğŸŒ§ï¸', 'ğŸŒ¨ï¸', 'ğŸŒ©ï¸', 'ğŸŒªï¸', 'ğŸŒ«ï¸', 'ğŸŒ¬ï¸', 'ğŸŒ€', 'ğŸŒˆ', 'ğŸŒ‚', 'â˜‚ï¸', 'â˜”', 'â›±ï¸', 'âš¡', 'â„ï¸', 'â˜ƒï¸', 'â›„', 'â˜„ï¸', 'ğŸ”¥', 'ğŸ’§', 'ğŸŒŠ', 'ğŸƒ', 'ğŸ„', 'ğŸ†', 'ğŸ‡', 'ğŸ§¨', 'âœ¨', 'ğŸˆ', 'ğŸ‰', 'ğŸŠ', 'ğŸ‹', 'ğŸ', 'ğŸ', 'ğŸ', 'ğŸ', 'ğŸ‘', 'ğŸ§§', 'ğŸ€', 'ğŸ', 'ğŸ—ï¸', 'ğŸŸï¸', 'ğŸ«']
        };

        // é¢„è®¾é¢œè‰²æ–¹æ¡ˆ
        const colorPresets = [
            { name: 'ç»å…¸è“', bg: '#3B82F6', text: 'white' },
            { name: 'ä¼˜é›…ç´«', bg: '#8B5CF6', text: 'white' },
            { name: 'æ´»åŠ›ç»¿', bg: '#10B981', text: 'white' },
            { name: 'æ¸©æš–æ©™', bg: '#F59E0B', text: 'white' },
            { name: 'çƒ­æƒ…çº¢', bg: '#EF4444', text: 'white' },
            { name: 'æ·±é‚ƒè“', bg: '#1E40AF', text: 'white' },
            { name: 'è–„è·ç»¿', bg: '#34D399', text: 'white' },
            { name: 'æ¨±èŠ±ç²‰', bg: '#F472B6', text: 'white' },
            { name: 'çŸ³æ¿ç°', bg: '#64748B', text: 'white' },
            { name: 'ç¥ç€é»„', bg: '#FBBF24', text: 'black' }
        ];

        // é¢„è®¾é«˜äº®é¢œè‰²
        const highlightPresets = [
            { name: 'ç»å…¸é»„', color: '#FFFF00' },
            { name: 'è§å…‰ç»¿', color: '#7FFF00' },
            { name: 'å¤©è“', color: '#87CEEB' },
            { name: 'æµ…ç²‰', color: '#FFB6C1' },
            { name: 'è–°è¡£è‰', color: '#E6E6FA' },
            { name: 'æµ…æ©™', color: '#FFD700' }
        ];

        // å­˜å‚¨æ‰€æœ‰å¯¹æ¯”é¡¹é…ç½®
        let items = [];

        // å½“å‰æ˜¾ç¤ºçš„ç‰ˆæœ¬ç´¢å¼•
        let currentVersion = 0;

        // æ‰€æœ‰ç”Ÿæˆçš„ç‰ˆæœ¬ï¼ˆæ”¯æŒæ‰‹åŠ¨ç®¡ç†ï¼‰
        let allVersions = [];
        let manualVersions = false; // æ˜¯å¦æ‰‹åŠ¨ç®¡ç†æ¨¡å¼

        // é…ç½®åç§°
        let configName = '';

        // æ‹–æ‹½ç›¸å…³
        let draggedPreviewItem = null;
        let dragOffset = { x: 0, y: 0 };

        // æ‹–æ‹½ç›¸å…³å˜é‡
        let draggedElement = null;
        let draggedIndex = null;

        // Emojié€‰æ‹©å™¨ç›¸å…³å˜é‡
        let currentEmojiPicker = {
            itemId: null,
            emojiIndex: null,
            field: null
        };

        // å†å²è®°å½•ç®¡ç†
        let history = [];
        let historyIndex = -1;
        let isRestoringHistory = false;

        // å¯¹é½çº¿ç›¸å…³
        let alignmentThreshold = 5; // å¯¹é½é˜ˆå€¼ï¼ˆåƒç´ ï¼‰
        let enableAlignmentSnap = false; // æ˜¯å¦å¯ç”¨è‡ªåŠ¨å¸é™„ï¼ˆé»˜è®¤å…³é—­ï¼Œåªæ˜¾ç¤ºå¯¹é½çº¿ï¼‰

        // é€‰ä¸­çš„å…ƒç´ ID
        let selectedItemId = null;

        // é€‰ä¸­çš„è£…é¥°emoji
        let selectedDecorativeEmoji = null; // { itemId, decoIndex }

        // è°ƒæ•´å¤§å°ç›¸å…³
        let resizingEmoji = null; // { itemId, decoIndex, initialSize, initialX, initialY }
        let resizingTextBox = null; // { itemId, initialWidth, initialHeight }

        // åˆå§‹åŒ–
        function init() {
            // å°è¯•ä»LocalStorageåŠ è½½
            const savedConfig = localStorage.getItem('comparisonConfig');
            if (savedConfig) {
                try {
                    const config = JSON.parse(savedConfig);
                    loadConfigData(config);
                } catch (e) {
                    console.error('åŠ è½½é…ç½®å¤±è´¥:', e);
                    loadDefaultConfig();
                }
            } else {
                loadDefaultConfig();
            }
            initEmojiPicker();

            // ä¿å­˜åˆå§‹å†å²è®°å½•
            saveHistory();
        }

        // åŠ è½½é»˜è®¤é…ç½®
        function loadDefaultConfig() {
            items = [];
            addItem();
            addItem();
            
            // è®¾ç½®é»˜è®¤ç¤ºä¾‹æ•°æ®
            if (items.length >= 2) {
                // å·¦è¾¹ï¼šmust
                items[0].title = "must";
                items[0].subtitle = "ä¸»è§‚ - æˆ‘è§‰å¾—";
                items[0].color = "#3B82F6";
                items[0].shape = "circle";
                items[0].displayStyle = "icon";
                items[0].emojis = ["ğŸ¤”", "ğŸ§ ", "ğŸ‘§"];
                items[0].boxContent = "";
                items[0].boxStyle = "rounded";
                items[0].externalEmojis = [];
                items[0].externalEmojiPosition = "top";
                items[0].externalEmojiDistance = 65;

                // å³è¾¹ï¼šhave to
                items[1].title = "have to";
                items[1].subtitle = "å®¢è§‚ - è§„å®š";
                items[1].color = "#F97316";
                items[1].shape = "square";
                items[1].displayStyle = "icon";
                items[1].emojis = ["ğŸ“", "â—", "âš–ï¸"];
                items[1].boxContent = "";
                items[1].boxStyle = "rounded";
                items[1].externalEmojis = [];
                items[1].externalEmojiPosition = "top";
                items[1].externalEmojiDistance = 65;
            }
            
            configName = 'Must vs Have to';
            document.getElementById('configName').value = configName;
            renderElementList();
            renderEditPanel(null);  // ä¸è‡ªåŠ¨é€‰ä¸­ä»»ä½•å…ƒç´ 
            generateAllVersions();
        }

        // åŠ è½½é…ç½®æ•°æ®
        function loadConfigData(config) {
            configName = config.name || 'æœªå‘½åé…ç½®';
            items = config.items || [];

            // åŠ è½½ç‰ˆæœ¬ä¿¡æ¯
            if (config.versions && config.versions.length > 0) {
                allVersions = config.versions;
                manualVersions = config.manualVersions || false;
                currentVersion = 0;
            } else {
                manualVersions = false;
            }

            document.getElementById('configName').value = configName;

            renderElementList();
            renderEditPanel(null);  // ä¸è‡ªåŠ¨é€‰ä¸­ä»»ä½•å…ƒç´ 
            if (!manualVersions || allVersions.length === 0) {
                generateAllVersions();
            } else {
                updatePreview();
            }
        }

        // æ›´æ–°é…ç½®åç§°
        function updateConfigName() {
            const inputValue = document.getElementById('configName').value;
            if (inputValue) {
                configName = inputValue;
            } else {
                // å¦‚æœé…ç½®åç§°ä¸ºç©ºï¼Œä½¿ç”¨ç¬¬ä¸€ä¸ªæ–‡æœ¬æ¡†çš„å†…å®¹
                const firstTextBox = items.find(item => item.displayStyle === 'textbox' && item.boxContent);
                if (firstTextBox && firstTextBox.boxContent) {
                    // å»é™¤Markdownæ ‡è®°ï¼Œåªä¿ç•™çº¯æ–‡æœ¬
                    const plainText = firstTextBox.boxContent
                        .replace(/\*\*([^*]+)\*\*/g, '$1')
                        .replace(/\*([^*]+)\*/g, '$1')
                        .replace(/~~([^~]+)~~/g, '$1')
                        .replace(/==([^=]+)==/g, '$1')
                        .replace(/\[stroke\](.*?)\[\/stroke\]/g, '$1')
                        .replace(/\[color:[^\]]+\](.*?)\[\/color\]/g, '$1')
                        .replace(/\[highlight:[^\]]+\](.*?)\[\/highlight\]/g, '$1')
                        .replace(/\[style:[^\]]+\](.*?)\[\/style\]/g, '$1')
                        .trim();
                    configName = plainText.substring(0, 30) || 'æœªå‘½åé…ç½®'; // é™åˆ¶é•¿åº¦
                } else {
                    configName = 'æœªå‘½åé…ç½®';
                }
            }
        }

        // ä¿å­˜é…ç½®
        function saveConfig() {
            // ç¡®ä¿é…ç½®åç§°æ˜¯æœ€æ–°çš„
            updateConfigName();

            const config = {
                name: configName,
                layout: 'horizontal', // ä¿æŒå›ºå®šå€¼ä»¥å‘åå…¼å®¹
                items: items,
                versions: allVersions,
                manualVersions: manualVersions,
                createdAt: new Date().toISOString(),
                updatedAt: new Date().toISOString()
            };

            localStorage.setItem('comparisonConfig', JSON.stringify(config));
        }

        // åŠ è½½é…ç½®
        function loadConfig() {
            document.getElementById('fileInput').click();
        }

        // å¤„ç†æ–‡ä»¶å¯¼å…¥
        function handleFileImport(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const config = JSON.parse(e.target.result);
                    loadConfigData(config);
                    alert('é…ç½®åŠ è½½æˆåŠŸï¼');
                } catch (error) {
                    alert('é…ç½®æ–‡ä»¶æ ¼å¼é”™è¯¯ï¼š' + error.message);
                }
            };
            reader.readAsText(file);
        }

        // å¯¼å‡ºHTML
        function exportHTML() {
            // ç¡®ä¿é…ç½®åç§°æ˜¯æœ€æ–°çš„
            updateConfigName();

            const htmlContent = generateStandaloneHTML();
            const blob = new Blob([htmlContent], { type: 'text/html' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${configName.replace(/\s+/g, '_')}_ç‰ˆæœ¬${currentVersion + 1}.html`;
            a.click();
            URL.revokeObjectURL(url);
        }

        // ç”Ÿæˆç‹¬ç«‹çš„HTMLæ–‡ä»¶
        function generateStandaloneHTML() {
            const currentVersionData = allVersions[currentVersion] || {};
            const combination = currentVersionData.combination || [];
            const positions = currentVersionData.positions || {};

            let itemsHTML = '';
            const hasTitle = items.some(it => it.title || it.subtitle);
            const horizontalSpacing = hasTitle ? 280 : 220;
            const layoutClass = ''; // ä½¿ç”¨ç»å¯¹å®šä½å¸ƒå±€

            items.forEach((item, itemIndex) => {
                const emoji = combination[itemIndex] || '';
                const pos = positions[itemIndex] || {};
                let positionStyle = '';

                if (pos.x !== undefined && pos.y !== undefined) {
                    positionStyle = `position: absolute; left: ${pos.x}px; top: ${pos.y}px;`;
                } else {
                    // é»˜è®¤æ¨ªå‘å¸ƒå±€
                    positionStyle = `position: absolute; left: ${itemIndex * horizontalSpacing + 50}px; top: 50%; transform: translateY(-50%);`;
                }

                const hasText = item.title || item.subtitle;

                if (item.displayStyle === 'icon') {
                    itemsHTML += `
                        <div class="comparison-item" style="${positionStyle}">
                            <div class="icon-container ${item.shape}" style="background-color: ${item.color}">
                                ${emoji}
                            </div>
                            ${hasText ? `<div class="text-content">
                                ${item.title ? `<div class="title">${item.title}</div>` : ''}
                                ${item.subtitle ? `<div class="subtitle">${item.subtitle}</div>` : ''}
                            </div>` : ''}
                        </div>
                    `;
                } else {
                    const externalEmojis = item.externalEmojis || [];
                    const distance = item.externalEmojiDistance || 65;
                    const styledContent = parseTextStyles(item.boxContent || 'æ–‡æœ¬æ¡†å†…å®¹');

                    const externalEmojisHTML = externalEmojis.length > 0 ? `
                        <div class="external-emojis-container ${item.externalEmojiPosition}" style="${
                            item.externalEmojiPosition === 'top' ? `top: -${distance}px;` :
                            item.externalEmojiPosition === 'bottom' ? `bottom: -${distance}px;` :
                            item.externalEmojiPosition === 'left' ? `left: -${distance}px;` :
                            `right: -${distance}px;`
                        }">
                            ${externalEmojis.map(emoji => `<span class="external-emoji-item">${emoji}</span>`).join('')}
                        </div>
                    ` : '';

                    const decorativeEmojis = item.decorativeEmojis || [];
                    const decorativeEmojisHTML = decorativeEmojis.map(deco => `
                        <span class="decorative-emoji" style="position: absolute; left: ${deco.x}px; top: ${deco.y}px; font-size: ${deco.fontSize || 32}px; cursor: default; user-select: none; pointer-events: none;">
                            ${deco.emoji}
                        </span>
                    `).join('');

                    itemsHTML += `
                        <div class="comparison-item" style="${positionStyle}">
                            <div class="text-box-container">
                                ${externalEmojisHTML}
                                <div class="text-box ${item.boxStyle}" style="background-color: ${item.color}; color: white;">
                                    ${styledContent}
                                </div>
                                ${decorativeEmojisHTML}
                            </div>
                            ${hasText ? `<div class="text-content">
                                ${item.title ? `<div class="title">${item.title}</div>` : ''}
                                ${item.subtitle ? `<div class="subtitle">${item.subtitle}</div>` : ''}
                            </div>` : ''}
                        </div>
                    `;
                }
            });

            return `<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>${configName} - ç‰ˆæœ¬${currentVersion + 1}</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background: #f5f5f5;
            padding: 40px;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
        }
        .comparison-container {
            position: relative;
            width: 100%;
            height: 100%;
            min-height: 500px;
        }
        .comparison-container.vertical {
            display: flex;
            flex-direction: column;
        }
        .comparison-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
            min-width: 200px;
            max-width: 350px;
            position: absolute;
        }
        .icon-container {
            width: 120px;
            height: 120px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 60px;
            font-weight: normal;
        }
        .icon-container.circle {
            border-radius: 50%;
        }
        .icon-container.square {
            border-radius: 12px;
        }
        .text-box-container {
            position: relative;
            width: 100%;
            min-height: 120px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .text-box {
            padding: 20px 30px;
            border-radius: 12px;
            min-width: 200px;
            text-align: center;
            font-size: 24px;
            font-weight: 600;
            line-height: 1.4;
            word-wrap: break-word;
        }
        .text-box.rounded {
            border-radius: 12px;
        }
        .text-box.rectangle {
            border-radius: 4px;
        }
        .external-emojis-container {
            position: absolute;
            display: flex;
            gap: 8px;
            z-index: 10;
            flex-wrap: nowrap;
            white-space: nowrap;
        }
        .external-emojis-container.top { left: 50%; transform: translateX(-50%); }
        .external-emojis-container.bottom { left: 50%; transform: translateX(-50%); }
        .external-emojis-container.left { top: 50%; transform: translateY(-50%); flex-direction: column; }
        .external-emojis-container.right { top: 50%; transform: translateY(-50%); flex-direction: column; }
        .external-emoji-item {
            font-size: 48px;
            line-height: 1;
        }
        .text-content {
            text-align: center;
        }
        .title {
            font-size: 32px;
            font-weight: 700;
            color: #1a1a1a;
            margin-bottom: 4px;
        }
        .title:last-child {
            margin-bottom: 0;
        }
        .subtitle {
            font-size: 20px;
            font-weight: 500;
            color: #666;
        }
        @media (max-width: 768px) {
            body { padding: 20px; }
            .comparison-container { flex-direction: column; gap: 30px; }
            .icon-container { width: 100px; height: 100px; font-size: 50px; }
            .text-box { font-size: 20px; padding: 15px 20px; }
            .title { font-size: 28px; }
            .subtitle { font-size: 18px; }
        }
    </style>
</head>
<body>
    <div class="comparison-container ${layoutClass}">
        ${itemsHTML}
    </div>
</body>
</html>`;
        }

        // å¯¼å‡ºJSON
        function exportJSON() {
            // ç¡®ä¿é…ç½®åç§°æ˜¯æœ€æ–°çš„
            updateConfigName();

            const config = {
                name: configName,
                layout: 'horizontal', // ä¿æŒå›ºå®šå€¼ä»¥å‘åå…¼å®¹
                items: items,
                versions: allVersions,
                manualVersions: manualVersions,
                createdAt: new Date().toISOString(),
                updatedAt: new Date().toISOString()
            };

            const jsonContent = JSON.stringify(config, null, 2);
            const blob = new Blob([jsonContent], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${configName.replace(/\s+/g, '_')}.json`;
            a.click();
            URL.revokeObjectURL(url);
        }

        // åˆå§‹åŒ–Emojié€‰æ‹©å™¨
        function initEmojiPicker() {
            const categoriesContainer = document.getElementById('emojiCategories');
            const categories = Object.keys(emojiCategories);
            
            categories.forEach((category, index) => {
                const btn = document.createElement('button');
                btn.className = 'category-btn' + (index === 0 ? ' active' : '');
                btn.textContent = category;
                btn.onclick = () => switchEmojiCategory(category, btn);
                categoriesContainer.appendChild(btn);
            });

            switchEmojiCategory(categories[0]);
        }

        // åˆ‡æ¢Emojiåˆ†ç±»
        function switchEmojiCategory(category, btnElement) {
            document.querySelectorAll('.category-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            if (btnElement) {
                btnElement.classList.add('active');
            } else {
                document.querySelectorAll('.category-btn').forEach(btn => {
                    if (btn.textContent === category) {
                        btn.classList.add('active');
                    }
                });
            }

            const grid = document.getElementById('emojiGrid');
            grid.innerHTML = '';
            
            emojiCategories[category].forEach(emoji => {
                const emojiDiv = document.createElement('div');
                emojiDiv.className = 'emoji-item';
                emojiDiv.textContent = emoji;
                emojiDiv.onclick = () => selectEmoji(emoji);
                grid.appendChild(emojiDiv);
            });
        }

        // æ‰“å¼€Emojié€‰æ‹©å™¨
        function openEmojiPicker(itemId, emojiIndex, field) {
            currentEmojiPicker.itemId = itemId;
            currentEmojiPicker.emojiIndex = emojiIndex;
            currentEmojiPicker.field = field;
            document.getElementById('emojiPickerModal').classList.add('show');
        }

        // å…³é—­Emojié€‰æ‹©å™¨
        function closeEmojiPicker() {
            document.getElementById('emojiPickerModal').classList.remove('show');
        }

        // é€‰æ‹©Emoji
        function selectEmoji(emoji) {
            const item = items.find(i => i.id === currentEmojiPicker.itemId);
            if (item) {
                if (currentEmojiPicker.field === 'externalEmojis') {
                    if (!item.externalEmojis) {
                        item.externalEmojis = [];
                    }
                    if (item.externalEmojis[currentEmojiPicker.emojiIndex] !== undefined) {
                        item.externalEmojis[currentEmojiPicker.emojiIndex] = emoji;
                    }
                } else if (currentEmojiPicker.field === 'decorativeSticker') {
                    // ä»ç”»å¸ƒæ·»åŠ è£…é¥°emojiè´´çº¸
                    if (!item.decorativeEmojis) {
                        item.decorativeEmojis = [];
                    }
                    // åœ¨æ–‡æœ¬æ¡†ä¸­å¿ƒä½ç½®æ·»åŠ æ–°çš„è£…é¥°emoji
                    item.decorativeEmojis.push({
                        emoji: emoji,
                        x: 0,  // ç›¸å¯¹äºæ–‡æœ¬æ¡†å®¹å™¨çš„åç§»
                        y: 0,
                        fontSize: 32
                    });
                    saveHistory();
                } else if (currentEmojiPicker.field === 'decorativeEmojis' || currentEmojiPicker.field === 'editor-decorativeEmojis') {
                    if (!item.decorativeEmojis) {
                        item.decorativeEmojis = [];
                    }
                    if (item.decorativeEmojis[currentEmojiPicker.emojiIndex] !== undefined) {
                        item.decorativeEmojis[currentEmojiPicker.emojiIndex].emoji = emoji;
                    }
                } else if (item.emojis[currentEmojiPicker.emojiIndex] !== undefined) {
                    item.emojis[currentEmojiPicker.emojiIndex] = emoji;
                }

                // æ›´æ–°UI
                renderElementList();
                renderEditPanel(selectedItemId);
                updatePreview();
            }
            closeEmojiPicker();
        }

        // ç”Ÿæˆæ‰€æœ‰ç‰ˆæœ¬
        function generateAllVersions() {
            if (items.length === 0) {
                allVersions = [];
                updatePreview();
                return;
            }

            // å¦‚æœå·²ç»æœ‰æ‰‹åŠ¨ç®¡ç†çš„ç‰ˆæœ¬ï¼Œä¿ç•™ä½ç½®ä¿¡æ¯
            if (manualVersions && allVersions.length > 0) {
                // åªæ›´æ–°emojiç»„åˆï¼Œä¿ç•™ä½ç½®ä¿¡æ¯
                const itemEmojiLists = items.map(item => {
                    if (item.displayStyle === 'icon') {
                        return item.emojis.filter(e => e.trim());
                    } else {
                        // æ–‡æœ¬æ¡†æ ·å¼ä¸å‚ä¸emojiç»„åˆç‰ˆæœ¬ç”Ÿæˆ
                        return [''];
                    }
                });

                function getCombinations(arrays, index = 0, current = []) {
                    if (index === arrays.length) {
                        return [current];
                    }
                    const result = [];
                    const currentArray = arrays[index].length > 0 ? arrays[index] : [''];
                    for (const value of currentArray) {
                        result.push(...getCombinations(arrays, index + 1, [...current, value]));
                    }
                    return result;
                }

                const newCombinations = getCombinations(itemEmojiLists);
                
                // åˆå¹¶ä½ç½®ä¿¡æ¯
                allVersions = newCombinations.map((combo, index) => {
                    const oldVersion = allVersions[index];
                    return {
                        combination: combo,
                        positions: oldVersion?.positions || {},
                        name: oldVersion?.name || `ç‰ˆæœ¬ ${index + 1}`
                    };
                });
            } else {
                // è‡ªåŠ¨ç”Ÿæˆæ‰€æœ‰ç»„åˆ
                const itemEmojiLists = items.map(item => {
                    if (item.displayStyle === 'icon') {
                        return item.emojis.filter(e => e.trim());
                    } else {
                        // æ–‡æœ¬æ¡†æ ·å¼ä¸å‚ä¸emojiç»„åˆç‰ˆæœ¬ç”Ÿæˆ
                        return [''];
                    }
                });

                function getCombinations(arrays, index = 0, current = []) {
                    if (index === arrays.length) {
                        return [current];
                    }
                    const result = [];
                    const currentArray = arrays[index].length > 0 ? arrays[index] : [''];
                    for (const value of currentArray) {
                        result.push(...getCombinations(arrays, index + 1, [...current, value]));
                    }
                    return result;
                }

                const combinations = getCombinations(itemEmojiLists);

                // é»˜è®¤åªç”Ÿæˆä¸€ä¸ªç‰ˆæœ¬ï¼ˆä½¿ç”¨ç¬¬ä¸€ä¸ªemojiç»„åˆï¼‰
                if (combinations.length > 0) {
                    // ä¿ç•™ç°æœ‰çš„positionsä¿¡æ¯
                    const existingPositions = allVersions[0]?.positions || {};
                    allVersions = [{
                        combination: combinations[0],
                        positions: existingPositions,
                        name: `ç‰ˆæœ¬ 1`
                    }];
                } else {
                    allVersions = [];
                }
            }

            currentVersion = Math.min(currentVersion, allVersions.length - 1);
            updatePreview();
        }

        // æ·»åŠ æ–°ç‰ˆæœ¬
        function addVersion() {
            if (items.length === 0) return;
            
            const itemEmojiLists = items.map(item => {
                if (item.displayStyle === 'icon') {
                    const validEmojis = item.emojis.filter(e => e.trim());
                    return validEmojis.length > 0 ? validEmojis[0] : '';
                } else {
                    // æ–‡æœ¬æ¡†æ ·å¼ä¸å‚ä¸emojiç»„åˆ
                    return '';
                }
            });

            allVersions.push({
                combination: itemEmojiLists,
                positions: {},
                name: `ç‰ˆæœ¬ ${allVersions.length + 1}`
            });
            
            manualVersions = true;
            currentVersion = allVersions.length - 1;
            updatePreview();
        }

        // åˆ é™¤ç‰ˆæœ¬
        function deleteVersion(versionIndex) {
            if (allVersions.length <= 1) {
                alert('è‡³å°‘éœ€è¦ä¿ç•™ä¸€ä¸ªç‰ˆæœ¬ï¼');
                return;
            }
            
            allVersions.splice(versionIndex, 1);
            manualVersions = true;
            
            if (currentVersion >= allVersions.length) {
                currentVersion = allVersions.length - 1;
            }
            
            updatePreview();
        }

        // æ·»åŠ æ–°çš„å¯¹æ¯”é¡¹
        function addItem() {
            const newItem = {
                id: Date.now(),
                title: "",
                subtitle: "",
                color: "#3B82F6",
                shape: "circle",
                displayStyle: "textbox",  // é»˜è®¤æ”¹ä¸ºæ–‡æœ¬æ¡†æ ·å¼
                emojis: [""],
                boxContent: "",
                boxStyle: "rounded",
                externalEmojis: [],
                externalEmojiPosition: "top",
                externalEmojiDistance: 65,
                decorativeEmojis: [] // {emoji, x, y, fontSize}
            };
            items.push(newItem);
            saveHistory();
            selectItem(newItem.id);  // è‡ªåŠ¨é€‰ä¸­æ–°å…ƒç´ 
            generateAllVersions();
        }

        // åˆ é™¤å¯¹æ¯”é¡¹
        function deleteItem(id) {
            items = items.filter(item => item.id !== id);
            saveHistory();
            // å¦‚æœåˆ é™¤çš„æ˜¯å½“å‰é€‰ä¸­çš„å…ƒç´ ï¼Œæ¸…ç©ºé€‰æ‹©
            if (selectedItemId === id) {
                selectedItemId = null;
            }
            renderElementList();
            renderEditPanel(selectedItemId);
            generateAllVersions();
        }

        // æ‹–æ‹½åŠŸèƒ½
        function handleDragStart(e, index) {
            draggedElement = e.currentTarget;
            draggedIndex = index;
            e.currentTarget.classList.add('dragging');
            e.dataTransfer.effectAllowed = 'move';
            e.dataTransfer.setData('text/html', e.currentTarget.innerHTML);
        }

        function handleDragEnd(e) {
            e.currentTarget.classList.remove('dragging');
        }

        function handleDragOver(e) {
            if (e.preventDefault) {
                e.preventDefault();
            }
            e.dataTransfer.dropEffect = 'move';
            return false;
        }

        function handleDragEnter(e) {
            e.currentTarget.classList.add('dragging');
        }

        function handleDragLeave(e) {
            e.currentTarget.classList.remove('dragging');
        }

        function handleDrop(e, dropIndex) {
            if (e.stopPropagation) {
                e.stopPropagation();
            }

            if (draggedIndex !== dropIndex) {
                const draggedItem = items[draggedIndex];
                items.splice(draggedIndex, 1);
                items.splice(dropIndex, 0, draggedItem);
                saveHistory();
                renderElementList();
                renderEditPanel(selectedItemId);
                generateAllVersions();
            }

            return false;
        }

        // ========== æ–°UIæ¸²æŸ“å‡½æ•° ==========

        // é€‰æ‹©å…ƒç´ 
        function selectItem(itemId) {
            selectedItemId = itemId;
            renderElementList();
            renderEditPanel(itemId);
        }

        // æ¸²æŸ“å·¦ä¾§å…ƒç´ åˆ—è¡¨
        function renderElementList() {
            const container = document.getElementById('elementList');
            container.innerHTML = '';

            items.forEach((item, index) => {
                const itemDiv = document.createElement('div');
                itemDiv.className = 'element-list-item';
                if (item.id === selectedItemId) {
                    itemDiv.classList.add('selected');
                }
                itemDiv.draggable = true;
                itemDiv.ondragstart = (e) => handleDragStart(e, index);
                itemDiv.ondragend = handleDragEnd;
                itemDiv.ondragover = handleDragOver;
                itemDiv.ondragenter = handleDragEnter;
                itemDiv.ondragleave = handleDragLeave;
                itemDiv.ondrop = (e) => handleDrop(e, index);
                itemDiv.onclick = () => selectItem(item.id);

                const icon = item.displayStyle === 'icon' ? 'ğŸ¨' : 'ğŸ’¬';
                const title = item.title || item.boxContent || `å…ƒç´  ${index + 1}`;
                const preview = item.displayStyle === 'icon'
                    ? (item.emojis && item.emojis[0] ? item.emojis.filter(e => e).join(' ') : 'æ— emoji')
                    : (item.boxContent ? item.boxContent.substring(0, 20) + (item.boxContent.length > 20 ? '...' : '') : 'ç©ºå†…å®¹');

                itemDiv.innerHTML = `
                    <div class="element-list-item-drag">â˜°</div>
                    <div class="element-list-item-header">
                        <div class="element-list-item-icon">${icon}</div>
                        <div class="element-list-item-title">${title}</div>
                    </div>
                    <div class="element-list-item-preview">${preview}</div>
                `;
                container.appendChild(itemDiv);
            });

            // å¦‚æœæ²¡æœ‰é€‰ä¸­çš„å…ƒç´ ï¼Œæ˜¾ç¤ºç©ºçŠ¶æ€
            if (items.length === 0) {
                container.innerHTML = '<div style="text-align: center; padding: 20px; color: #999;">æš‚æ— å…ƒç´ </div>';
            }
        }

        // æ¸²æŸ“å³ä¾§ç¼–è¾‘é¢æ¿
        function renderEditPanel(itemId) {
            const container = document.getElementById('editPanelContent');

            if (!itemId) {
                container.innerHTML = `
                    <div class="edit-panel-empty">
                        <div class="edit-panel-empty-icon">âœï¸</div>
                        <div>é€‰æ‹©ä¸€ä¸ªå…ƒç´ å¼€å§‹ç¼–è¾‘</div>
                    </div>
                `;
                return;
            }

            const item = items.find(i => i.id === itemId);
            if (!item) return;

            const index = items.indexOf(item);

            container.innerHTML = `
                <h2>ç¼–è¾‘å…ƒç´  ${index + 1}</h2>

                <div style="margin-bottom: 15px; display: flex; gap: 8px;">
                    <button class="btn-duplicate" onclick="duplicateItem(${item.id}); event.stopPropagation();" style="flex: 1;">ğŸ“‹ å¤åˆ¶</button>
                    <button class="btn-delete" onclick="deleteItem(${item.id}); selectItem(null); event.stopPropagation();" style="flex: 1;">åˆ é™¤</button>
                </div>

                <!-- åŸºæœ¬è®¾ç½® -->
                <div class="collapsible-section">
                    <div class="collapsible-header" onclick="toggleCollapsible(this)">
                        <span class="collapsible-header-title">åŸºæœ¬è®¾ç½®</span>
                        <span class="collapsible-toggle">â–¼</span>
                    </div>
                    <div class="collapsible-content">
                        <div class="form-group">
                            <label>æ˜¾ç¤ºæ ·å¼</label>
                            <div class="button-group">
                                <button class="option-btn ${item.displayStyle === 'icon' ? 'active' : ''}"
                                        onclick="updateItem(${item.id}, 'displayStyle', 'icon'); selectItem(${item.id}); generateAllVersions();">
                                    ğŸ¨ å›¾æ ‡æ ·å¼
                                </button>
                                <button class="option-btn ${item.displayStyle === 'textbox' ? 'active' : ''}"
                                        onclick="updateItem(${item.id}, 'displayStyle', 'textbox'); selectItem(${item.id}); generateAllVersions();">
                                    ğŸ’¬ æ–‡æœ¬æ¡†æ ·å¼
                                </button>
                            </div>
                        </div>
                        <div class="form-group">
                            <label>æ ‡é¢˜ï¼ˆå¯é€‰ï¼‰</label>
                            <div class="input-wrapper">
                                <input type="text" value="${item.title}" placeholder="ç•™ç©ºåˆ™ä¸æ˜¾ç¤ºæ ‡é¢˜"
                                       oninput="updateItem(${item.id}, 'title', this.value); generateAllVersions(); renderElementList();">
                                <button class="btn-clear-input" type="button" onclick="updateItem(${item.id}, 'title', ''); selectItem(${item.id}); generateAllVersions();">Ã—</button>
                            </div>
                        </div>
                        <div class="form-group">
                            <label>å‰¯æ ‡é¢˜ï¼ˆå¯é€‰ï¼‰</label>
                            <div class="input-wrapper">
                                <input type="text" value="${item.subtitle}" placeholder="ç•™ç©ºåˆ™ä¸æ˜¾ç¤ºå‰¯æ ‡é¢˜"
                                       oninput="updateItem(${item.id}, 'subtitle', this.value); generateAllVersions(); renderElementList();">
                                <button class="btn-clear-input" type="button" onclick="updateItem(${item.id}, 'subtitle', ''); selectItem(${item.id}); generateAllVersions();">Ã—</button>
                            </div>
                        </div>
                        <div class="form-group">
                            <label>èƒŒæ™¯é¢œè‰²</label>
                            <input type="color" value="${item.color}"
                                   onchange="updateItem(${item.id}, 'color', this.value); generateAllVersions();">
                        </div>
                    </div>
                </div>

                <!-- å†…å®¹è®¾ç½® -->
                <div class="collapsible-section">
                    <div class="collapsible-header" onclick="toggleCollapsible(this)">
                        <span class="collapsible-header-title">${item.displayStyle === 'icon' ? 'Emojiè®¾ç½®' : 'æ–‡æœ¬æ¡†å†…å®¹'}</span>
                        <span class="collapsible-toggle">â–¼</span>
                    </div>
                    <div class="collapsible-content">
                        ${item.displayStyle === 'icon' ? `
                            <div class="form-group">
                                <label>Emoji</label>
                                <div class="emoji-input-group" id="emojis-${item.id}"></div>
                                <button class="btn-add-emoji" onclick="addEmoji(${item.id})">+ æ·»åŠ Emoji</button>
                            </div>
                        ` : `
                            <div class="form-group">
                                <label>æ–‡æœ¬æ¡†å†…å®¹</label>
                                <div class="input-wrapper">
                                    <textarea placeholder="è¾“å…¥æ–‡å­—å’Œemoji" rows="4"
                                              oninput="updateItem(${item.id}, 'boxContent', this.value); generateAllVersions(); renderElementList();">${item.boxContent}</textarea>
                                    <button class="btn-clear-input" type="button" onclick="updateItem(${item.id}, 'boxContent', ''); selectItem(${item.id}); generateAllVersions();">Ã—</button>
                                </div>
                                <div class="style-help" style="font-size: 11px; margin-top: 5px;">
                                    æ”¯æŒMarkdown: <code>**ç²—ä½“**</code> <code>*æ–œä½“*</code> <code>~~åˆ é™¤çº¿~~</code> <code>==é«˜äº®==</code>
                                </div>
                            </div>
                        `}
                    </div>
                </div>

                <!-- é«˜çº§è®¾ç½® -->
                <div class="collapsible-section collapsed">
                    <div class="collapsible-header" onclick="toggleCollapsible(this)">
                        <span class="collapsible-header-title">é«˜çº§è®¾ç½®</span>
                        <span class="collapsible-toggle">â–¼</span>
                    </div>
                    <div class="collapsible-content">
                        ${item.displayStyle === 'icon' ? `
                            <div class="form-group">
                                <label>å½¢çŠ¶</label>
                                <div class="button-group">
                                    <button class="option-btn ${item.shape === 'circle' ? 'active' : ''}"
                                            onclick="updateItem(${item.id}, 'shape', 'circle'); generateAllVersions();">
                                        â­• åœ†å½¢
                                    </button>
                                    <button class="option-btn ${item.shape === 'square' ? 'active' : ''}"
                                            onclick="updateItem(${item.id}, 'shape', 'square'); generateAllVersions();">
                                        â—»ï¸ æ–¹å½¢
                                    </button>
                                </div>
                            </div>
                        ` : `
                            <div class="form-group">
                                <label>æ–‡æœ¬æ¡†æ ·å¼</label>
                                <div class="button-group">
                                    <button class="option-btn ${item.boxStyle === 'rounded' ? 'active' : ''}"
                                            onclick="updateItem(${item.id}, 'boxStyle', 'rounded'); generateAllVersions();">
                                        â–¢ åœ†è§’çŸ©å½¢
                                    </button>
                                    <button class="option-btn ${item.boxStyle === 'rectangle' ? 'active' : ''}"
                                            onclick="updateItem(${item.id}, 'boxStyle', 'rectangle'); generateAllVersions();">
                                        â–­ é•¿æ–¹å½¢
                                    </button>
                                </div>
                            </div>
                            <div class="form-group">
                                <label>æ¡†å¤–Emoji</label>
                                <div class="emoji-input-group" id="external-emojis-${item.id}"></div>
                                <button class="btn-add-emoji" onclick="addExternalEmoji(${item.id})">+ æ·»åŠ æ¡†å¤–Emoji</button>
                            </div>
                            <div class="form-group">
                                <label>æ¡†å¤–Emojiè·ç¦»ï¼š<span id="distance-value-${item.id}">${item.externalEmojiDistance || 65}px</span></label>
                                <input type="range" min="30" max="150" step="5" value="${item.externalEmojiDistance || 65}"
                                       style="width: 100%;"
                                       oninput="updateItem(${item.id}, 'externalEmojiDistance', parseInt(this.value)); document.getElementById('distance-value-${item.id}').textContent = this.value + 'px'; generateAllVersions();">
                            </div>
                            <div class="form-group">
                                <label>è£…é¥°Emoji</label>
                                <div class="emoji-input-group" id="decorative-emojis-${item.id}"></div>
                                <button class="btn-add-emoji" onclick="addDecorativeEmoji(${item.id})">+ æ·»åŠ è£…é¥°Emoji</button>
                            </div>
                        `}
                        <div class="form-group">
                            <label>é¢œè‰²é¢„è®¾</label>
                            <div style="display: flex; flex-wrap: wrap; gap: 6px;">
                                ${colorPresets.map(preset => `
                                    <button class="color-preset-btn"
                                            style="background: ${preset.bg}; color: ${preset.text}; padding: 4px 8px; border: 2px solid ${item.color === preset.bg ? '#000' : 'transparent'}; border-radius: 4px; cursor: pointer; font-size: 11px; font-weight: 500;"
                                            onclick="updateItem(${item.id}, 'color', '${preset.bg}'); selectItem(${item.id}); generateAllVersions();">
                                        ${preset.name}
                                    </button>
                                `).join('')}
                            </div>
                        </div>
                    </div>
                </div>
            `;

            // æ¸²æŸ“emojiè¾“å…¥æ¡†
            if (item.displayStyle === 'icon') {
                renderEmojis(item.id, item.emojis);
            } else {
                renderExternalEmojis(item.id, item.externalEmojis || []);
                renderDecorativeEmojis(item.id, item.decorativeEmojis || []);
            }
        }

        // æŠ˜å /å±•å¼€åŠŸèƒ½
        function toggleCollapsible(headerElement) {
            const section = headerElement.parentElement;
            section.classList.toggle('collapsed');
        }

        // æ¸²æŸ“é…ç½®é¢æ¿ (æ—§ç‰ˆï¼Œä¿ç•™ç”¨äºå…¼å®¹)
        function renderConfig() {
            const container = document.getElementById('itemsConfig');
            container.innerHTML = '';

            items.forEach((item, index) => {
                const itemDiv = document.createElement('div');
                itemDiv.className = 'item-config';
                itemDiv.draggable = true;
                itemDiv.ondragstart = (e) => handleDragStart(e, index);
                itemDiv.ondragend = handleDragEnd;
                itemDiv.ondragover = handleDragOver;
                itemDiv.ondragenter = handleDragEnter;
                itemDiv.ondragleave = handleDragLeave;
                itemDiv.ondrop = (e) => handleDrop(e, index);
                
                itemDiv.innerHTML = `
                    <div class="drag-handle">â˜°</div>
                    <div class="item-config-header">
                        <span class="item-config-title">å¯¹æ¯”é¡¹ ${index + 1}</span>
                        <div>
                            <button class="btn-duplicate" onclick="duplicateItem(${item.id})">ğŸ“‹ å¤åˆ¶</button>
                            <button class="btn-delete" onclick="deleteItem(${item.id})">åˆ é™¤</button>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>æ˜¾ç¤ºæ ·å¼</label>
                        <div class="button-group">
                            <button class="option-btn ${item.displayStyle === 'icon' ? 'active' : ''}"
                                    onclick="updateItem(${item.id}, 'displayStyle', 'icon'); renderConfig(); generateAllVersions();">
                                ğŸ¨ å›¾æ ‡æ ·å¼
                            </button>
                            <button class="option-btn ${item.displayStyle === 'textbox' ? 'active' : ''}"
                                    onclick="updateItem(${item.id}, 'displayStyle', 'textbox'); renderConfig(); generateAllVersions();">
                                ğŸ’¬ æ–‡æœ¬æ¡†æ ·å¼
                            </button>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>æ ‡é¢˜ï¼ˆå¯é€‰ï¼‰</label>
                        <div class="input-wrapper">
                            <input type="text" value="${item.title}" placeholder="ç•™ç©ºåˆ™ä¸æ˜¾ç¤ºæ ‡é¢˜"
                                   oninput="updateItem(${item.id}, 'title', this.value); generateAllVersions();">
                            <button class="btn-clear-input" type="button" onclick="updateItem(${item.id}, 'title', ''); renderConfig(); generateAllVersions();">Ã—</button>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>å‰¯æ ‡é¢˜ï¼ˆå¯é€‰ï¼‰</label>
                        <div class="input-wrapper">
                            <input type="text" value="${item.subtitle}" placeholder="ç•™ç©ºåˆ™ä¸æ˜¾ç¤ºå‰¯æ ‡é¢˜"
                                   oninput="updateItem(${item.id}, 'subtitle', this.value); generateAllVersions();">
                            <button class="btn-clear-input" type="button" onclick="updateItem(${item.id}, 'subtitle', ''); renderConfig(); generateAllVersions();">Ã—</button>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>é¢œè‰²é¢„è®¾</label>
                        <div style="display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 10px;">
                            ${colorPresets.map(preset => `
                                <button class="color-preset-btn"
                                        style="background: ${preset.bg}; color: ${preset.text}; padding: 6px 12px; border: 2px solid ${item.color === preset.bg ? '#000' : 'transparent'}; border-radius: 6px; cursor: pointer; font-size: 12px; font-weight: 500;"
                                        onclick="updateItem(${item.id}, 'color', '${preset.bg}'); renderConfig(); generateAllVersions();">
                                    ${preset.name}
                                </button>
                            `).join('')}
                        </div>
                        <label>è‡ªå®šä¹‰é¢œè‰²</label>
                        <input type="color" value="${item.color}"
                               onchange="updateItem(${item.id}, 'color', this.value); generateAllVersions();">
                    </div>
                    ${item.displayStyle === 'icon' ? `
                        <div class="form-group">
                            <label>å½¢çŠ¶</label>
                            <div class="button-group">
                                <button class="option-btn ${item.shape === 'circle' ? 'active' : ''}"
                                        onclick="updateItem(${item.id}, 'shape', 'circle'); generateAllVersions();">
                                    â­• åœ†å½¢
                                </button>
                                <button class="option-btn ${item.shape === 'square' ? 'active' : ''}"
                                        onclick="updateItem(${item.id}, 'shape', 'square'); generateAllVersions();">
                                    â—»ï¸ æ–¹å½¢
                                </button>
                            </div>
                        </div>
                        <div class="form-group">
                            <label>Emoji</label>
                            <div class="emoji-input-group" id="emojis-${item.id}"></div>
                            <button class="btn-add-emoji" onclick="addEmoji(${item.id})">+ æ·»åŠ Emoji</button>
                        </div>
                    ` : `
                        <div class="form-group">
                            <label>æ–‡æœ¬æ¡†å†…å®¹ï¼ˆæ”¯æŒæ–‡å­—å’Œemojiæ··æ’ï¼‰</label>
                            <div class="input-wrapper">
                                <textarea placeholder="è¾“å…¥æ–‡å­—å’Œemojiï¼Œä¾‹å¦‚ï¼šmust ğŸ¤”&#10;æ”¯æŒMarkdownæ ·å¼ï¼š&#10;**ç²—ä½“** *æ–œä½“* ~~åˆ é™¤çº¿~~ ==é«˜äº®=="
                                          oninput="updateItem(${item.id}, 'boxContent', this.value); generateAllVersions();">${item.boxContent}</textarea>
                                <button class="btn-clear-input" type="button" onclick="updateItem(${item.id}, 'boxContent', ''); renderConfig(); generateAllVersions();">Ã—</button>
                            </div>
                            <div class="style-help">
                                <strong>Markdownæ ·å¼è¯­æ³•ï¼š</strong><br>
                                <code>**æ–‡å­—**</code> æˆ– <code>__æ–‡å­—__</code> - åŠ ç²—<br>
                                <code>*æ–‡å­—*</code> æˆ– <code>_æ–‡å­—_</code> - æ–œä½“<br>
                                <code>~~æ–‡å­—~~</code> - åˆ é™¤çº¿<br>
                                <code>==æ–‡å­—==</code> - é»„è‰²é«˜äº®<br>
                                <code>[stroke]æ–‡å­—[/stroke]</code> - å­—ä½“æè¾¹<br>
                                <code>&#96;æ–‡å­—&#96;</code> - ä»£ç æ ·å¼<br>
                                <br>
                                <strong>é«˜äº®é¢„è®¾é¢œè‰²ï¼ˆå¿«é€Ÿä½¿ç”¨ï¼‰ï¼š</strong><br>
                                ${highlightPresets.map(preset => `
                                    <code>[highlight:${preset.color}]æ–‡å­—[/highlight]</code> - <span style="background: ${preset.color}; padding: 2px 6px; border-radius: 3px;">${preset.name}</span><br>
                                `).join('')}
                                <br>
                                <strong>é«˜çº§æ ·å¼ï¼ˆå‘åå…¼å®¹ï¼‰ï¼š</strong><br>
                                <code>[color:#ff0000]æ–‡å­—[/color]</code> - è‡ªå®šä¹‰é¢œè‰²<br>
                                <code>[highlight:#ä»»æ„é¢œè‰²]æ–‡å­—[/highlight]</code> - è‡ªå®šä¹‰é«˜äº®è‰²<br>
                                <code>[style:color:#ff0000;background:#ffff00]æ–‡å­—[/style]</code> - è‡ªå®šä¹‰CSSæ ·å¼
                            </div>
                        </div>
                        <div class="form-group">
                            <label>æ–‡æœ¬æ¡†æ ·å¼</label>
                            <div class="button-group">
                                <button class="option-btn ${item.boxStyle === 'rounded' ? 'active' : ''}"
                                        onclick="updateItem(${item.id}, 'boxStyle', 'rounded'); generateAllVersions();">
                                    â–¢ åœ†è§’çŸ©å½¢
                                </button>
                                <button class="option-btn ${item.boxStyle === 'rectangle' ? 'active' : ''}"
                                        onclick="updateItem(${item.id}, 'boxStyle', 'rectangle'); generateAllVersions();">
                                    â–­ é•¿æ–¹å½¢
                                </button>
                            </div>
                        </div>
                        <div class="form-group">
                            <label>æ¡†å¤–Emoji</label>
                            <div class="emoji-input-group" id="external-emojis-${item.id}"></div>
                            <button class="btn-add-emoji" onclick="addExternalEmoji(${item.id})">+ æ·»åŠ æ¡†å¤–Emoji</button>
                        </div>
                        <div class="form-group">
                            <label>æ¡†å¤–Emojiè·ç¦»ï¼š<span id="distance-value-${item.id}">${item.externalEmojiDistance || 65}px</span></label>
                            <input type="range" min="30" max="150" step="5" value="${item.externalEmojiDistance || 65}"
                                   style="width: 100%;"
                                   oninput="updateItem(${item.id}, 'externalEmojiDistance', parseInt(this.value)); document.getElementById('distance-value-${item.id}').textContent = this.value + 'px'; generateAllVersions();">
                        </div>
                        <div class="form-group">
                            <label>æ¡†å¤–Emojiä½ç½®</label>
                            <div class="button-group">
                                <button class="option-btn ${item.externalEmojiPosition === 'top' ? 'active' : ''}"
                                        onclick="updateItem(${item.id}, 'externalEmojiPosition', 'top'); generateAllVersions();"
                                        style="flex: 0 0 calc(50% - 4px);">
                                    â¬†ï¸ ä¸Šæ–¹
                                </button>
                                <button class="option-btn ${item.externalEmojiPosition === 'bottom' ? 'active' : ''}"
                                        onclick="updateItem(${item.id}, 'externalEmojiPosition', 'bottom'); generateAllVersions();"
                                        style="flex: 0 0 calc(50% - 4px);">
                                    â¬‡ï¸ ä¸‹æ–¹
                                </button>
                                <button class="option-btn ${item.externalEmojiPosition === 'left' ? 'active' : ''}"
                                        onclick="updateItem(${item.id}, 'externalEmojiPosition', 'left'); generateAllVersions();"
                                        style="flex: 0 0 calc(50% - 4px);">
                                    â¬…ï¸ å·¦ä¾§
                                </button>
                                <button class="option-btn ${item.externalEmojiPosition === 'right' ? 'active' : ''}"
                                        onclick="updateItem(${item.id}, 'externalEmojiPosition', 'right'); generateAllVersions();"
                                        style="flex: 0 0 calc(50% - 4px);">
                                    â¡ï¸ å³ä¾§
                                </button>
                            </div>
                        </div>
                        <div class="form-group">
                            <label>è£…é¥°Emojiï¼ˆå¯æ‹–æ‹½è°ƒæ•´ä½ç½®å’Œå¤§å°ï¼‰</label>
                            <div class="emoji-input-group" id="decorative-emojis-${item.id}"></div>
                            <button class="btn-add-emoji" onclick="addDecorativeEmoji(${item.id})">+ æ·»åŠ è£…é¥°Emoji</button>
                        </div>
                    `}
                `;
                container.appendChild(itemDiv);

                if (item.displayStyle === 'icon') {
                    renderEmojis(item.id, item.emojis);
                } else {
                    renderExternalEmojis(item.id, item.externalEmojis || []);
                    renderDecorativeEmojis(item.id, item.decorativeEmojis || []);
                }
            });
        }

        // æ¸²æŸ“æ¡†å¤–emojiåˆ—è¡¨
        function renderExternalEmojis(itemId, externalEmojis) {
            const container = document.getElementById(`external-emojis-${itemId}`);
            if (!container) return;
            container.innerHTML = '';

            externalEmojis.forEach((emoji, index) => {
                const emojiDiv = document.createElement('div');
                emojiDiv.className = 'emoji-display';
                emojiDiv.style.display = 'flex';
                emojiDiv.style.alignItems = 'center';
                emojiDiv.style.marginBottom = '5px';

                const input = document.createElement('input');
                input.type = 'text';
                input.value = emoji;
                input.placeholder = 'è¾“å…¥emoji';
                input.style.flex = '1';
                input.oninput = () => {
                    const item = items.find(i => i.id === itemId);
                    item.externalEmojis[index] = input.value;
                    generateAllVersions();
                };

                const pickBtn = document.createElement('button');
                pickBtn.className = 'btn-pick-emoji';
                pickBtn.textContent = 'é€‰æ‹©';
                pickBtn.onclick = () => openEmojiPicker(itemId, index, 'externalEmojis');

                const removeBtn = document.createElement('button');
                removeBtn.className = 'btn-remove-emoji';
                removeBtn.textContent = 'Ã—';
                removeBtn.onclick = () => {
                    const item = items.find(i => i.id === itemId);
                    item.externalEmojis.splice(index, 1);
                    renderConfig();
                    generateAllVersions();
                };

                emojiDiv.appendChild(input);
                emojiDiv.appendChild(pickBtn);
                emojiDiv.appendChild(removeBtn);
                container.appendChild(emojiDiv);
            });
        }

        // æ·»åŠ æ¡†å¤–emoji
        function addExternalEmoji(itemId) {
            const item = items.find(i => i.id === itemId);
            if (item) {
                if (!item.externalEmojis) {
                    item.externalEmojis = [];
                }
                item.externalEmojis.push("");
                renderConfig();
            }
        }

        // æ¸²æŸ“emojiè¾“å…¥æ¡†
        function renderEmojis(itemId, emojis) {
            const container = document.getElementById(`emojis-${itemId}`);
            if (!container) return;
            container.innerHTML = '';
            
            emojis.forEach((emoji, index) => {
                const emojiDiv = document.createElement('div');
                emojiDiv.className = 'emoji-display';
                emojiDiv.style.display = 'flex';
                emojiDiv.style.alignItems = 'center';
                emojiDiv.style.marginBottom = '5px';
                
                const input = document.createElement('input');
                input.type = 'text';
                input.value = emoji;
                input.placeholder = 'è¾“å…¥emoji';
                input.style.flex = '1';
                input.oninput = () => {
                    const item = items.find(i => i.id === itemId);
                    item.emojis[index] = input.value;
                    generateAllVersions();
                };
                
                const pickBtn = document.createElement('button');
                pickBtn.className = 'btn-pick-emoji';
                pickBtn.textContent = 'é€‰æ‹©';
                pickBtn.onclick = () => openEmojiPicker(itemId, index, 'emoji');
                
                const removeBtn = document.createElement('button');
                removeBtn.className = 'btn-remove-emoji';
                removeBtn.textContent = 'Ã—';
                removeBtn.onclick = () => {
                    const item = items.find(i => i.id === itemId);
                    item.emojis.splice(index, 1);
                    if (item.emojis.length === 0) {
                        item.emojis.push("");
                    }
                    renderConfig();
                    generateAllVersions();
                };
                
                emojiDiv.appendChild(input);
                emojiDiv.appendChild(pickBtn);
                emojiDiv.appendChild(removeBtn);
                container.appendChild(emojiDiv);
            });
        }

        // æ·»åŠ emojiè¾“å…¥æ¡†
        function addEmoji(itemId) {
            const item = items.find(i => i.id === itemId);
            if (item) {
                item.emojis.push("");
                renderConfig();
            }
        }

        // æ¸²æŸ“è£…é¥°emojiåˆ—è¡¨
        function renderDecorativeEmojis(itemId, decorativeEmojis) {
            const container = document.getElementById(`decorative-emojis-${itemId}`);
            if (!container) return;
            container.innerHTML = '';

            decorativeEmojis.forEach((deco, index) => {
                const emojiDiv = document.createElement('div');
                emojiDiv.className = 'emoji-display';
                emojiDiv.style.display = 'flex';
                emojiDiv.style.alignItems = 'center';
                emojiDiv.style.marginBottom = '8px';
                emojiDiv.style.gap = '8px';

                const input = document.createElement('input');
                input.type = 'text';
                input.value = deco.emoji;
                input.placeholder = 'è¾“å…¥emoji';
                input.style.flex = '0 0 60px';
                input.oninput = () => {
                    const item = items.find(i => i.id === itemId);
                    item.decorativeEmojis[index].emoji = input.value;
                    generateAllVersions();
                };

                const sizeLabel = document.createElement('span');
                sizeLabel.textContent = `${deco.fontSize || 32}px`;
                sizeLabel.style.minWidth = '40px';
                sizeLabel.style.fontSize = '12px';

                const sizeSlider = document.createElement('input');
                sizeSlider.type = 'range';
                sizeSlider.min = '16';
                sizeSlider.max = '80';
                sizeSlider.value = deco.fontSize || 32;
                sizeSlider.style.flex = '1';
                sizeSlider.oninput = () => {
                    const item = items.find(i => i.id === itemId);
                    item.decorativeEmojis[index].fontSize = parseInt(sizeSlider.value);
                    sizeLabel.textContent = sizeSlider.value + 'px';
                    generateAllVersions();
                };

                const pickBtn = document.createElement('button');
                pickBtn.className = 'btn-pick-emoji';
                pickBtn.textContent = 'é€‰æ‹©';
                pickBtn.onclick = () => openEmojiPicker(itemId, index, 'decorativeEmojis');

                const removeBtn = document.createElement('button');
                removeBtn.className = 'btn-remove-emoji';
                removeBtn.textContent = 'Ã—';
                removeBtn.onclick = () => {
                    const item = items.find(i => i.id === itemId);
                    item.decorativeEmojis.splice(index, 1);
                    renderConfig();
                    generateAllVersions();
                };

                emojiDiv.appendChild(input);
                emojiDiv.appendChild(sizeLabel);
                emojiDiv.appendChild(sizeSlider);
                emojiDiv.appendChild(pickBtn);
                emojiDiv.appendChild(removeBtn);
                container.appendChild(emojiDiv);
            });
        }

        // æ·»åŠ è£…é¥°emoji
        function addDecorativeEmoji(itemId) {
            const item = items.find(i => i.id === itemId);
            if (item) {
                if (!item.decorativeEmojis) {
                    item.decorativeEmojis = [];
                }
                item.decorativeEmojis.push({
                    emoji: 'âœ¨',
                    x: 50, // ç™¾åˆ†æ¯”
                    y: 50, // ç™¾åˆ†æ¯”
                    fontSize: 32
                });
                renderConfig();
                generateAllVersions();
            }
        }

        // æ›´æ–°å¯¹æ¯”é¡¹é…ç½®
        function updateItem(id, field, value) {
            const item = items.find(i => i.id === id);
            if (item) {
                item[field] = value;
                // é‡æ–°æ¸²æŸ“ç¼–è¾‘é¢æ¿ä»¥æ›´æ–°é€‰ä¸­çŠ¶æ€
                if (selectedItemId === id) {
                    renderEditPanel(id);
                }
            }
        }

        // ========== å†å²è®°å½•ç®¡ç† ==========

        // ä¿å­˜å½“å‰çŠ¶æ€åˆ°å†å²è®°å½•
        function saveHistory() {
            if (isRestoringHistory) return;

            // ç§»é™¤å½“å‰ç´¢å¼•ä¹‹åçš„æ‰€æœ‰å†å²è®°å½•
            history = history.slice(0, historyIndex + 1);

            // æ·±æ‹·è´å½“å‰çŠ¶æ€
            const state = {
                items: JSON.parse(JSON.stringify(items)),
                allVersions: JSON.parse(JSON.stringify(allVersions)),
                currentVersion: currentVersion,
                configName: configName
            };

            history.push(state);
            historyIndex++;

            // é™åˆ¶å†å²è®°å½•æ•°é‡ï¼ˆä¿ç•™æœ€è¿‘50ä¸ªï¼‰
            if (history.length > 50) {
                history.shift();
                historyIndex--;
            }

            updateHistoryButtons();
        }

        // æ›´æ–°å†å²è®°å½•æŒ‰é’®çŠ¶æ€
        function updateHistoryButtons() {
            const undoBtn = document.getElementById('undoBtn');
            const redoBtn = document.getElementById('redoBtn');

            if (undoBtn) undoBtn.disabled = historyIndex <= 0;
            if (redoBtn) redoBtn.disabled = historyIndex >= history.length - 1;
        }

        // æ’¤é”€
        function undo() {
            if (historyIndex > 0) {
                historyIndex--;
                restoreHistoryState(history[historyIndex]);
            }
        }

        // é‡åš
        function redo() {
            if (historyIndex < history.length - 1) {
                historyIndex++;
                restoreHistoryState(history[historyIndex]);
            }
        }

        // æ¢å¤å†å²çŠ¶æ€
        function restoreHistoryState(state) {
            isRestoringHistory = true;

            items = JSON.parse(JSON.stringify(state.items));
            allVersions = JSON.parse(JSON.stringify(state.allVersions));
            currentVersion = state.currentVersion;
            configName = state.configName;

            document.getElementById('configName').value = configName;
            renderConfig();
            updatePreview();
            updateHistoryButtons();

            isRestoringHistory = false;
        }

        // ========== å¤åˆ¶æ–‡æœ¬æ¡†åŠŸèƒ½ ==========

        function duplicateItem(id) {
            const item = items.find(i => i.id === id);
            if (!item) return;

            // æ·±æ‹·è´å…ƒç´ 
            const newItem = JSON.parse(JSON.stringify(item));

            // ç”Ÿæˆæ–°ID
            newItem.id = Date.now();

            // å¦‚æœæœ‰ä½ç½®ä¿¡æ¯ï¼Œç¨å¾®åç§»
            const version = allVersions[currentVersion];
            if (version && version.positions) {
                const oldPos = version.positions[items.indexOf(item)];
                if (oldPos) {
                    // åœ¨å½“å‰ç‰ˆæœ¬çš„positionsä¸­æ·»åŠ æ–°ä½ç½®ï¼ˆåç§»20pxï¼‰
                    version.positions.push({
                        x: oldPos.x + 20,
                        y: oldPos.y + 20
                    });
                }
            }

            // æ·»åŠ åˆ°itemsæ•°ç»„
            items.push(newItem);

            saveHistory();
            selectItem(newItem.id);  // è‡ªåŠ¨é€‰ä¸­æ–°å…ƒç´ 
            generateAllVersions();
        }

        // ========== è‡ªåŠ¨æ’ç‰ˆåŠŸèƒ½ ==========

        function autoLayout() {
            if (items.length === 0) return;

            // è·å–å½“å‰ç‰ˆæœ¬
            const version = allVersions[currentVersion];
            if (!version || !version.positions) return;

            // æŒ‰ç…§æ–‡æœ¬æ¡†å†…å®¹é•¿åº¦æ’åº
            const sortedItems = items.map((item, index) => ({
                item,
                index,
                contentLength: (item.boxContent || item.title || '').length
            })).sort((a, b) => b.contentLength - a.contentLength);

            // è®¾ç½®å¸ƒå±€å‚æ•°
            const startX = 100; // å·¦å¯¹é½çš„Xåæ ‡
            const startY = 100; // èµ·å§‹Yåæ ‡
            const spacing = 150; // å…ƒç´ é—´è·

            // é‡æ–°å®šä½æ‰€æœ‰å…ƒç´ 
            sortedItems.forEach((sortedItem, layoutIndex) => {
                const posIndex = sortedItem.index;
                if (version.positions[posIndex]) {
                    version.positions[posIndex].x = startX;
                    version.positions[posIndex].y = startY + (layoutIndex * spacing);
                }
            });

            saveHistory();
            updatePreview();
        }

        // ========== å¯¹é½çº¿åŠŸèƒ½ ==========

        // æ˜¾ç¤ºå¯¹é½çº¿
        function showAlignmentGuides(currentElement, currentPos) {
            // ç§»é™¤ç°æœ‰å¯¹é½çº¿
            removeAlignmentGuides();

            const container = document.getElementById('previewContainer');
            const version = allVersions[currentVersion];
            if (!version || !version.positions) return;

            const currentRect = currentElement.getBoundingClientRect();
            const containerRect = container.getBoundingClientRect();

            // å­˜å‚¨æœ€è¿‘çš„å¯¹é½ä½ç½®
            let nearestVertical = null;
            let nearestHorizontal = null;
            let minVerticalDiff = alignmentThreshold;
            let minHorizontalDiff = alignmentThreshold;

            // æ£€æŸ¥ä¸å…¶ä»–å…ƒç´ çš„å¯¹é½
            Object.entries(version.positions).forEach(([index, pos]) => {
                const indexNum = parseInt(index);
                const otherElement = container.querySelector(`[data-item-index="${indexNum}"]`);
                if (!otherElement || otherElement === currentElement) return;

                const otherRect = otherElement.getBoundingClientRect();

                // æ£€æŸ¥å‚ç›´å¯¹é½ï¼ˆå·¦è¾¹ã€ä¸­å¿ƒã€å³è¾¹ï¼‰
                const leftDiff = Math.abs(currentPos.x - pos.x);
                const centerCurrentX = currentPos.x + currentRect.width / 2;
                const centerOtherX = pos.x + otherRect.width / 2;
                const centerDiff = Math.abs(centerCurrentX - centerOtherX);
                const rightCurrentX = currentPos.x + currentRect.width;
                const rightOtherX = pos.x + otherRect.width;
                const rightDiff = Math.abs(rightCurrentX - rightOtherX);

                // æ‰¾åˆ°æœ€è¿‘çš„å‚ç›´å¯¹é½
                if (leftDiff < minVerticalDiff) {
                    minVerticalDiff = leftDiff;
                    nearestVertical = { type: 'left', position: pos.x, snapX: pos.x };
                }
                if (centerDiff < minVerticalDiff) {
                    minVerticalDiff = centerDiff;
                    nearestVertical = { type: 'center', position: centerOtherX, snapX: centerOtherX - currentRect.width / 2 };
                }
                if (rightDiff < minVerticalDiff) {
                    minVerticalDiff = rightDiff;
                    nearestVertical = { type: 'right', position: rightOtherX, snapX: rightOtherX - currentRect.width };
                }

                // æ£€æŸ¥æ°´å¹³å¯¹é½ï¼ˆé¡¶éƒ¨ã€ä¸­å¿ƒã€åº•éƒ¨ï¼‰
                const topDiff = Math.abs(currentPos.y - pos.y);
                const centerCurrentY = currentPos.y + currentRect.height / 2;
                const centerOtherY = pos.y + otherRect.height / 2;
                const centerYDiff = Math.abs(centerCurrentY - centerOtherY);
                const bottomCurrentY = currentPos.y + currentRect.height;
                const bottomOtherY = pos.y + otherRect.height;
                const bottomDiff = Math.abs(bottomCurrentY - bottomOtherY);

                // æ‰¾åˆ°æœ€è¿‘çš„æ°´å¹³å¯¹é½
                if (topDiff < minHorizontalDiff) {
                    minHorizontalDiff = topDiff;
                    nearestHorizontal = { type: 'top', position: pos.y, snapY: pos.y };
                }
                if (centerYDiff < minHorizontalDiff) {
                    minHorizontalDiff = centerYDiff;
                    nearestHorizontal = { type: 'center', position: centerOtherY, snapY: centerOtherY - currentRect.height / 2 };
                }
                if (bottomDiff < minHorizontalDiff) {
                    minHorizontalDiff = bottomDiff;
                    nearestHorizontal = { type: 'bottom', position: bottomOtherY, snapY: bottomOtherY - currentRect.height };
                }
            });

            // æ˜¾ç¤ºå¯¹é½çº¿ï¼Œæ ¹æ®è®¾ç½®å†³å®šæ˜¯å¦å¸é™„
            if (nearestVertical) {
                createAlignmentGuide('vertical', nearestVertical.position);
                if (enableAlignmentSnap) {
                    currentPos.x = nearestVertical.snapX;
                }
            }
            if (nearestHorizontal) {
                createAlignmentGuide('horizontal', nearestHorizontal.position);
                if (enableAlignmentSnap) {
                    currentPos.y = nearestHorizontal.snapY;
                }
            }
        }

        // åˆ›å»ºå¯¹é½çº¿
        function createAlignmentGuide(type, position) {
            const container = document.getElementById('previewContainer');
            const guide = document.createElement('div');
            guide.className = `alignment-guide ${type}`;
            guide.style[type === 'vertical' ? 'left' : 'top'] = position + 'px';
            container.appendChild(guide);
        }

        // ç§»é™¤å¯¹é½çº¿
        function removeAlignmentGuides() {
            const guides = document.querySelectorAll('.alignment-guide');
            guides.forEach(guide => guide.remove());
        }

        // è§£æMarkdownæ ·å¼æ ‡è®°å¹¶è½¬æ¢ä¸ºHTML
        function parseTextStyles(text) {
            if (!text) return '';
            
            // å…ˆè½¬ä¹‰HTMLç‰¹æ®Šå­—ç¬¦
            let html = text
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;');
            
            // Markdownè¯­æ³•è§£æï¼ˆæŒ‰ä¼˜å…ˆçº§é¡ºåºï¼‰
            
            // 1. ä»£ç å—ï¼ˆåå¼•å·ï¼‰- æœ€é«˜ä¼˜å…ˆçº§
            html = html.replace(/`([^`]+)`/g, '<code style="background-color: rgba(0,0,0,0.1); padding: 2px 4px; border-radius: 3px; font-family: monospace;">$1</code>');
            
            // 2. åˆ é™¤çº¿ï¼ˆ~~æ–‡å­—~~ï¼‰- åœ¨åŠ ç²—/æ–œä½“ä¹‹å‰å¤„ç†
            html = html.replace(/~~([^~]+)~~/g, '<s>$1</s>');
            
            // 3. åŠ ç²—ï¼ˆ**æ–‡å­—** æˆ– __æ–‡å­—__ï¼‰- åœ¨æ–œä½“ä¹‹å‰å¤„ç†
            html = html.replace(/\*\*([^*]+)\*\*/g, '<strong>$1</strong>');
            html = html.replace(/__([^_]+)__/g, '<strong>$1</strong>');
            
            // 4. æ–œä½“ï¼ˆ*æ–‡å­—* æˆ– _æ–‡å­—_ï¼‰- é¿å…ä¸åŠ ç²—å†²çª
            // åŒ¹é…å•æ˜Ÿå·ï¼ˆå‰åä¸æ˜¯æ˜Ÿå·ï¼‰
            html = html.replace(/([^*]|^)\*([^*\n]+?)\*([^*]|$)/g, '$1<em>$2</em>$3');
            // åŒ¹é…å•ä¸‹åˆ’çº¿ï¼ˆå‰åä¸æ˜¯ä¸‹åˆ’çº¿ï¼Œä¸”ä¸åœ¨å•è¯ä¸­é—´ï¼‰
            html = html.replace(/([^_]|^)_([^_\n]+?)_([^_]|$)/g, '$1<em>$2</em>$3');
            
            // 5. é«˜äº®ï¼ˆ==æ–‡å­—==ï¼‰
            html = html.replace(/==([^=]+)==/g, '<span style="background-color: #ffff00; padding: 2px 4px; border-radius: 3px;">$1</span>');

            // 6. å­—ä½“æè¾¹ï¼ˆ[stroke]æ–‡å­—[/stroke]ï¼‰
            html = html.replace(/\[stroke\](.*?)\[\/stroke\]/gs,
                '<span style="-webkit-text-stroke: 2px #000000; paint-order: stroke fill;">$1</span>');

            // 7. è‡ªå®šä¹‰é¢œè‰²ï¼ˆ[color:#ff0000]æ–‡å­—[/color] - ä¿ç•™å‘åå…¼å®¹ï¼‰
            html = html.replace(/\[color:(#[0-9a-fA-F]{6}|#[0-9a-fA-F]{3}|[a-zA-Z]+)\](.*?)\[\/color\]/gs,
                '<span style="color: $1;">$2</span>');

            // 8. è‡ªå®šä¹‰é«˜äº®ï¼ˆ[highlight:#ffff00]æ–‡å­—[/highlight] - ä¿ç•™å‘åå…¼å®¹ï¼‰
            html = html.replace(/\[highlight:(#[0-9a-fA-F]{6}|#[0-9a-fA-F]{3}|[a-zA-Z]+)\](.*?)\[\/highlight\]/gs,
                '<span style="background-color: $1; padding: 2px 4px; border-radius: 3px;">$2</span>');

            // 9. è‡ªå®šä¹‰æ ·å¼ï¼ˆ[style:...]æ–‡å­—[/style] - ä¿ç•™å‘åå…¼å®¹ï¼‰
            html = html.replace(/\[style:(.*?)\](.*?)\[\/style\]/gs, 
                '<span style="$1">$2</span>');
            
            return html;
        }

        // æ›´æ–°é¢„è§ˆ
        function updatePreview() {
            const container = document.getElementById('previewContainer');
            const versionButtons = document.getElementById('versionButtons');

            if (items.length === 0 || allVersions.length === 0) {
                container.innerHTML = '<div class="empty-state">æ·»åŠ å¯¹æ¯”é¡¹å¼€å§‹é…ç½®</div>';
                versionButtons.innerHTML = '';
                return;
            }

            // æ›´æ–°ç‰ˆæœ¬æŒ‰é’®
            versionButtons.innerHTML = '';
            for (let i = 0; i < allVersions.length; i++) {
                const btn = document.createElement('button');
                btn.className = 'version-btn';
                btn.textContent = allVersions[i].name || `ç‰ˆæœ¬ ${i + 1}`;
                btn.onclick = () => switchVersion(i);
                if (i === currentVersion) {
                    btn.classList.add('active');
                }
                
                // æ·»åŠ åˆ é™¤æŒ‰é’®
                const deleteBtn = document.createElement('button');
                deleteBtn.className = 'btn-delete-version';
                deleteBtn.textContent = 'Ã—';
                deleteBtn.onclick = (e) => {
                    e.stopPropagation();
                    deleteVersion(i);
                };
                btn.appendChild(deleteBtn);
                
                versionButtons.appendChild(btn);
            }
            
            // æ·»åŠ "æ–°å¢ç‰ˆæœ¬"æŒ‰é’®
            const addBtn = document.createElement('button');
            addBtn.className = 'btn-add-version';
            addBtn.textContent = '+ æ–°å¢ç‰ˆæœ¬';
            addBtn.onclick = addVersion;
            versionButtons.appendChild(addBtn);

            // æ›´æ–°é¢„è§ˆå®¹å™¨
            let previewDiv = document.getElementById('previewContainer');
            if (!previewDiv) {
                previewDiv = document.createElement('div');
                previewDiv.className = 'comparison-container';
                previewDiv.id = 'previewContainer';
                container.innerHTML = '';
                container.appendChild(previewDiv);
            } else {
                previewDiv.className = 'comparison-container';
                previewDiv.innerHTML = '';
            }

            const currentVersionData = allVersions[currentVersion];
            const positions = currentVersionData.positions || {};
            
            items.forEach((item, itemIndex) => {
                const itemDiv = document.createElement('div');
                itemDiv.className = 'comparison-item draggable';
                itemDiv.dataset.itemIndex = itemIndex;

                // æ·»åŠ é€‰ä¸­æ ·å¼
                if (item.id === selectedItemId) {
                    itemDiv.classList.add('selected');
                }

                // ç‚¹å‡»å…ƒç´ æ—¶é€‰ä¸­
                itemDiv.onclick = (e) => {
                    if (!e.target.closest('.item-action-btn') && !e.target.closest('button')) {
                        selectItem(item.id);
                        // æ›´æ–°æ‰€æœ‰ç”»å¸ƒå…ƒç´ çš„é€‰ä¸­çŠ¶æ€
                        document.querySelectorAll('.comparison-item').forEach(el => el.classList.remove('selected'));
                        itemDiv.classList.add('selected');
                    }
                };

                // è®¾ç½®ä½ç½®
                const pos = positions[itemIndex] || {};
                if (pos.x !== undefined && pos.y !== undefined) {
                    itemDiv.style.left = pos.x + 'px';
                    itemDiv.style.top = pos.y + 'px';
                } else {
                    // é»˜è®¤ä½ç½®ï¼ˆæ¨ªå‘å¸ƒå±€ï¼‰
                    // æ ¹æ®æ˜¯å¦æœ‰æ ‡é¢˜/å‰¯æ ‡é¢˜è°ƒæ•´é—´è·
                    const hasTitle = items.some(it => it.title || it.subtitle);
                    const horizontalSpacing = hasTitle ? 280 : 220;

                    itemDiv.style.left = (itemIndex * horizontalSpacing + 50) + 'px';
                    itemDiv.style.top = '50%';
                    itemDiv.style.transform = 'translateY(-50%)';
                }

                if (item.displayStyle === 'icon') {
                    // è·å–è¯¥itemçš„æ‰€æœ‰éç©ºemoji
                    const emojis = (item.emojis || ['']).filter(e => e.trim());
                    const emojiCount = emojis.length || 1;
                    const emojisHTML = emojis.length > 0
                        ? emojis.map(e => `<span class="emoji-item">${e}</span>`).join('')
                        : '<span class="emoji-item"></span>';

                    const hasText = item.title || item.subtitle;
                    itemDiv.innerHTML = `
                        <div class="item-actions">
                            <button class="item-action-btn edit" onclick="openItemEditor(${item.id}); event.stopPropagation();" title="ç¼–è¾‘">âœï¸</button>
                            <button class="item-action-btn delete" onclick="deleteItemFromCanvas(${item.id}); event.stopPropagation();" title="åˆ é™¤">ğŸ—‘ï¸</button>
                        </div>
                        <div class="icon-container ${item.shape}" style="background-color: ${item.color}" data-emoji-count="${emojiCount}">
                            ${emojisHTML}
                        </div>
                        ${hasText ? `<div class="text-content">
                            ${item.title ? `<div class="title">${item.title}</div>` : ''}
                            ${item.subtitle ? `<div class="subtitle">${item.subtitle}</div>` : ''}
                        </div>` : ''}
                    `;
                } else {
                    const externalEmojis = item.externalEmojis || [];
                    const distance = item.externalEmojiDistance || 65;
                    const styledContent = parseTextStyles(item.boxContent || 'æ–‡æœ¬æ¡†å†…å®¹');
                    const hasText = item.title || item.subtitle;

                    const externalEmojisHTML = externalEmojis.length > 0 ? `
                        <div class="external-emojis-container ${item.externalEmojiPosition}" style="${
                            item.externalEmojiPosition === 'top' ? `top: -${distance}px;` :
                            item.externalEmojiPosition === 'bottom' ? `bottom: -${distance}px;` :
                            item.externalEmojiPosition === 'left' ? `left: -${distance}px;` :
                            `right: -${distance}px;`
                        }">
                            ${externalEmojis.map(emoji => `<span class="external-emoji-item">${emoji}</span>`).join('')}
                        </div>
                    ` : '';

                    const decorativeEmojis = item.decorativeEmojis || [];
                    const decorativeEmojisHTML = decorativeEmojis.map((deco, decoIndex) => `
                        <span class="decorative-emoji"
                              data-item-id="${item.id}"
                              data-deco-index="${decoIndex}"
                              style="position: absolute; left: ${deco.x}%; top: ${deco.y}%; transform: translate(-50%, -50%); font-size: ${deco.fontSize || 32}px; cursor: move; user-select: none; z-index: 10;">
                            ${deco.emoji}
                        </span>
                    `).join('');

                    itemDiv.innerHTML = `
                        <div class="item-actions">
                            <button class="item-action-btn add-sticker" onclick="addDecorativeStickerToCanvas(${item.id}); event.stopPropagation();" title="æ·»åŠ è´´çº¸">â•</button>
                            <button class="item-action-btn edit" onclick="selectItem(${item.id}); event.stopPropagation();" title="ç¼–è¾‘">âœï¸</button>
                            <button class="item-action-btn delete" onclick="deleteItemFromCanvas(${item.id}); event.stopPropagation();" title="åˆ é™¤">ğŸ—‘ï¸</button>
                        </div>
                        <div class="text-box-container ${item.id === selectedItemId ? 'selected' : ''}" id="text-box-container-${item.id}" style="position: relative;">
                            ${externalEmojisHTML}
                            <div class="text-box ${item.boxStyle}" style="background-color: ${item.color}; color: white; ${item.customWidth ? 'width: ' + item.customWidth + 'px;' : ''}">
                                ${styledContent}
                            </div>
                            <div class="text-box-resize-handle e" data-item-id="${item.id}" data-direction="e"></div>
                            <div class="text-box-resize-handle s" data-item-id="${item.id}" data-direction="s"></div>
                            <div class="text-box-resize-handle se" data-item-id="${item.id}" data-direction="se"></div>
                        </div>
                        ${hasText ? `<div class="text-content">
                            ${item.title ? `<div class="title">${item.title}</div>` : ''}
                            ${item.subtitle ? `<div class="subtitle">${item.subtitle}</div>` : ''}
                        </div>` : ''}
                    `;
                }

                // æ·»åŠ æ‹–æ‹½äº‹ä»¶
                itemDiv.addEventListener('mousedown', (e) => startDrag(e, itemIndex));

                previewDiv.appendChild(itemDiv);

                // æ¸²æŸ“è£…é¥°emoji
                if (item.displayStyle === 'textbox' && item.decorativeEmojis && item.decorativeEmojis.length > 0) {
                    const container = itemDiv.querySelector('.text-box-container');
                    if (container) {
                        renderCanvasDecorativeEmojis(item.id, item.decorativeEmojis, container);
                    }
                }

                // ä¸ºæ–‡æœ¬æ¡†è°ƒæ•´æ‰‹æŸ„æ·»åŠ äº‹ä»¶
                if (item.displayStyle === 'textbox') {
                    const resizeHandles = itemDiv.querySelectorAll('.text-box-resize-handle');
                    resizeHandles.forEach(handle => {
                        handle.addEventListener('mousedown', (e) => {
                            e.stopPropagation();
                            startTextBoxResize(e, item.id, handle.dataset.direction);
                        });
                    });
                }
            });

            // ç‚¹å‡»ç©ºç™½å¤„å–æ¶ˆé€‰ä¸­
            previewDiv.onclick = (e) => {
                if (e.target === previewDiv || e.target.classList.contains('comparison-container')) {
                    selectedItemId = null;
                    selectedDecorativeEmoji = null;
                    renderElementList();
                    renderEditPanel(null);
                    updatePreview();
                }
            };
        }

        // å¼€å§‹è°ƒæ•´æ–‡æœ¬æ¡†å¤§å°
        function startTextBoxResize(e, itemId, direction) {
            e.preventDefault();
            e.stopPropagation();

            const item = items.find(i => i.id === itemId);
            if (!item) return;

            const textBoxContainer = document.getElementById(`text-box-container-${itemId}`);
            const textBox = textBoxContainer?.querySelector('.text-box');
            if (!textBox) return;

            const rect = textBox.getBoundingClientRect();

            resizingTextBox = {
                itemId,
                direction,
                initialWidth: item.customWidth || rect.width,
                initialHeight: item.customHeight || rect.height,
                initialX: e.clientX,
                initialY: e.clientY
            };

            document.addEventListener('mousemove', handleTextBoxResize);
            document.addEventListener('mouseup', stopTextBoxResize);
        }

        // å¤„ç†æ–‡æœ¬æ¡†å¤§å°è°ƒæ•´
        function handleTextBoxResize(e) {
            if (!resizingTextBox) return;

            const { itemId, direction, initialWidth, initialHeight, initialX, initialY } = resizingTextBox;
            const item = items.find(i => i.id === itemId);
            if (!item) return;

            const deltaX = e.clientX - initialX;
            const deltaY = e.clientY - initialY;

            let newWidth = initialWidth;
            let newHeight = initialHeight;

            // æ ¹æ®æ–¹å‘è°ƒæ•´å¤§å°
            if (direction.includes('e')) {
                newWidth = initialWidth + deltaX;
            }
            if (direction.includes('s')) {
                newHeight = initialHeight + deltaY;
            }

            // æœ€å°å°ºå¯¸é™åˆ¶
            newWidth = Math.max(100, newWidth);
            newHeight = Math.max(50, newHeight);

            // ä¿å­˜åˆ°item
            if (!item.customWidth) item.customWidth = initialWidth;
            if (!item.customHeight) item.customHeight = initialHeight;

            item.customWidth = Math.round(newWidth);
            item.customHeight = Math.round(newHeight);

            // å®æ—¶æ›´æ–°æ˜¾ç¤º
            const textBox = document.querySelector(`#text-box-container-${itemId} .text-box`);
            if (textBox) {
                textBox.style.width = newWidth + 'px';
                if (direction.includes('s')) {
                    textBox.style.minHeight = newHeight + 'px';
                }
            }
        }

        // åœæ­¢æ–‡æœ¬æ¡†å¤§å°è°ƒæ•´
        function stopTextBoxResize() {
            if (resizingTextBox) {
                saveHistory();
                renderElementList();
                renderEditPanel(selectedItemId);
            }
            resizingTextBox = null;
            document.removeEventListener('mousemove', handleTextBoxResize);
            document.removeEventListener('mouseup', stopTextBoxResize);
        }

        // åœ¨ç”»å¸ƒä¸Šæ¸²æŸ“è£…é¥°emoji
        function renderCanvasDecorativeEmojis(itemId, decorativeEmojis, container) {
            // æ¸…é™¤ç°æœ‰çš„è£…é¥°emoji
            const existing = container.querySelectorAll('.decorative-emoji-item');
            existing.forEach(el => el.remove());

            decorativeEmojis.forEach((deco, decoIndex) => {
                const emojiDiv = document.createElement('div');
                emojiDiv.className = 'decorative-emoji-item';
                emojiDiv.dataset.itemId = itemId;
                emojiDiv.dataset.decoIndex = decoIndex;
                emojiDiv.style.left = (deco.x || 0) + 'px';
                emojiDiv.style.top = (deco.y || 0) + 'px';
                emojiDiv.style.fontSize = (deco.fontSize || 32) + 'px';

                // æ£€æŸ¥æ˜¯å¦é€‰ä¸­
                if (selectedDecorativeEmoji &&
                    selectedDecorativeEmoji.itemId === itemId &&
                    selectedDecorativeEmoji.decoIndex === decoIndex) {
                    emojiDiv.classList.add('selected');
                }

                emojiDiv.innerHTML = `
                    ${deco.emoji}
                    <button class="decorative-emoji-delete" onclick="removeDecorativeEmoji(${itemId}, ${decoIndex}); event.stopPropagation();">Ã—</button>
                    <div class="resize-handle se" data-item-id="${itemId}" data-deco-index="${decoIndex}"></div>
                `;

                // ç‚¹å‡»é€‰ä¸­
                emojiDiv.addEventListener('click', (e) => {
                    e.stopPropagation();
                    if (!e.target.closest('.decorative-emoji-delete') && !e.target.closest('.resize-handle')) {
                        selectDecorativeEmoji(itemId, decoIndex);
                    }
                });

                // æ·»åŠ æ‹–æ‹½äº‹ä»¶
                emojiDiv.addEventListener('mousedown', (e) => {
                    if (!e.target.closest('.decorative-emoji-delete') && !e.target.closest('.resize-handle')) {
                        startDecorativeEmojiDrag(e, itemId, decoIndex);
                    }
                });

                // è°ƒæ•´å¤§å°æ‰‹æŸ„äº‹ä»¶
                const resizeHandle = emojiDiv.querySelector('.resize-handle');
                if (resizeHandle) {
                    resizeHandle.addEventListener('mousedown', (e) => {
                        e.stopPropagation();
                        startEmojiResize(e, itemId, decoIndex);
                    });
                }

                container.appendChild(emojiDiv);
            });
        }

        // é€‰ä¸­è£…é¥°emoji
        function selectDecorativeEmoji(itemId, decoIndex) {
            selectedDecorativeEmoji = { itemId, decoIndex };
            updatePreview();
        }

        // å¼€å§‹è°ƒæ•´emojiå¤§å°
        function startEmojiResize(e, itemId, decoIndex) {
            e.preventDefault();
            e.stopPropagation();

            const item = items.find(i => i.id === itemId);
            if (!item || !item.decorativeEmojis[decoIndex]) return;

            resizingEmoji = {
                itemId,
                decoIndex,
                initialSize: item.decorativeEmojis[decoIndex].fontSize || 32,
                initialX: e.clientX,
                initialY: e.clientY
            };

            document.addEventListener('mousemove', handleEmojiResize);
            document.addEventListener('mouseup', stopEmojiResize);
        }

        // å¤„ç†emojiå¤§å°è°ƒæ•´
        function handleEmojiResize(e) {
            if (!resizingEmoji) return;

            const { itemId, decoIndex, initialSize, initialX, initialY } = resizingEmoji;
            const item = items.find(i => i.id === itemId);
            if (!item || !item.decorativeEmojis[decoIndex]) return;

            // è®¡ç®—é¼ æ ‡ç§»åŠ¨çš„è·ç¦»ï¼ˆå¯¹è§’çº¿ï¼‰
            const deltaX = e.clientX - initialX;
            const deltaY = e.clientY - initialY;
            const delta = (deltaX + deltaY) / 2; // å¹³å‡å€¼

            // æ–°çš„å¤§å°ï¼ˆæœ€å°16pxï¼Œæœ€å¤§128pxï¼‰
            let newSize = initialSize + delta;
            newSize = Math.max(16, Math.min(128, newSize));

            item.decorativeEmojis[decoIndex].fontSize = Math.round(newSize);

            // å®æ—¶æ›´æ–°æ˜¾ç¤º
            const emojiElement = document.querySelector(`.decorative-emoji-item[data-item-id="${itemId}"][data-deco-index="${decoIndex}"]`);
            if (emojiElement) {
                emojiElement.style.fontSize = newSize + 'px';
            }
        }

        // åœæ­¢emojiå¤§å°è°ƒæ•´
        function stopEmojiResize() {
            if (resizingEmoji) {
                saveHistory();
                renderElementList();
                renderEditPanel(selectedItemId);
            }
            resizingEmoji = null;
            document.removeEventListener('mousemove', handleEmojiResize);
            document.removeEventListener('mouseup', stopEmojiResize);
        }

        // æ·»åŠ è£…é¥°è´´çº¸åˆ°ç”»å¸ƒ
        function addDecorativeStickerToCanvas(itemId) {
            openEmojiPicker(itemId, null, 'decorativeSticker');
        }

        // ç§»é™¤è£…é¥°emoji
        function removeDecorativeEmoji(itemId, decoIndex) {
            const item = items.find(i => i.id === itemId);
            if (item && item.decorativeEmojis) {
                item.decorativeEmojis.splice(decoIndex, 1);
                saveHistory();
                updatePreview();
                renderElementList();
                renderEditPanel(selectedItemId);
            }
        }

        // å¼€å§‹æ‹–æ‹½
        function startDrag(e, itemIndex) {
            // å¦‚æœç‚¹å‡»çš„æ˜¯æŒ‰é’®ï¼Œä¸è§¦å‘æ‹–æ‹½
            if (e.target.closest('.item-action-btn') || e.target.closest('button')) {
                return;
            }

            e.preventDefault();
            const item = e.currentTarget;
            const rect = item.getBoundingClientRect();
            const containerRect = item.parentElement.getBoundingClientRect();

            dragOffset.x = e.clientX - rect.left;
            dragOffset.y = e.clientY - rect.top;
            draggedPreviewItem = itemIndex;

            item.classList.add('dragging');
            item.style.zIndex = '1000';

            document.addEventListener('mousemove', handleDragMove);
            document.addEventListener('mouseup', stopDrag);
        }

        // æ‹–æ‹½ç§»åŠ¨
        function handleDragMove(e) {
            if (draggedPreviewItem === null) return;

            const item = document.querySelector(`[data-item-index="${draggedPreviewItem}"]`);
            if (!item) return;

            const container = item.parentElement;
            const containerRect = container.getBoundingClientRect();

            let x = e.clientX - containerRect.left - dragOffset.x;
            let y = e.clientY - containerRect.top - dragOffset.y;

            // é™åˆ¶åœ¨å®¹å™¨å†…
            const itemRect = item.getBoundingClientRect();
            x = Math.max(0, Math.min(x, containerRect.width - itemRect.width));
            y = Math.max(0, Math.min(y, containerRect.height - itemRect.height));

            // æ˜¾ç¤ºå¯¹é½çº¿ï¼Œå¦‚æœå¯ç”¨å¸é™„åˆ™è‡ªåŠ¨å¯¹é½
            const currentPos = { x, y };
            showAlignmentGuides(item, currentPos);
            if (enableAlignmentSnap) {
                x = currentPos.x;
                y = currentPos.y;
            }

            item.style.left = x + 'px';
            item.style.top = y + 'px';
            item.style.transform = 'none';

            // ä¿å­˜ä½ç½®
            if (!allVersions[currentVersion].positions) {
                allVersions[currentVersion].positions = {};
            }
            allVersions[currentVersion].positions[draggedPreviewItem] = { x, y };
        }

        // åœæ­¢æ‹–æ‹½
        function stopDrag() {
            if (draggedPreviewItem !== null) {
                const item = document.querySelector(`[data-item-index="${draggedPreviewItem}"]`);
                if (item) {
                    item.classList.remove('dragging');
                    item.style.zIndex = '';
                }
                draggedPreviewItem = null;

                // ç§»é™¤å¯¹é½çº¿å¹¶ä¿å­˜å†å²è®°å½•
                removeAlignmentGuides();
                saveHistory();
            }

            document.removeEventListener('mousemove', handleDragMove);
            document.removeEventListener('mouseup', stopDrag);
        }

        // è£…é¥°emojiæ‹–æ‹½ç›¸å…³å˜é‡
        let draggedDecoEmoji = null;
        let decoEmojiDragOffset = { x: 0, y: 0 };

        // å¼€å§‹è£…é¥°emojiæ‹–æ‹½
        function startDecorativeEmojiDrag(e, itemId, decoIndex) {
            e.stopPropagation();
            e.preventDefault();

            const item = items.find(i => i.id === itemId);
            if (!item || !item.decorativeEmojis[decoIndex]) return;

            draggedDecoEmoji = { itemId, decoIndex };

            const emojiElement = e.currentTarget;
            emojiElement.classList.add('dragging');

            // è®°å½•åˆå§‹é¼ æ ‡ä½ç½®
            decoEmojiDragOffset.x = e.clientX;
            decoEmojiDragOffset.y = e.clientY;

            document.addEventListener('mousemove', handleDecoEmojiDragMove);
            document.addEventListener('mouseup', stopDecoEmojiDrag);
        }

        // è£…é¥°emojiæ‹–æ‹½ç§»åŠ¨
        function handleDecoEmojiDragMove(e) {
            if (!draggedDecoEmoji) return;

            const { itemId, decoIndex } = draggedDecoEmoji;
            const item = items.find(i => i.id === itemId);
            if (!item || !item.decorativeEmojis[decoIndex]) return;

            // è®¡ç®—ç§»åŠ¨è·ç¦»
            const deltaX = e.clientX - decoEmojiDragOffset.x;
            const deltaY = e.clientY - decoEmojiDragOffset.y;

            // æ›´æ–°ä½ç½®ï¼ˆåƒç´ ï¼‰
            let newX = (item.decorativeEmojis[decoIndex].x || 0) + deltaX;
            let newY = (item.decorativeEmojis[decoIndex].y || 0) + deltaY;

            // è·å–æ–‡æœ¬æ¡†å®¹å™¨çš„å°ºå¯¸æ¥é™åˆ¶ç§»åŠ¨èŒƒå›´
            const textBoxContainer = document.querySelector(`#text-box-container-${itemId}`);
            if (textBoxContainer) {
                const containerRect = textBoxContainer.getBoundingClientRect();
                const textBox = textBoxContainer.querySelector('.text-box');
                if (textBox) {
                    const textBoxRect = textBox.getBoundingClientRect();
                    const emojiSize = item.decorativeEmojis[decoIndex].fontSize || 32;

                    // è®¡ç®—æ–‡æœ¬æ¡†ç›¸å¯¹äºå®¹å™¨çš„ä½ç½®å’Œå°ºå¯¸
                    const maxX = textBoxRect.width - emojiSize;
                    const maxY = textBoxRect.height - emojiSize;

                    // é™åˆ¶ç§»åŠ¨èŒƒå›´åœ¨æ–‡æœ¬æ¡†å†…
                    newX = Math.max(0, Math.min(maxX, newX));
                    newY = Math.max(0, Math.min(maxY, newY));
                }
            }

            item.decorativeEmojis[decoIndex].x = newX;
            item.decorativeEmojis[decoIndex].y = newY;

            // æ›´æ–°èµ·å§‹ä½ç½®
            decoEmojiDragOffset.x = e.clientX;
            decoEmojiDragOffset.y = e.clientY;

            // å®æ—¶æ›´æ–°ä½ç½®
            const emojiElement = document.querySelector(`.decorative-emoji-item[data-item-id="${itemId}"][data-deco-index="${decoIndex}"]`);
            if (emojiElement) {
                emojiElement.style.left = newX + 'px';
                emojiElement.style.top = newY + 'px';
            }
        }

        // åœæ­¢è£…é¥°emojiæ‹–æ‹½
        function stopDecoEmojiDrag() {
            if (draggedDecoEmoji) {
                // ç§»é™¤draggingæ ·å¼
                const { itemId, decoIndex } = draggedDecoEmoji;
                const emojiElement = document.querySelector(`.decorative-emoji-item[data-item-id="${itemId}"][data-deco-index="${decoIndex}"]`);
                if (emojiElement) {
                    emojiElement.classList.remove('dragging');
                }

                saveHistory();
                renderElementList();
                renderEditPanel(selectedItemId);
            }
            draggedDecoEmoji = null;
            document.removeEventListener('mousemove', handleDecoEmojiDragMove);
            document.removeEventListener('mouseup', stopDecoEmojiDrag);
        }

        // åˆ‡æ¢ç‰ˆæœ¬
        function switchVersion(versionIndex) {
            currentVersion = versionIndex;
            document.querySelectorAll('.version-btn').forEach((btn, index) => {
                if (index === versionIndex) {
                    btn.classList.add('active');
                } else {
                    btn.classList.remove('active');
                }
            });
            updatePreview();
        }

        // ç‚¹å‡»å¼¹çª—å¤–éƒ¨å…³é—­
        document.getElementById('emojiPickerModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeEmojiPicker();
            }
        });

        // ========== ç”»å¸ƒæ“ä½œåŠŸèƒ½ ==========

        // ä»ç”»å¸ƒæ·»åŠ å…ƒç´ 
        function addItemFromCanvas() {
            addItem();
            // æ»šåŠ¨åˆ°é…ç½®é¢æ¿åº•éƒ¨
            const configPanel = document.querySelector('.config-panel');
            if (configPanel) {
                configPanel.scrollTop = configPanel.scrollHeight;
            }
        }

        // ä»ç”»å¸ƒåˆ é™¤å…ƒç´ 
        function deleteItemFromCanvas(itemId) {
            if (confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªå…ƒç´ å—ï¼Ÿ')) {
                deleteItem(itemId);
            }
        }

        // å½“å‰ç¼–è¾‘çš„å…ƒç´ ID
        let currentEditingItemId = null;

        // æ‰“å¼€å…ƒç´ ç¼–è¾‘å™¨
        function openItemEditor(itemId) {
            currentEditingItemId = itemId;
            const item = items.find(i => i.id === itemId);
            if (!item) return;

            const editorContent = document.getElementById('floatingEditorContent');

            // æ¸²æŸ“ç¼–è¾‘å™¨å†…å®¹
            editorContent.innerHTML = `
                <div class="form-group">
                    <label>æ˜¾ç¤ºæ ·å¼</label>
                    <div class="button-group">
                        <button class="option-btn ${item.displayStyle === 'icon' ? 'active' : ''}"
                                data-action="updateEditorItem" data-field="displayStyle" data-value="icon">
                            ğŸ¨ å›¾æ ‡æ ·å¼
                        </button>
                        <button class="option-btn ${item.displayStyle === 'textbox' ? 'active' : ''}"
                                data-action="updateEditorItem" data-field="displayStyle" data-value="textbox">
                            ğŸ’¬ æ–‡æœ¬æ¡†æ ·å¼
                        </button>
                    </div>
                </div>
                <div class="form-group">
                    <label>æ ‡é¢˜ï¼ˆå¯é€‰ï¼‰</label>
                    <input type="text" value="${item.title}" placeholder="ç•™ç©ºåˆ™ä¸æ˜¾ç¤ºæ ‡é¢˜"
                           data-field="title">
                </div>
                <div class="form-group">
                    <label>å‰¯æ ‡é¢˜ï¼ˆå¯é€‰ï¼‰</label>
                    <input type="text" value="${item.subtitle}" placeholder="ç•™ç©ºåˆ™ä¸æ˜¾ç¤ºå‰¯æ ‡é¢˜"
                           data-field="subtitle">
                </div>
                <div class="form-group">
                    <label>é¢œè‰²é¢„è®¾</label>
                    <div style="display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 10px;">
                        ${colorPresets.map(preset => `
                            <button class="color-preset-btn"
                                    style="background: ${preset.bg}; color: ${preset.text}; padding: 6px 12px; border: 2px solid ${item.color === preset.bg ? '#000' : 'transparent'}; border-radius: 6px; cursor: pointer; font-size: 12px; font-weight: 500;"
                                    data-action="updateEditorItem" data-field="color" data-value="${preset.bg}">
                                ${preset.name}
                            </button>
                        `).join('')}
                    </div>
                    <label>è‡ªå®šä¹‰é¢œè‰²</label>
                    <input type="color" value="${item.color}"
                           data-field="color">
                </div>
                ${item.displayStyle === 'icon' ? `
                    <div class="form-group">
                        <label>å½¢çŠ¶</label>
                        <div class="button-group">
                            <button class="option-btn ${item.shape === 'circle' ? 'active' : ''}"
                                    data-action="updateEditorItem" data-field="shape" data-value="circle">
                                â­• åœ†å½¢
                            </button>
                            <button class="option-btn ${item.shape === 'square' ? 'active' : ''}"
                                    data-action="updateEditorItem" data-field="shape" data-value="square">
                                â—»ï¸ æ–¹å½¢
                            </button>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Emoji</label>
                        <div id="editor-emojis-${item.id}"></div>
                        <button class="btn-add-emoji" data-action="addEmojiInEditor">+ æ·»åŠ Emoji</button>
                    </div>
                ` : `
                    <div class="form-group">
                        <label>æ–‡æœ¬æ¡†å†…å®¹</label>
                        <textarea placeholder="è¾“å…¥æ–‡å­—å’Œemoji"
                                  data-field="boxContent"
                                  style="min-height: 80px;">${item.boxContent || ''}</textarea>
                        <div class="style-help">
                            æ”¯æŒMarkdownï¼š<code>**ç²—ä½“**</code> <code>*æ–œä½“*</code> <code>~~åˆ é™¤çº¿~~</code> <code>==é«˜äº®==</code> <code>[stroke]æè¾¹[/stroke]</code>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>æ–‡æœ¬æ¡†æ ·å¼</label>
                        <div class="button-group">
                            <button class="option-btn ${item.boxStyle === 'rounded' ? 'active' : ''}"
                                    data-action="updateEditorItem" data-field="boxStyle" data-value="rounded">
                                â–¢ åœ†è§’çŸ©å½¢
                            </button>
                            <button class="option-btn ${item.boxStyle === 'rectangle' ? 'active' : ''}"
                                    data-action="updateEditorItem" data-field="boxStyle" data-value="rectangle">
                                â–­ é•¿æ–¹å½¢
                            </button>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>æ¡†å¤–Emoji</label>
                        <div id="editor-external-emojis-${item.id}"></div>
                        <button class="btn-add-emoji" data-action="addExternalEmojiInEditor">+ æ·»åŠ æ¡†å¤–Emoji</button>
                    </div>
                    <div class="form-group">
                        <label>æ¡†å¤–Emojiè·ç¦»ï¼š<span id="editor-distance-value-${item.id}">${item.externalEmojiDistance || 65}px</span></label>
                        <input type="range" min="30" max="150" step="5" value="${item.externalEmojiDistance || 65}"
                               style="width: 100%;"
                               data-field="externalEmojiDistance">
                    </div>
                    <div class="form-group">
                        <label>æ¡†å¤–Emojiä½ç½®</label>
                        <div class="button-group">
                            <button class="option-btn ${item.externalEmojiPosition === 'top' ? 'active' : ''}"
                                    data-action="updateEditorItem" data-field="externalEmojiPosition" data-value="top"
                                    style="flex: 0 0 calc(50% - 4px);">
                                â¬†ï¸ ä¸Šæ–¹
                            </button>
                            <button class="option-btn ${item.externalEmojiPosition === 'bottom' ? 'active' : ''}"
                                    data-action="updateEditorItem" data-field="externalEmojiPosition" data-value="bottom"
                                    style="flex: 0 0 calc(50% - 4px);">
                                â¬‡ï¸ ä¸‹æ–¹
                            </button>
                            <button class="option-btn ${item.externalEmojiPosition === 'left' ? 'active' : ''}"
                                    data-action="updateEditorItem" data-field="externalEmojiPosition" data-value="left"
                                    style="flex: 0 0 calc(50% - 4px);">
                                â¬…ï¸ å·¦ä¾§
                            </button>
                            <button class="option-btn ${item.externalEmojiPosition === 'right' ? 'active' : ''}"
                                    data-action="updateEditorItem" data-field="externalEmojiPosition" data-value="right"
                                    style="flex: 0 0 calc(50% - 4px);">
                                â¡ï¸ å³ä¾§
                            </button>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>è£…é¥°Emojiï¼ˆå¯æ‹–æ‹½è°ƒæ•´ä½ç½®å’Œå¤§å°ï¼‰</label>
                        <div id="editor-decorative-emojis-${item.id}"></div>
                        <button class="btn-add-emoji" data-action="addDecorativeEmojiInEditor">+ æ·»åŠ è£…é¥°Emoji</button>
                    </div>
                `}
            `;

            // å¦‚æœæ˜¯å›¾æ ‡æ ·å¼ï¼Œæ¸²æŸ“emojiåˆ—è¡¨
            if (item.displayStyle === 'icon') {
                renderEditorEmojis(item.id, item.emojis);
            } else {
                renderEditorExternalEmojis(item.id, item.externalEmojis || []);
                renderEditorDecorativeEmojis(item.id, item.decorativeEmojis || []);
            }

            // æ·»åŠ äº‹ä»¶å§”æ‰˜ç›‘å¬å™¨
            attachEditorEventListeners();

            // æ˜¾ç¤ºç¼–è¾‘å™¨
            document.getElementById('floatingEditorOverlay').classList.add('show');
            document.getElementById('floatingEditor').classList.add('show');
        }

        // ä¸ºç¼–è¾‘å™¨é™„åŠ äº‹ä»¶ç›‘å¬å™¨
        function attachEditorEventListeners() {
            const editorContent = document.getElementById('floatingEditorContent');

            // ç§»é™¤æ—§çš„ç›‘å¬å™¨ï¼ˆå¦‚æœæœ‰ï¼‰
            const newEditor = editorContent.cloneNode(true);
            editorContent.parentNode.replaceChild(newEditor, editorContent);

            // æŒ‰é’®ç‚¹å‡»äº‹ä»¶å§”æ‰˜
            newEditor.addEventListener('click', function(e) {
                const button = e.target.closest('[data-action]');
                if (!button) return;

                const action = button.dataset.action;
                const field = button.dataset.field;
                const value = button.dataset.value;

                if (action === 'updateEditorItem' && field && value !== undefined) {
                    // æ›´æ–°æŒ‰é’®ç»„çš„activeçŠ¶æ€
                    const buttonGroup = button.closest('.button-group');
                    if (buttonGroup) {
                        buttonGroup.querySelectorAll('.option-btn').forEach(btn => {
                            btn.classList.remove('active');
                        });
                        button.classList.add('active');
                    }

                    updateEditorItem(field, value);
                } else if (action === 'addEmojiInEditor') {
                    addEmojiInEditor();
                } else if (action === 'addExternalEmojiInEditor') {
                    addExternalEmojiInEditor();
                } else if (action === 'addDecorativeEmojiInEditor') {
                    addDecorativeEmojiInEditor();
                } else if (action === 'openEmojiPickerInEditor' && field) {
                    openEmojiPickerInEditor(field);
                }
            });

            // è¾“å…¥æ¡†å’Œæ–‡æœ¬åŸŸçš„changeäº‹ä»¶å§”æ‰˜
            newEditor.addEventListener('change', function(e) {
                const field = e.target.dataset.field;
                if (field) {
                    updateEditorItem(field, e.target.value);
                }
            });

            // å®æ—¶è¾“å…¥äº‹ä»¶ï¼ˆé’ˆå¯¹æ–‡æœ¬è¾“å…¥æ¡†å’Œæ»‘å—ï¼‰
            newEditor.addEventListener('input', function(e) {
                const field = e.target.dataset.field;
                if (field) {
                    if (e.target.type === 'range') {
                        // æ»‘å—å®æ—¶æ›´æ–°
                        const distanceSpan = document.getElementById(`editor-distance-value-${currentEditingItemId}`);
                        if (distanceSpan && field === 'externalEmojiDistance') {
                            distanceSpan.textContent = e.target.value + 'px';
                        }
                        updateEditorItem(field, parseInt(e.target.value));
                    } else if (e.target.type === 'text' || e.target.tagName === 'TEXTAREA') {
                        // ä½¿ç”¨é˜²æŠ–ï¼Œé¿å…é¢‘ç¹æ›´æ–°
                        clearTimeout(window.editorInputTimeout);
                        window.editorInputTimeout = setTimeout(() => {
                            updateEditorItem(field, e.target.value);
                        }, 300);
                    }
                }
            });
        }

        // å…³é—­æµ®åŠ¨ç¼–è¾‘å™¨
        function closeFloatingEditor() {
            document.getElementById('floatingEditorOverlay').classList.remove('show');
            document.getElementById('floatingEditor').classList.remove('show');
            currentEditingItemId = null;
        }

        // æ›´æ–°ç¼–è¾‘å™¨ä¸­çš„å…ƒç´ å±æ€§
        function updateEditorItem(field, value) {
            if (!currentEditingItemId) return;

            updateItem(currentEditingItemId, field, value);

            // å¦‚æœæ˜¯åˆ‡æ¢æ˜¾ç¤ºæ ·å¼ï¼Œé‡æ–°æ¸²æŸ“ç¼–è¾‘å™¨
            if (field === 'displayStyle') {
                openItemEditor(currentEditingItemId);
            } else {
                generateAllVersions();
            }
        }

        // åœ¨ç¼–è¾‘å™¨ä¸­æ¸²æŸ“emojiåˆ—è¡¨
        function renderEditorEmojis(itemId, emojis) {
            const container = document.getElementById(`editor-emojis-${itemId}`);
            if (!container) return;
            container.innerHTML = '';

            emojis.forEach((emoji, index) => {
                const emojiDiv = document.createElement('div');
                emojiDiv.style.display = 'flex';
                emojiDiv.style.alignItems = 'center';
                emojiDiv.style.marginBottom = '8px';
                emojiDiv.style.gap = '5px';

                const input = document.createElement('input');
                input.type = 'text';
                input.value = emoji;
                input.placeholder = 'è¾“å…¥emoji';
                input.style.flex = '1';
                input.style.padding = '8px';
                input.style.border = '1px solid #ddd';
                input.style.borderRadius = '6px';
                input.dataset.emojiIndex = index;
                input.addEventListener('input', function() {
                    const item = items.find(i => i.id === itemId);
                    if (item) {
                        item.emojis[index] = this.value;
                        generateAllVersions();
                    }
                });

                const pickBtn = document.createElement('button');
                pickBtn.className = 'btn-pick-emoji';
                pickBtn.textContent = 'é€‰æ‹©';
                pickBtn.dataset.emojiIndex = index;
                pickBtn.addEventListener('click', function() {
                    openEmojiPickerInEditor('emoji', index);
                });

                const removeBtn = document.createElement('button');
                removeBtn.className = 'btn-remove-emoji';
                removeBtn.textContent = 'Ã—';
                removeBtn.addEventListener('click', function() {
                    const item = items.find(i => i.id === itemId);
                    if (item) {
                        item.emojis.splice(index, 1);
                        if (item.emojis.length === 0) {
                            item.emojis.push("");
                        }
                        renderEditorEmojis(itemId, item.emojis);
                        generateAllVersions();
                    }
                });

                emojiDiv.appendChild(input);
                emojiDiv.appendChild(pickBtn);
                emojiDiv.appendChild(removeBtn);
                container.appendChild(emojiDiv);
            });
        }

        // åœ¨ç¼–è¾‘å™¨ä¸­æ·»åŠ emoji
        function addEmojiInEditor() {
            if (!currentEditingItemId) return;
            const item = items.find(i => i.id === currentEditingItemId);
            if (item) {
                item.emojis.push("");
                renderEditorEmojis(item.id, item.emojis);
            }
        }

        // åœ¨ç¼–è¾‘å™¨ä¸­æ¸²æŸ“æ¡†å¤–emojiåˆ—è¡¨
        function renderEditorExternalEmojis(itemId, externalEmojis) {
            const container = document.getElementById(`editor-external-emojis-${itemId}`);
            if (!container) return;
            container.innerHTML = '';

            externalEmojis.forEach((emoji, index) => {
                const emojiDiv = document.createElement('div');
                emojiDiv.style.display = 'flex';
                emojiDiv.style.alignItems = 'center';
                emojiDiv.style.marginBottom = '8px';
                emojiDiv.style.gap = '5px';

                const input = document.createElement('input');
                input.type = 'text';
                input.value = emoji;
                input.placeholder = 'è¾“å…¥emoji';
                input.style.flex = '1';
                input.style.padding = '8px';
                input.style.border = '1px solid #ddd';
                input.style.borderRadius = '6px';
                input.dataset.emojiIndex = index;
                input.addEventListener('input', function() {
                    const item = items.find(i => i.id === itemId);
                    if (item) {
                        item.externalEmojis[index] = this.value;
                        generateAllVersions();
                    }
                });

                const pickBtn = document.createElement('button');
                pickBtn.className = 'btn-pick-emoji';
                pickBtn.textContent = 'é€‰æ‹©';
                pickBtn.dataset.emojiIndex = index;
                pickBtn.addEventListener('click', function() {
                    openEmojiPickerInEditor('externalEmojis', index);
                });

                const removeBtn = document.createElement('button');
                removeBtn.className = 'btn-remove-emoji';
                removeBtn.textContent = 'Ã—';
                removeBtn.addEventListener('click', function() {
                    const item = items.find(i => i.id === itemId);
                    if (item) {
                        item.externalEmojis.splice(index, 1);
                        renderEditorExternalEmojis(itemId, item.externalEmojis);
                        generateAllVersions();
                    }
                });

                emojiDiv.appendChild(input);
                emojiDiv.appendChild(pickBtn);
                emojiDiv.appendChild(removeBtn);
                container.appendChild(emojiDiv);
            });
        }

        // åœ¨ç¼–è¾‘å™¨ä¸­æ·»åŠ æ¡†å¤–emoji
        function addExternalEmojiInEditor() {
            if (!currentEditingItemId) return;
            const item = items.find(i => i.id === currentEditingItemId);
            if (item) {
                if (!item.externalEmojis) {
                    item.externalEmojis = [];
                }
                item.externalEmojis.push("");
                renderEditorExternalEmojis(item.id, item.externalEmojis);
            }
        }

        // åœ¨ç¼–è¾‘å™¨ä¸­æ¸²æŸ“è£…é¥°emojiåˆ—è¡¨
        function renderEditorDecorativeEmojis(itemId, decorativeEmojis) {
            const container = document.getElementById(`editor-decorative-emojis-${itemId}`);
            if (!container) return;
            container.innerHTML = '';

            decorativeEmojis.forEach((deco, index) => {
                const emojiDiv = document.createElement('div');
                emojiDiv.style.display = 'flex';
                emojiDiv.style.alignItems = 'center';
                emojiDiv.style.marginBottom = '8px';
                emojiDiv.style.gap = '8px';

                const input = document.createElement('input');
                input.type = 'text';
                input.value = deco.emoji;
                input.placeholder = 'è¾“å…¥emoji';
                input.style.flex = '0 0 60px';
                input.onchange = () => {
                    const item = items.find(i => i.id === itemId);
                    if (item && item.decorativeEmojis[index]) {
                        item.decorativeEmojis[index].emoji = input.value;
                        generateAllVersions();
                    }
                };

                const sizeLabel = document.createElement('span');
                sizeLabel.textContent = `${deco.fontSize || 32}px`;
                sizeLabel.style.minWidth = '40px';
                sizeLabel.style.fontSize = '12px';

                const sizeSlider = document.createElement('input');
                sizeSlider.type = 'range';
                sizeSlider.min = '16';
                sizeSlider.max = '80';
                sizeSlider.value = deco.fontSize || 32;
                sizeSlider.style.flex = '1';
                sizeSlider.oninput = () => {
                    const item = items.find(i => i.id === itemId);
                    if (item && item.decorativeEmojis[index]) {
                        item.decorativeEmojis[index].fontSize = parseInt(sizeSlider.value);
                        sizeLabel.textContent = sizeSlider.value + 'px';
                        generateAllVersions();
                    }
                };

                const pickBtn = document.createElement('button');
                pickBtn.className = 'btn-pick-emoji';
                pickBtn.textContent = 'é€‰æ‹©';
                pickBtn.onclick = () => {
                    currentEmojiPicker.itemId = itemId;
                    currentEmojiPicker.emojiIndex = index;
                    currentEmojiPicker.field = 'editor-decorativeEmojis';
                    document.getElementById('emojiPickerModal').classList.add('show');
                };

                const removeBtn = document.createElement('button');
                removeBtn.className = 'btn-remove-emoji';
                removeBtn.textContent = 'Ã—';
                removeBtn.onclick = () => {
                    const item = items.find(i => i.id === itemId);
                    if (item) {
                        item.decorativeEmojis.splice(index, 1);
                        renderEditorDecorativeEmojis(itemId, item.decorativeEmojis);
                        generateAllVersions();
                    }
                };

                emojiDiv.appendChild(input);
                emojiDiv.appendChild(sizeLabel);
                emojiDiv.appendChild(sizeSlider);
                emojiDiv.appendChild(pickBtn);
                emojiDiv.appendChild(removeBtn);
                container.appendChild(emojiDiv);
            });
        }

        // åœ¨ç¼–è¾‘å™¨ä¸­æ·»åŠ è£…é¥°emoji
        function addDecorativeEmojiInEditor() {
            if (!currentEditingItemId) return;
            const item = items.find(i => i.id === currentEditingItemId);
            if (item) {
                if (!item.decorativeEmojis) {
                    item.decorativeEmojis = [];
                }
                item.decorativeEmojis.push({
                    emoji: 'âœ¨',
                    x: 50,
                    y: 50,
                    fontSize: 32
                });
                renderEditorDecorativeEmojis(item.id, item.decorativeEmojis);
                generateAllVersions();
            }
        }

        // åœ¨ç¼–è¾‘å™¨ä¸­æ‰“å¼€emojié€‰æ‹©å™¨
        function openEmojiPickerInEditor(field, emojiIndex = 0) {
            currentEmojiPicker.itemId = currentEditingItemId;
            currentEmojiPicker.emojiIndex = emojiIndex;
            currentEmojiPicker.field = field;
            document.getElementById('emojiPickerModal').classList.add('show');
        }

        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
        init();
    </script>
</body>
</html>
