<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ÊïôÂ≠¶ËßÜËßâÂØπÊØîÂõæÁîüÊàêÂô®</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background: #f5f5f5;
            padding: 20px;
            min-height: 100vh;
        }

        .app-header {
            max-width: 1600px;
            margin: 0 auto 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: white;
            padding: 15px 20px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .app-header h1 {
            font-size: 24px;
            color: #1a1a1a;
        }

        .header-actions {
            display: flex;
            gap: 10px;
        }

        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s;
        }

        .btn-primary {
            background: #3b82f6;
            color: white;
        }

        .btn-primary:hover {
            background: #2563eb;
        }

        .btn-success {
            background: #10b981;
            color: white;
        }

        .btn-success:hover {
            background: #059669;
        }

        .btn-secondary {
            background: #6b7280;
            color: white;
        }

        .btn-secondary:hover {
            background: #4b5563;
        }

        .app-container {
            display: flex;
            gap: 20px;
            max-width: 1600px;
            margin: 0 auto;
        }

        /* ÈÖçÁΩÆÈù¢Êùø */
        .config-panel {
            flex: 0 0 480px;
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            max-height: calc(100vh - 120px);
            overflow-y: auto;
        }

        .config-panel h2 {
            font-size: 20px;
            margin-bottom: 20px;
            color: #1a1a1a;
        }

        .config-name-group {
            margin-bottom: 20px;
            padding: 15px;
            background: #f9fafb;
            border-radius: 8px;
        }

        .config-name-group label {
            display: block;
            font-size: 14px;
            font-weight: 500;
            color: #555;
            margin-bottom: 8px;
        }

        .config-name-group input {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
        }

        .layout-controls {
            margin-bottom: 20px;
            padding: 15px;
            background: #f9fafb;
            border-radius: 8px;
        }

        .layout-controls label {
            display: block;
            font-size: 14px;
            font-weight: 500;
            color: #555;
            margin-bottom: 8px;
        }

        .layout-controls select {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
        }

        .btn-generate-all {
            width: 100%;
            background: #10b981;
            color: white;
            border: none;
            padding: 12px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            margin-top: 10px;
            margin-bottom: 20px;
        }

        .btn-generate-all:hover {
            background: #059669;
        }

        .item-config {
            border: 2px solid #e5e5e5;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            background: #fafafa;
            cursor: move;
            position: relative;
            transition: all 0.2s;
        }

        .item-config:hover {
            border-color: #3b82f6;
            box-shadow: 0 2px 8px rgba(59, 130, 246, 0.2);
        }

        .item-config.dragging {
            opacity: 0.5;
            border-color: #3b82f6;
        }

        .item-config.error {
            border-color: #ef4444;
        }

        .drag-handle {
            position: absolute;
            top: 10px;
            right: 50px;
            cursor: move;
            color: #999;
            font-size: 18px;
        }

        .item-config-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .item-config-title {
            font-weight: 600;
            color: #333;
        }

        .btn-delete {
            background: #ef4444;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
        }

        .btn-delete:hover {
            background: #dc2626;
        }

        .form-group {
            margin-bottom: 12px;
        }

        .form-group label {
            display: block;
            font-size: 14px;
            font-weight: 500;
            color: #555;
            margin-bottom: 5px;
        }

        .form-group label .required {
            color: #ef4444;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
        }

        .form-group input:invalid,
        .form-group textarea:invalid {
            border-color: #ef4444;
        }

        .form-group textarea {
            min-height: 60px;
            resize: vertical;
        }

        .style-help {
            font-size: 12px;
            color: #666;
            margin-top: 5px;
            padding: 8px;
            background: #f9fafb;
            border-radius: 4px;
        }

        .style-help code {
            background: #e5e7eb;
            padding: 2px 4px;
            border-radius: 3px;
            font-size: 11px;
        }

        .form-group input[type="color"] {
            height: 40px;
            cursor: pointer;
        }

        .error-message {
            color: #ef4444;
            font-size: 12px;
            margin-top: 4px;
        }

        /* ÊåâÈíÆÁªÑÊ†∑Âºè */
        .button-group {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .button-group .option-btn {
            flex: 1;
            min-width: 100px;
            padding: 10px 16px;
            border: 2px solid #ddd;
            background: white;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            color: #555;
            transition: all 0.2s;
            text-align: center;
        }

        .button-group .option-btn:hover {
            border-color: #3b82f6;
            color: #3b82f6;
            background: #eff6ff;
        }

        .button-group .option-btn.active {
            background: #3b82f6;
            color: white;
            border-color: #3b82f6;
        }

        .emoji-input-group {
            display: flex;
            gap: 5px;
            flex-wrap: wrap;
            margin-bottom: 8px;
        }

        .emoji-display {
            position: relative;
            display: inline-block;
        }

        .emoji-display input {
            width: 60px;
            text-align: center;
            font-size: 24px;
        }

        .btn-pick-emoji {
            background: #8b5cf6;
            color: white;
            border: none;
            padding: 6px 10px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            margin-left: 5px;
        }

        .btn-pick-emoji:hover {
            background: #7c3aed;
        }

        .btn-remove-emoji {
            background: #ef4444;
            color: white;
            border: none;
            padding: 4px 8px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
        }

        .btn-remove-emoji:hover {
            background: #dc2626;
        }

        .btn-add-emoji {
            background: #10b981;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            width: 100%;
            margin-top: 5px;
        }

        .btn-add-emoji:hover {
            background: #059669;
        }

        .btn-add-item {
            width: 100%;
            background: #3b82f6;
            color: white;
            border: none;
            padding: 12px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            margin-top: 10px;
        }

        .btn-add-item:hover {
            background: #2563eb;
        }

        /* EmojiÈÄâÊã©Âô®ÂºπÁ™ó */
        .emoji-picker-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .emoji-picker-modal.show {
            display: flex;
        }

        .emoji-picker-content {
            background: white;
            border-radius: 12px;
            padding: 20px;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
        }

        .emoji-picker-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .emoji-picker-header h3 {
            font-size: 18px;
            color: #1a1a1a;
        }

        .btn-close-picker {
            background: #ef4444;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
        }

        .emoji-categories {
            display: flex;
            gap: 8px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }

        .category-btn {
            padding: 6px 12px;
            border: 2px solid #ddd;
            background: white;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s;
        }

        .category-btn:hover {
            border-color: #3b82f6;
            color: #3b82f6;
        }

        .category-btn.active {
            background: #3b82f6;
            color: white;
            border-color: #3b82f6;
        }

        .emoji-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(50px, 1fr));
            gap: 10px;
            max-height: 400px;
            overflow-y: auto;
            padding: 10px;
            background: #f9fafb;
            border-radius: 8px;
        }

        .emoji-item {
            font-size: 32px;
            padding: 10px;
            text-align: center;
            cursor: pointer;
            border-radius: 6px;
            transition: all 0.2s;
            background: white;
        }

        .emoji-item:hover {
            background: #e0e7ff;
            transform: scale(1.1);
        }

        /* È¢ÑËßàÈù¢Êùø */
        .preview-panel {
            flex: 1;
            background: white;
            border-radius: 12px;
            padding: 40px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
            min-height: 600px;
            position: relative;
            overflow: auto;
        }

        /* ÁîªÂ∏ÉÂ∑•ÂÖ∑Ê†è */
        .canvas-toolbar {
            position: absolute;
            top: 15px;
            right: 15px;
            z-index: 100;
            display: flex;
            gap: 8px;
        }

        .canvas-toolbar .btn {
            background: white;
            border: 2px solid #3b82f6;
            color: #3b82f6;
            padding: 8px 16px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            transition: all 0.2s;
        }

        .canvas-toolbar .btn:hover {
            background: #3b82f6;
            color: white;
        }

        /* ÂÖÉÁ¥†Êìç‰ΩúÊåâÈíÆ */
        .item-actions {
            position: absolute;
            top: -12px;
            right: -12px;
            display: none;
            gap: 4px;
            z-index: 20;
        }

        .comparison-item:hover .item-actions {
            display: flex;
        }

        .item-action-btn {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            border: none;
            cursor: pointer;
            font-size: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
            transition: all 0.2s;
        }

        .item-action-btn.edit {
            background: #3b82f6;
            color: white;
        }

        .item-action-btn.edit:hover {
            background: #2563eb;
            transform: scale(1.1);
        }

        .item-action-btn.delete {
            background: #ef4444;
            color: white;
        }

        .item-action-btn.delete:hover {
            background: #dc2626;
            transform: scale(1.1);
        }

        /* ÊµÆÂä®ÁºñËæëÈù¢Êùø */
        .floating-editor {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
            z-index: 2000;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }

        .floating-editor.show {
            display: block;
        }

        .floating-editor-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #e5e5e5;
        }

        .floating-editor-header h3 {
            font-size: 18px;
            color: #1a1a1a;
            margin: 0;
        }

        .btn-close-editor {
            background: #ef4444;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
        }

        .btn-close-editor:hover {
            background: #dc2626;
        }

        .floating-editor-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1999;
        }

        .floating-editor-overlay.show {
            display: block;
        }

        .version-controls {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            align-items: center;
        }

        .version-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .version-btn {
            padding: 10px 20px;
            border: 2px solid #ddd;
            background: white;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            color: #333;
            transition: all 0.2s;
            position: relative;
        }

        .version-btn:hover {
            border-color: #3b82f6;
            color: #3b82f6;
        }

        .version-btn.active {
            background: #3b82f6;
            color: white;
            border-color: #3b82f6;
        }

        .version-btn .btn-delete-version {
            position: absolute;
            top: -8px;
            right: -8px;
            width: 20px;
            height: 20px;
            background: #ef4444;
            color: white;
            border: none;
            border-radius: 50%;
            cursor: pointer;
            font-size: 12px;
            display: none;
            align-items: center;
            justify-content: center;
        }

        .version-btn:hover .btn-delete-version {
            display: flex;
        }

        .btn-add-version {
            padding: 10px 20px;
            border: 2px dashed #3b82f6;
            background: white;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            color: #3b82f6;
            transition: all 0.2s;
        }

        .btn-add-version:hover {
            background: #eff6ff;
        }

        .comparison-container {
            position: relative;
            width: 100%;
            min-height: 500px;
            padding: 20px;
            box-sizing: border-box;
        }

        .comparison-container.vertical {
            display: flex;
            flex-direction: column;
        }

        .comparison-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 15px;
            position: absolute;
            min-width: 200px;
            max-width: 350px;
            transition: all 0.2s;
        }

        .comparison-item.draggable {
            cursor: move;
        }

        .comparison-item.dragging {
            opacity: 0.7;
            z-index: 1000;
        }

        .comparison-item:hover {
            transform: scale(1.02);
        }

        /* ÂõæÊ†áÊ†∑Âºè */
        .icon-container {
            width: 120px;
            height: 120px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 60px;
            font-weight: normal;
        }

        .icon-container.circle {
            border-radius: 50%;
        }

        .icon-container.square {
            border-radius: 12px;
        }

        /* ÊñáÊú¨Ê°ÜÊ†∑Âºè */
        .text-box-container {
            position: relative;
            width: 100%;
            min-height: 120px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .text-box {
            padding: 20px 30px;
            border-radius: 12px;
            min-width: 200px;
            text-align: center;
            font-size: 24px;
            font-weight: 600;
            line-height: 1.4;
            word-wrap: break-word;
        }

        .text-box.rounded {
            border-radius: 12px;
        }

        .text-box.rectangle {
            border-radius: 4px;
        }

        /* Ê°ÜÂ§ñemoji */
        .external-emoji {
            position: absolute;
            font-size: 48px;
            z-index: 10;
        }

        .external-emoji.top {
            top: -65px;
            left: 50%;
            transform: translateX(-50%);
        }

        .external-emoji.bottom {
            bottom: -65px;
            left: 50%;
            transform: translateX(-50%);
        }

        .external-emoji.left {
            left: -65px;
            top: 50%;
            transform: translateY(-50%);
        }

        .external-emoji.right {
            right: -65px;
            top: 50%;
            transform: translateY(-50%);
        }

        .text-content {
            text-align: center;
        }

        .title {
            font-size: 32px;
            font-weight: 700;
            color: #1a1a1a;
            margin-bottom: 8px;
        }

        .subtitle {
            font-size: 20px;
            font-weight: 500;
            color: #666;
        }

        .empty-state {
            text-align: center;
            color: #999;
            font-size: 18px;
        }

        .hidden {
            display: none;
        }

        @media (max-width: 1024px) {
            .app-container {
                flex-direction: column;
            }

            .config-panel {
                flex: 1;
                max-height: none;
            }

            .app-header {
                flex-direction: column;
                gap: 10px;
            }

            .header-actions {
                width: 100%;
                flex-wrap: wrap;
            }
        }

        @media (max-width: 768px) {
            .preview-panel {
                padding: 20px;
            }

            .comparison-container {
                flex-direction: column;
                gap: 30px;
            }

            .icon-container {
                width: 100px;
                height: 100px;
                font-size: 50px;
            }

            .text-box {
                font-size: 20px;
                padding: 15px 20px;
            }

            .title {
                font-size: 28px;
            }

            .subtitle {
                font-size: 18px;
            }
        }
    </style>
</head>
<body>
    <div class="app-header">
        <h1>üìö ÊïôÂ≠¶ËßÜËßâÂØπÊØîÂõæÁîüÊàêÂô®</h1>
        <div class="header-actions">
            <button class="btn btn-success" onclick="saveConfig()">üíæ ‰øùÂ≠òÈÖçÁΩÆ</button>
            <button class="btn btn-secondary" onclick="loadConfig()">üìÇ Âä†ËΩΩÈÖçÁΩÆ</button>
            <button class="btn btn-primary" onclick="exportHTML()">üìÑ ÂØºÂá∫HTML</button>
            <button class="btn btn-secondary" onclick="exportJSON()">üìã ÂØºÂá∫JSON</button>
        </div>
    </div>

    <div class="app-container">
        <!-- ÈÖçÁΩÆÈù¢Êùø -->
        <div class="config-panel">
            <h2>ÈÖçÁΩÆÂØπÊØîÈ°π</h2>
            
            <div class="config-name-group">
                <label>ÈÖçÁΩÆÂêçÁß∞</label>
                <input type="text" id="configName" placeholder="‰æãÂ¶ÇÔºöMust vs Have to" 
                       value="Must vs Have to" oninput="updateConfigName()">
            </div>

            <div class="layout-controls">
                <label>Â∏ÉÂ±ÄÊñπÂêë</label>
                <select id="layoutDirection" onchange="updateLayout()">
                    <option value="horizontal">Ê®™ÂêëÊéíÂàó</option>
                    <option value="vertical">Á∫µÂêëÊéíÂàó</option>
                </select>
            </div>

            <button class="btn-generate-all" onclick="generateAllVersions()">üöÄ ‰∏ÄÈîÆÁîüÊàêÊâÄÊúâÁâàÊú¨</button>

            <div id="itemsConfig"></div>
            <button class="btn-add-item" onclick="addItem()">+ Ê∑ªÂä†ÂØπÊØîÈ°π</button>
        </div>

        <!-- È¢ÑËßàÈù¢Êùø -->
        <div class="preview-panel" style="left: 45px; top: 34px;">
            <div class="canvas-toolbar">
                <button class="btn" onclick="addItemFromCanvas()">‚ûï Ê∑ªÂä†ÂÖÉÁ¥†</button>
            </div>
            <div class="version-controls">
                <div class="version-buttons" id="versionButtons"></div>
            </div>
            <div class="comparison-container" id="previewContainer">
                <div class="empty-state">ÁÇπÂáª‰∏äÊñπ"‚ûï Ê∑ªÂä†ÂÖÉÁ¥†"ÂºÄÂßãÂàõÂª∫</div>
            </div>
        </div>
    </div>

    <!-- EmojiÈÄâÊã©Âô®ÂºπÁ™ó -->
    <div class="emoji-picker-modal" id="emojiPickerModal">
        <div class="emoji-picker-content">
            <div class="emoji-picker-header">
                <h3>ÈÄâÊã© Emoji</h3>
                <button class="btn-close-picker" onclick="closeEmojiPicker()">ÂÖ≥Èó≠</button>
            </div>
            <div class="emoji-categories" id="emojiCategories"></div>
            <div class="emoji-grid" id="emojiGrid"></div>
        </div>
    </div>

    <!-- ÊµÆÂä®ÁºñËæëÂô®ÈÅÆÁΩ© -->
    <div class="floating-editor-overlay" id="floatingEditorOverlay" onclick="closeFloatingEditor()"></div>

    <!-- ÊµÆÂä®ÁºñËæëÂô® -->
    <div class="floating-editor" id="floatingEditor">
        <div class="floating-editor-header">
            <h3>ÁºñËæëÂÖÉÁ¥†</h3>
            <button class="btn-close-editor" onclick="closeFloatingEditor()">ÂÖ≥Èó≠</button>
        </div>
        <div id="floatingEditorContent"></div>
    </div>

    <!-- ÈöêËóèÁöÑÊñá‰ª∂ËæìÂÖ• -->
    <input type="file" id="fileInput" accept=".json" class="hidden" onchange="handleFileImport(event)">

    <script>
        // EmojiÂàÜÁ±ªÊï∞ÊçÆ
        const emojiCategories = {
            'Ë°®ÊÉÖ': ['üòÄ', 'üòÉ', 'üòÑ', 'üòÅ', 'üòÜ', 'üòÖ', 'ü§£', 'üòÇ', 'üôÇ', 'üôÉ', 'üòâ', 'üòä', 'üòá', 'ü•∞', 'üòç', 'ü§©', 'üòò', 'üòó', 'üòö', 'üòô', 'üòã', 'üòõ', 'üòú', 'ü§™', 'üòù', 'ü§ë', 'ü§ó', 'ü§≠', 'ü§´', 'ü§î', 'ü§ê', 'ü§®', 'üòê', 'üòë', 'üò∂', 'üòè', 'üòí', 'üôÑ', 'üò¨', 'ü§•', 'üòå', 'üòî', 'üò™', 'ü§§', 'üò¥', 'üò∑', 'ü§í', 'ü§ï', 'ü§¢', 'ü§Æ', 'ü§ß', 'ü•µ', 'ü•∂', 'üò∂‚Äçüå´Ô∏è', 'üòµ', 'üòµ‚Äçüí´', 'ü§Ø', 'ü§†', 'ü•≥', 'üòé', 'ü§ì', 'üßê'],
            '‰∫∫Áâ©': ['üë∂', 'üëß', 'üßí', 'üë¶', 'üë©', 'üßë', 'üë®', 'üë©‚Äçü¶±', 'üë®‚Äçü¶±', 'üë©‚Äçü¶∞', 'üë®‚Äçü¶∞', 'üë±‚Äç‚ôÄÔ∏è', 'üë±', 'üë±‚Äç‚ôÇÔ∏è', 'üë©‚Äçü¶≥', 'üë®‚Äçü¶≥', 'üë©‚Äçü¶≤', 'üë®‚Äçü¶≤', 'üßî', 'üëµ', 'üßì', 'üë¥', 'üë≤', 'üë≥‚Äç‚ôÄÔ∏è', 'üë≥', 'üë≥‚Äç‚ôÇÔ∏è', 'üßï', 'üëÆ‚Äç‚ôÄÔ∏è', 'üëÆ', 'üëÆ‚Äç‚ôÇÔ∏è', 'üë∑‚Äç‚ôÄÔ∏è', 'üë∑', 'üë∑‚Äç‚ôÇÔ∏è', 'üíÇ‚Äç‚ôÄÔ∏è', 'üíÇ', 'üíÇ‚Äç‚ôÇÔ∏è', 'üïµÔ∏è‚Äç‚ôÄÔ∏è', 'üïµÔ∏è', 'üïµÔ∏è‚Äç‚ôÇÔ∏è', 'üë©‚Äç‚öïÔ∏è', 'üë®‚Äç‚öïÔ∏è', 'üë©‚Äçüåæ', 'üë®‚Äçüåæ', 'üë©‚Äçüç≥', 'üë®‚Äçüç≥', 'üë©‚Äçüéì', 'üë®‚Äçüéì', 'üë©‚Äçüé§', 'üë®‚Äçüé§', 'üë©‚Äçüè´', 'üë®‚Äçüè´', 'üë©‚Äçüè≠', 'üë®‚Äçüè≠', 'üë©‚Äçüíª', 'üë®‚Äçüíª', 'üë©‚Äçüíº', 'üë®‚Äçüíº', 'üë©‚Äçüîß', 'üë®‚Äçüîß', 'üë©‚Äçüî¨', 'üë®‚Äçüî¨', 'üë©‚Äçüé®', 'üë®‚Äçüé®', 'üë©‚Äçüöí', 'üë®‚Äçüöí', 'üë©‚Äç‚úàÔ∏è', 'üë®‚Äç‚úàÔ∏è', 'üë©‚ÄçüöÄ', 'üë®‚ÄçüöÄ', 'üë©‚Äç‚öñÔ∏è', 'üë®‚Äç‚öñÔ∏è', 'ü§∂', 'üéÖ', 'üë∏', 'ü§¥', 'üë∞', 'ü§µ', 'üëº', 'ü§∞', 'ü§±', 'üë©‚Äçüçº', 'üë®‚Äçüçº'],
            'ÊâãÂäø': ['üëã', 'ü§ö', 'üñê', '‚úã', 'üññ', 'üëå', 'ü§å', 'ü§è', '‚úåÔ∏è', 'ü§û', 'ü§ü', 'ü§ò', 'ü§ô', 'üëà', 'üëâ', 'üëÜ', 'üñï', 'üëá', '‚òùÔ∏è', 'üëç', 'üëé', '‚úä', 'üëä', 'ü§õ', 'ü§ú', 'üëè', 'üôå', 'üëê', 'ü§≤', 'ü§ù', 'üôè', '‚úçÔ∏è', 'üí™', 'ü¶æ', 'ü¶ø', 'ü¶µ', 'ü¶∂', 'üëÇ', 'ü¶ª', 'üëÉ', 'üë∂', 'üß†', 'ü´Ä', 'ü´Å', 'ü¶∑', 'ü¶¥', 'üëÄ', 'üëÅÔ∏è', 'üëÖ', 'üëÑ'],
            'Áâ©‰Ωì': ['üìè', 'üìê', '‚úÇÔ∏è', 'üî®', 'ü™ì', 'ü™ö', 'üîß', 'ü™õ', 'üî©', '‚öôÔ∏è', 'ü™§', 'üß∞', 'üß≤', 'ü™ú', '‚öñÔ∏è', 'ü¶Ø', 'üîó', '‚õìÔ∏è', 'üß∞', 'üß≤', 'ü™ù', 'ü™ú', '‚öñÔ∏è', 'ü¶Ø', 'üîó', '‚õìÔ∏è', 'üß∞', 'üß≤', 'ü™ù', 'ü™ú', 'üìã', 'üìä', 'üìà', 'üìâ', 'üóíÔ∏è', 'üóìÔ∏è', 'üìÜ', 'üìÖ', 'üóëÔ∏è', 'üìá', 'üóÉÔ∏è', 'üóÑÔ∏è', 'üóÇÔ∏è', 'üìÅ', 'üìÇ', 'üóÇÔ∏è', 'üìì', 'üìî', 'üìí', 'üìï', 'üìó', 'üìò', 'üìô', 'üìö', 'üìñ', 'üîñ', 'üß∑', 'üîó', 'üìé', 'üñáÔ∏è', 'üìê', 'üìè', 'üßÆ', 'üìä', 'üìà', 'üìâ', 'üóíÔ∏è', 'üóìÔ∏è', 'üìÜ', 'üìÖ', 'üóëÔ∏è', 'üìá', 'üóÉÔ∏è', 'üóÑÔ∏è', 'üóÇÔ∏è', 'üìÅ', 'üìÇ', 'üóÇÔ∏è', 'üìì', 'üìî', 'üìí', 'üìï', 'üìó', 'üìò', 'üìô', 'üìö', 'üìñ', 'üîñ', 'üß∑', 'üîó', 'üìé', 'üñáÔ∏è'],
            'Á¨¶Âè∑': ['‚ùó', '‚ùì', '‚ùï', '‚ùî', '‚ÄºÔ∏è', '‚ÅâÔ∏è', 'üîÖ', 'üîÜ', 'üí±', 'üí≤', '‚öïÔ∏è', '‚ôªÔ∏è', 'üî±', 'üìõ', 'üî∞', '‚≠ï', '‚úÖ', '‚òëÔ∏è', '‚úîÔ∏è', '‚ùå', '‚ùé', '‚ûñ', '‚ûï', '‚ûó', '‚úñÔ∏è', 'üíØ', 'üî¢', 'üîü', 'üî†', 'üî°', 'üî§', 'üÜé', 'üÜë', 'üÜí', 'üÜì', 'üÜî', 'üÜï', 'üÜñ', 'üÜó', 'üÜò', 'üÜô', 'üÜö', 'üàÅ', 'üàÇÔ∏è', 'üà∑Ô∏è', 'üà∂', 'üàØ', 'üâê', 'üàπ', 'üà≤', 'üâë', 'üà∏', 'üà¥', 'üà≥', '„äóÔ∏è', '„äôÔ∏è', 'üà∫', 'üàµ', 'üî¥', 'üü†', 'üü°', 'üü¢', 'üîµ', 'üü£', '‚ö´', '‚ö™', 'üü§', 'üî∂', 'üî∑', 'üî∏', 'üîπ', 'üî∫', 'üîª', 'üí†', 'üîò', 'üî≥', 'üî≤'],
            'ÊÄùËÄÉ': ['üß†', 'üí≠', 'üí°', 'üîç', 'üîé', 'üïØÔ∏è', 'üí°', 'üî¶', 'üèÆ', 'ü™î', 'üßØ', 'üõ¢Ô∏è', 'üí∏', 'üíµ', 'üí¥', 'üí∂', 'üí∑', 'üí∞', 'üí≥', 'üíé', '‚öñÔ∏è', 'üß∞', 'üß≤', 'ü™ù', 'ü™ú', '‚öñÔ∏è', 'ü¶Ø', 'üîó', '‚õìÔ∏è', 'üß∞', 'üß≤', 'ü™ù', 'ü™ú'],
            'ÂÖ∂‰ªñ': ['‚≠ê', 'üåü', 'üí´', '‚ú®', '‚ö°', '‚òÑÔ∏è', 'üí•', 'üî•', 'üåà', '‚òÄÔ∏è', 'üå§Ô∏è', '‚õÖ', '‚òÅÔ∏è', 'üå¶Ô∏è', 'üåßÔ∏è', '‚õàÔ∏è', 'üå©Ô∏è', '‚ùÑÔ∏è', '‚òÉÔ∏è', '‚õÑ', 'üå®Ô∏è', 'üíß', 'üí¶', '‚òî', '‚òÇÔ∏è', 'üåä', 'üå´Ô∏è']
        };

        // Â≠òÂÇ®ÊâÄÊúâÂØπÊØîÈ°πÈÖçÁΩÆ
        let items = [];

        // ÂΩìÂâçÊòæÁ§∫ÁöÑÁâàÊú¨Á¥¢Âºï
        let currentVersion = 0;

        // ÂΩìÂâçÂ∏ÉÂ±ÄÊñπÂêë
        let layoutDirection = 'horizontal';

        // ÊâÄÊúâÁîüÊàêÁöÑÁâàÊú¨ÔºàÊîØÊåÅÊâãÂä®ÁÆ°ÁêÜÔºâ
        let allVersions = [];
        let manualVersions = false; // ÊòØÂê¶ÊâãÂä®ÁÆ°ÁêÜÊ®°Âºè

        // ÈÖçÁΩÆÂêçÁß∞
        let configName = 'Must vs Have to';

        // ÊãñÊãΩÁõ∏ÂÖ≥
        let draggedPreviewItem = null;
        let dragOffset = { x: 0, y: 0 };

        // ÊãñÊãΩÁõ∏ÂÖ≥ÂèòÈáè
        let draggedElement = null;
        let draggedIndex = null;

        // EmojiÈÄâÊã©Âô®Áõ∏ÂÖ≥ÂèòÈáè
        let currentEmojiPicker = {
            itemId: null,
            emojiIndex: null,
            field: null
        };

        // ÂàùÂßãÂåñ
        function init() {
            // Â∞ùËØï‰ªéLocalStorageÂä†ËΩΩ
            const savedConfig = localStorage.getItem('comparisonConfig');
            if (savedConfig) {
                try {
                    const config = JSON.parse(savedConfig);
                    loadConfigData(config);
                } catch (e) {
                    console.error('Âä†ËΩΩÈÖçÁΩÆÂ§±Ë¥•:', e);
                    loadDefaultConfig();
                }
            } else {
                loadDefaultConfig();
            }
            initEmojiPicker();
        }

        // Âä†ËΩΩÈªòËÆ§ÈÖçÁΩÆ
        function loadDefaultConfig() {
            items = [];
            addItem();
            addItem();
            
            // ËÆæÁΩÆÈªòËÆ§Á§∫‰æãÊï∞ÊçÆ
            if (items.length >= 2) {
                // Â∑¶ËæπÔºömust
                items[0].title = "must";
                items[0].subtitle = "‰∏ªËßÇ - ÊàëËßâÂæó";
                items[0].color = "#3B82F6";
                items[0].shape = "circle";
                items[0].displayStyle = "icon";
                items[0].emojis = ["ü§î", "üß†", "üëß"];
                items[0].boxContent = "";
                items[0].boxStyle = "rounded";
                items[0].externalEmoji = "";
                items[0].externalEmojiPosition = "top";
                
                // Âè≥ËæπÔºöhave to
                items[1].title = "have to";
                items[1].subtitle = "ÂÆ¢ËßÇ - ËßÑÂÆö";
                items[1].color = "#F97316";
                items[1].shape = "square";
                items[1].displayStyle = "icon";
                items[1].emojis = ["üìè", "‚ùó", "‚öñÔ∏è"];
                items[1].boxContent = "";
                items[1].boxStyle = "rounded";
                items[1].externalEmoji = "";
                items[1].externalEmojiPosition = "top";
            }
            
            configName = 'Must vs Have to';
            document.getElementById('configName').value = configName;
            renderConfig();
            generateAllVersions();
        }

        // Âä†ËΩΩÈÖçÁΩÆÊï∞ÊçÆ
        function loadConfigData(config) {
            configName = config.name || 'Êú™ÂëΩÂêçÈÖçÁΩÆ';
            layoutDirection = config.layout || 'horizontal';
            items = config.items || [];
            
            // Âä†ËΩΩÁâàÊú¨‰ø°ÊÅØ
            if (config.versions && config.versions.length > 0) {
                allVersions = config.versions;
                manualVersions = config.manualVersions || false;
                currentVersion = 0;
            } else {
                manualVersions = false;
            }
            
            document.getElementById('configName').value = configName;
            document.getElementById('layoutDirection').value = layoutDirection;
            
            renderConfig();
            if (!manualVersions || allVersions.length === 0) {
                generateAllVersions();
            } else {
                updatePreview();
            }
        }

        // Êõ¥Êñ∞ÈÖçÁΩÆÂêçÁß∞
        function updateConfigName() {
            configName = document.getElementById('configName').value || 'Êú™ÂëΩÂêçÈÖçÁΩÆ';
        }

        // ‰øùÂ≠òÈÖçÁΩÆ
        function saveConfig() {
            const config = {
                name: configName,
                layout: layoutDirection,
                items: items,
                versions: allVersions,
                manualVersions: manualVersions,
                createdAt: new Date().toISOString(),
                updatedAt: new Date().toISOString()
            };
            
            localStorage.setItem('comparisonConfig', JSON.stringify(config));
            alert('ÈÖçÁΩÆÂ∑≤‰øùÂ≠òÔºÅ');
        }

        // Âä†ËΩΩÈÖçÁΩÆ
        function loadConfig() {
            document.getElementById('fileInput').click();
        }

        // Â§ÑÁêÜÊñá‰ª∂ÂØºÂÖ•
        function handleFileImport(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const config = JSON.parse(e.target.result);
                    loadConfigData(config);
                    alert('ÈÖçÁΩÆÂä†ËΩΩÊàêÂäüÔºÅ');
                } catch (error) {
                    alert('ÈÖçÁΩÆÊñá‰ª∂Ê†ºÂºèÈîôËØØÔºö' + error.message);
                }
            };
            reader.readAsText(file);
        }

        // ÂØºÂá∫HTML
        function exportHTML() {
            const htmlContent = generateStandaloneHTML();
            const blob = new Blob([htmlContent], { type: 'text/html' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${configName.replace(/\s+/g, '_')}_ÁâàÊú¨${currentVersion + 1}.html`;
            a.click();
            URL.revokeObjectURL(url);
        }

        // ÁîüÊàêÁã¨Á´ãÁöÑHTMLÊñá‰ª∂
        function generateStandaloneHTML() {
            const currentVersionData = allVersions[currentVersion] || {};
            const combination = currentVersionData.combination || [];
            const positions = currentVersionData.positions || {};
            const layoutClass = layoutDirection === 'vertical' ? 'vertical' : '';
            
            let itemsHTML = '';
            const hasTitle = items.some(it => it.title || it.subtitle);
            const horizontalSpacing = hasTitle ? 280 : 220;
            const verticalSpacing = hasTitle ? 250 : 180;

            items.forEach((item, itemIndex) => {
                const emoji = combination[itemIndex] || '';
                const pos = positions[itemIndex] || {};
                let positionStyle = '';

                if (pos.x !== undefined && pos.y !== undefined) {
                    positionStyle = `position: absolute; left: ${pos.x}px; top: ${pos.y}px;`;
                } else {
                    if (layoutDirection === 'vertical') {
                        positionStyle = `position: absolute; top: ${itemIndex * verticalSpacing}px; left: 50%; transform: translateX(-50%);`;
                    } else {
                        positionStyle = `position: absolute; left: ${itemIndex * horizontalSpacing + 50}px; top: 50%; transform: translateY(-50%);`;
                    }
                }

                const hasText = item.title || item.subtitle;

                if (item.displayStyle === 'icon') {
                    itemsHTML += `
                        <div class="comparison-item" style="${positionStyle}">
                            <div class="icon-container ${item.shape}" style="background-color: ${item.color}">
                                ${emoji}
                            </div>
                            ${hasText ? `<div class="text-content">
                                ${item.title ? `<div class="title">${item.title}</div>` : ''}
                                ${item.subtitle ? `<div class="subtitle">${item.subtitle}</div>` : ''}
                            </div>` : ''}
                        </div>
                    `;
                } else {
                    const externalEmoji = item.externalEmoji || '';
                    const styledContent = parseTextStyles(item.boxContent || 'ÊñáÊú¨Ê°ÜÂÜÖÂÆπ');
                    itemsHTML += `
                        <div class="comparison-item" style="${positionStyle}">
                            <div class="text-box-container">
                                ${externalEmoji ? `<div class="external-emoji ${item.externalEmojiPosition}">${externalEmoji}</div>` : ''}
                                <div class="text-box ${item.boxStyle}" style="background-color: ${item.color}; color: white;">
                                    ${styledContent}
                                </div>
                            </div>
                            ${hasText ? `<div class="text-content">
                                ${item.title ? `<div class="title">${item.title}</div>` : ''}
                                ${item.subtitle ? `<div class="subtitle">${item.subtitle}</div>` : ''}
                            </div>` : ''}
                        </div>
                    `;
                }
            });

            return `<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>${configName} - ÁâàÊú¨${currentVersion + 1}</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background: #f5f5f5;
            padding: 40px;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
        }
        .comparison-container {
            position: relative;
            width: 100%;
            height: 100%;
            min-height: 500px;
        }
        .comparison-container.vertical {
            display: flex;
            flex-direction: column;
        }
        .comparison-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 15px;
            min-width: 200px;
            max-width: 350px;
            position: absolute;
        }
        .icon-container {
            width: 120px;
            height: 120px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 60px;
            font-weight: normal;
        }
        .icon-container.circle {
            border-radius: 50%;
        }
        .icon-container.square {
            border-radius: 12px;
        }
        .text-box-container {
            position: relative;
            width: 100%;
            min-height: 120px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .text-box {
            padding: 20px 30px;
            border-radius: 12px;
            min-width: 200px;
            text-align: center;
            font-size: 24px;
            font-weight: 600;
            line-height: 1.4;
            word-wrap: break-word;
        }
        .text-box.rounded {
            border-radius: 12px;
        }
        .text-box.rectangle {
            border-radius: 4px;
        }
        .external-emoji {
            position: absolute;
            font-size: 48px;
            z-index: 10;
        }
        .external-emoji.top { top: -65px; left: 50%; transform: translateX(-50%); }
        .external-emoji.bottom { bottom: -65px; left: 50%; transform: translateX(-50%); }
        .external-emoji.left { left: -65px; top: 50%; transform: translateY(-50%); }
        .external-emoji.right { right: -65px; top: 50%; transform: translateY(-50%); }
        .text-content {
            text-align: center;
        }
        .title {
            font-size: 32px;
            font-weight: 700;
            color: #1a1a1a;
            margin-bottom: 8px;
        }
        .subtitle {
            font-size: 20px;
            font-weight: 500;
            color: #666;
        }
        @media (max-width: 768px) {
            body { padding: 20px; }
            .comparison-container { flex-direction: column; gap: 30px; }
            .icon-container { width: 100px; height: 100px; font-size: 50px; }
            .text-box { font-size: 20px; padding: 15px 20px; }
            .title { font-size: 28px; }
            .subtitle { font-size: 18px; }
        }
    </style>
</head>
<body>
    <div class="comparison-container ${layoutClass}">
        ${itemsHTML}
    </div>
</body>
</html>`;
        }

        // ÂØºÂá∫JSON
        function exportJSON() {
            const config = {
                name: configName,
                layout: layoutDirection,
                items: items,
                versions: allVersions,
                manualVersions: manualVersions,
                createdAt: new Date().toISOString(),
                updatedAt: new Date().toISOString()
            };
            
            const jsonContent = JSON.stringify(config, null, 2);
            const blob = new Blob([jsonContent], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${configName.replace(/\s+/g, '_')}.json`;
            a.click();
            URL.revokeObjectURL(url);
        }

        // ÂàùÂßãÂåñEmojiÈÄâÊã©Âô®
        function initEmojiPicker() {
            const categoriesContainer = document.getElementById('emojiCategories');
            const categories = Object.keys(emojiCategories);
            
            categories.forEach((category, index) => {
                const btn = document.createElement('button');
                btn.className = 'category-btn' + (index === 0 ? ' active' : '');
                btn.textContent = category;
                btn.onclick = () => switchEmojiCategory(category, btn);
                categoriesContainer.appendChild(btn);
            });

            switchEmojiCategory(categories[0]);
        }

        // ÂàáÊç¢EmojiÂàÜÁ±ª
        function switchEmojiCategory(category, btnElement) {
            document.querySelectorAll('.category-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            if (btnElement) {
                btnElement.classList.add('active');
            } else {
                document.querySelectorAll('.category-btn').forEach(btn => {
                    if (btn.textContent === category) {
                        btn.classList.add('active');
                    }
                });
            }

            const grid = document.getElementById('emojiGrid');
            grid.innerHTML = '';
            
            emojiCategories[category].forEach(emoji => {
                const emojiDiv = document.createElement('div');
                emojiDiv.className = 'emoji-item';
                emojiDiv.textContent = emoji;
                emojiDiv.onclick = () => selectEmoji(emoji);
                grid.appendChild(emojiDiv);
            });
        }

        // ÊâìÂºÄEmojiÈÄâÊã©Âô®
        function openEmojiPicker(itemId, emojiIndex, field) {
            currentEmojiPicker.itemId = itemId;
            currentEmojiPicker.emojiIndex = emojiIndex;
            currentEmojiPicker.field = field;
            document.getElementById('emojiPickerModal').classList.add('show');
        }

        // ÂÖ≥Èó≠EmojiÈÄâÊã©Âô®
        function closeEmojiPicker() {
            document.getElementById('emojiPickerModal').classList.remove('show');
        }

        // ÈÄâÊã©Emoji
        function selectEmoji(emoji) {
            const item = items.find(i => i.id === currentEmojiPicker.itemId);
            if (item) {
                if (currentEmojiPicker.field === 'externalEmoji') {
                    item.externalEmoji = emoji;
                } else if (item.emojis[currentEmojiPicker.emojiIndex] !== undefined) {
                    item.emojis[currentEmojiPicker.emojiIndex] = emoji;
                }

                // Êõ¥Êñ∞ÈÖçÁΩÆÈù¢Êùø
                renderConfig();

                // Â¶ÇÊûúÊòØ‰ªéÁºñËæëÂô®‰∏≠ÈÄâÊã©ÁöÑÔºå‰πüÊõ¥Êñ∞ÁºñËæëÂô®
                if (currentEditingItemId === currentEmojiPicker.itemId) {
                    if (item.displayStyle === 'icon') {
                        renderEditorEmojis(item.id, item.emojis);
                    }
                }

                generateAllVersions();
            }
            closeEmojiPicker();
        }

        // ÁîüÊàêÊâÄÊúâÁâàÊú¨
        function generateAllVersions() {
            if (items.length === 0) {
                allVersions = [];
                updatePreview();
                return;
            }

            // Â¶ÇÊûúÂ∑≤ÁªèÊúâÊâãÂä®ÁÆ°ÁêÜÁöÑÁâàÊú¨Ôºå‰øùÁïô‰ΩçÁΩÆ‰ø°ÊÅØ
            if (manualVersions && allVersions.length > 0) {
                // Âè™Êõ¥Êñ∞emojiÁªÑÂêàÔºå‰øùÁïô‰ΩçÁΩÆ‰ø°ÊÅØ
                const itemEmojiLists = items.map(item => {
                    if (item.displayStyle === 'icon') {
                        return item.emojis.filter(e => e.trim());
                    } else {
                        return item.externalEmoji ? [item.externalEmoji] : [''];
                    }
                });

                function getCombinations(arrays, index = 0, current = []) {
                    if (index === arrays.length) {
                        return [current];
                    }
                    const result = [];
                    const currentArray = arrays[index].length > 0 ? arrays[index] : [''];
                    for (const value of currentArray) {
                        result.push(...getCombinations(arrays, index + 1, [...current, value]));
                    }
                    return result;
                }

                const newCombinations = getCombinations(itemEmojiLists);
                
                // ÂêàÂπ∂‰ΩçÁΩÆ‰ø°ÊÅØ
                allVersions = newCombinations.map((combo, index) => {
                    const oldVersion = allVersions[index];
                    return {
                        combination: combo,
                        positions: oldVersion?.positions || {},
                        name: oldVersion?.name || `ÁâàÊú¨ ${index + 1}`
                    };
                });
            } else {
                // Ëá™Âä®ÁîüÊàêÊâÄÊúâÁªÑÂêà
                const itemEmojiLists = items.map(item => {
                    if (item.displayStyle === 'icon') {
                        return item.emojis.filter(e => e.trim());
                    } else {
                        return item.externalEmoji ? [item.externalEmoji] : [''];
                    }
                });

                function getCombinations(arrays, index = 0, current = []) {
                    if (index === arrays.length) {
                        return [current];
                    }
                    const result = [];
                    const currentArray = arrays[index].length > 0 ? arrays[index] : [''];
                    for (const value of currentArray) {
                        result.push(...getCombinations(arrays, index + 1, [...current, value]));
                    }
                    return result;
                }

                const combinations = getCombinations(itemEmojiLists);
                
                // ÈªòËÆ§Âè™ÁîüÊàê‰∏Ä‰∏™ÁâàÊú¨Ôºà‰ΩøÁî®Á¨¨‰∏Ä‰∏™emojiÁªÑÂêàÔºâ
                if (combinations.length > 0) {
                    allVersions = [{
                        combination: combinations[0],
                        positions: {},
                        name: `ÁâàÊú¨ 1`
                    }];
                } else {
                    allVersions = [];
                }
            }

            currentVersion = Math.min(currentVersion, allVersions.length - 1);
            updatePreview();
        }

        // Ê∑ªÂä†Êñ∞ÁâàÊú¨
        function addVersion() {
            if (items.length === 0) return;
            
            const itemEmojiLists = items.map(item => {
                if (item.displayStyle === 'icon') {
                    const validEmojis = item.emojis.filter(e => e.trim());
                    return validEmojis.length > 0 ? validEmojis[0] : '';
                } else {
                    return item.externalEmoji || '';
                }
            });

            allVersions.push({
                combination: itemEmojiLists,
                positions: {},
                name: `ÁâàÊú¨ ${allVersions.length + 1}`
            });
            
            manualVersions = true;
            currentVersion = allVersions.length - 1;
            updatePreview();
        }

        // Âà†Èô§ÁâàÊú¨
        function deleteVersion(versionIndex) {
            if (allVersions.length <= 1) {
                alert('Ëá≥Â∞ëÈúÄË¶Å‰øùÁïô‰∏Ä‰∏™ÁâàÊú¨ÔºÅ');
                return;
            }
            
            allVersions.splice(versionIndex, 1);
            manualVersions = true;
            
            if (currentVersion >= allVersions.length) {
                currentVersion = allVersions.length - 1;
            }
            
            updatePreview();
        }

        // Ê∑ªÂä†Êñ∞ÁöÑÂØπÊØîÈ°π
        function addItem() {
            const newItem = {
                id: Date.now(),
                title: "",
                subtitle: "",
                color: "#3B82F6",
                shape: "circle",
                displayStyle: "icon",
                emojis: [""],
                boxContent: "",
                boxStyle: "rounded",
                externalEmoji: "",
                externalEmojiPosition: "top"
            };
            items.push(newItem);
            renderConfig();
            generateAllVersions();
        }

        // Âà†Èô§ÂØπÊØîÈ°π
        function deleteItem(id) {
            items = items.filter(item => item.id !== id);
            renderConfig();
            generateAllVersions();
        }

        // ÊãñÊãΩÂäüËÉΩ
        function handleDragStart(e, index) {
            draggedElement = e.currentTarget;
            draggedIndex = index;
            e.currentTarget.classList.add('dragging');
            e.dataTransfer.effectAllowed = 'move';
            e.dataTransfer.setData('text/html', e.currentTarget.innerHTML);
        }

        function handleDragEnd(e) {
            e.currentTarget.classList.remove('dragging');
        }

        function handleDragOver(e) {
            if (e.preventDefault) {
                e.preventDefault();
            }
            e.dataTransfer.dropEffect = 'move';
            return false;
        }

        function handleDragEnter(e) {
            e.currentTarget.classList.add('dragging');
        }

        function handleDragLeave(e) {
            e.currentTarget.classList.remove('dragging');
        }

        function handleDrop(e, dropIndex) {
            if (e.stopPropagation) {
                e.stopPropagation();
            }

            if (draggedIndex !== dropIndex) {
                const draggedItem = items[draggedIndex];
                items.splice(draggedIndex, 1);
                items.splice(dropIndex, 0, draggedItem);
                renderConfig();
                generateAllVersions();
            }

            return false;
        }

        // Êõ¥Êñ∞Â∏ÉÂ±ÄÊñπÂêë
        function updateLayout() {
            layoutDirection = document.getElementById('layoutDirection').value;
            updatePreview();
        }

        // Ê∏≤ÊüìÈÖçÁΩÆÈù¢Êùø
        function renderConfig() {
            const container = document.getElementById('itemsConfig');
            container.innerHTML = '';

            items.forEach((item, index) => {
                const itemDiv = document.createElement('div');
                itemDiv.className = 'item-config';
                itemDiv.draggable = true;
                itemDiv.ondragstart = (e) => handleDragStart(e, index);
                itemDiv.ondragend = handleDragEnd;
                itemDiv.ondragover = handleDragOver;
                itemDiv.ondragenter = handleDragEnter;
                itemDiv.ondragleave = handleDragLeave;
                itemDiv.ondrop = (e) => handleDrop(e, index);
                
                itemDiv.innerHTML = `
                    <div class="drag-handle">‚ò∞</div>
                    <div class="item-config-header">
                        <span class="item-config-title">ÂØπÊØîÈ°π ${index + 1}</span>
                        <button class="btn-delete" onclick="deleteItem(${item.id})">Âà†Èô§</button>
                    </div>
                    <div class="form-group">
                        <label>ÊòæÁ§∫Ê†∑Âºè</label>
                        <div class="button-group">
                            <button class="option-btn ${item.displayStyle === 'icon' ? 'active' : ''}"
                                    onclick="updateItem(${item.id}, 'displayStyle', 'icon'); renderConfig(); generateAllVersions();">
                                üé® ÂõæÊ†áÊ†∑Âºè
                            </button>
                            <button class="option-btn ${item.displayStyle === 'textbox' ? 'active' : ''}"
                                    onclick="updateItem(${item.id}, 'displayStyle', 'textbox'); renderConfig(); generateAllVersions();">
                                üí¨ ÊñáÊú¨Ê°ÜÊ†∑Âºè
                            </button>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Ê†áÈ¢òÔºàÂèØÈÄâÔºâ</label>
                        <input type="text" value="${item.title}" placeholder="ÁïôÁ©∫Âàô‰∏çÊòæÁ§∫Ê†áÈ¢ò"
                               oninput="updateItem(${item.id}, 'title', this.value); generateAllVersions();">
                    </div>
                    <div class="form-group">
                        <label>ÂâØÊ†áÈ¢òÔºàÂèØÈÄâÔºâ</label>
                        <input type="text" value="${item.subtitle}" placeholder="ÁïôÁ©∫Âàô‰∏çÊòæÁ§∫ÂâØÊ†áÈ¢ò"
                               oninput="updateItem(${item.id}, 'subtitle', this.value); generateAllVersions();">
                    </div>
                    <div class="form-group">
                        <label>È¢úËâ≤</label>
                        <input type="color" value="${item.color}" 
                               onchange="updateItem(${item.id}, 'color', this.value); generateAllVersions();">
                    </div>
                    ${item.displayStyle === 'icon' ? `
                        <div class="form-group">
                            <label>ÂΩ¢Áä∂</label>
                            <div class="button-group">
                                <button class="option-btn ${item.shape === 'circle' ? 'active' : ''}"
                                        onclick="updateItem(${item.id}, 'shape', 'circle'); generateAllVersions();">
                                    ‚≠ï ÂúÜÂΩ¢
                                </button>
                                <button class="option-btn ${item.shape === 'square' ? 'active' : ''}"
                                        onclick="updateItem(${item.id}, 'shape', 'square'); generateAllVersions();">
                                    ‚óªÔ∏è ÊñπÂΩ¢
                                </button>
                            </div>
                        </div>
                        <div class="form-group">
                            <label>Emoji</label>
                            <div class="emoji-input-group" id="emojis-${item.id}"></div>
                            <button class="btn-add-emoji" onclick="addEmoji(${item.id})">+ Ê∑ªÂä†Emoji</button>
                        </div>
                    ` : `
                        <div class="form-group">
                            <label>ÊñáÊú¨Ê°ÜÂÜÖÂÆπÔºàÊîØÊåÅÊñáÂ≠óÂíåemojiÊ∑∑ÊéíÔºâ</label>
                            <textarea placeholder="ËæìÂÖ•ÊñáÂ≠óÂíåemojiÔºå‰æãÂ¶ÇÔºömust ü§î&#10;ÊîØÊåÅMarkdownÊ†∑ÂºèÔºö&#10;**Á≤ó‰Ωì** *Êñú‰Ωì* ~~Âà†Èô§Á∫ø~~ ==È´ò‰∫Æ==" 
                                      oninput="updateItem(${item.id}, 'boxContent', this.value); generateAllVersions();">${item.boxContent}</textarea>
                            <div class="style-help">
                                <strong>MarkdownÊ†∑ÂºèËØ≠Ê≥ïÔºö</strong><br>
                                <code>**ÊñáÂ≠ó**</code> Êàñ <code>__ÊñáÂ≠ó__</code> - Âä†Á≤ó<br>
                                <code>*ÊñáÂ≠ó*</code> Êàñ <code>_ÊñáÂ≠ó_</code> - Êñú‰Ωì<br>
                                <code>~~ÊñáÂ≠ó~~</code> - Âà†Èô§Á∫ø<br>
                                <code>==ÊñáÂ≠ó==</code> - ÈªÑËâ≤È´ò‰∫Æ<br>
                                <code>&#96;ÊñáÂ≠ó&#96;</code> - ‰ª£Á†ÅÊ†∑Âºè<br>
                                <br>
                                <strong>È´òÁ∫ßÊ†∑ÂºèÔºàÂêëÂêéÂÖºÂÆπÔºâÔºö</strong><br>
                                <code>[color:#ff0000]ÊñáÂ≠ó[/color]</code> - Ëá™ÂÆö‰πâÈ¢úËâ≤<br>
                                <code>[highlight:#ffff00]ÊñáÂ≠ó[/highlight]</code> - Ëá™ÂÆö‰πâÈ´ò‰∫ÆËâ≤<br>
                                <code>[style:color:#ff0000;background:#ffff00]ÊñáÂ≠ó[/style]</code> - Ëá™ÂÆö‰πâCSSÊ†∑Âºè
                            </div>
                        </div>
                        <div class="form-group">
                            <label>ÊñáÊú¨Ê°ÜÊ†∑Âºè</label>
                            <div class="button-group">
                                <button class="option-btn ${item.boxStyle === 'rounded' ? 'active' : ''}"
                                        onclick="updateItem(${item.id}, 'boxStyle', 'rounded'); generateAllVersions();">
                                    ‚ñ¢ ÂúÜËßíÁü©ÂΩ¢
                                </button>
                                <button class="option-btn ${item.boxStyle === 'rectangle' ? 'active' : ''}"
                                        onclick="updateItem(${item.id}, 'boxStyle', 'rectangle'); generateAllVersions();">
                                    ‚ñ≠ ÈïøÊñπÂΩ¢
                                </button>
                            </div>
                        </div>
                        <div class="form-group">
                            <label>Ê°ÜÂ§ñEmoji</label>
                            <div style="display: flex; gap: 5px; align-items: center;">
                                <input type="text" value="${item.externalEmoji}" placeholder="ÈÄâÊã©emoji" 
                                       style="flex: 1; font-size: 24px; text-align: center;"
                                       oninput="updateItem(${item.id}, 'externalEmoji', this.value); generateAllVersions();">
                                <button class="btn-pick-emoji" onclick="openEmojiPicker(${item.id}, 0, 'externalEmoji')">ÈÄâÊã©</button>
                            </div>
                        </div>
                        <div class="form-group">
                            <label>Ê°ÜÂ§ñEmoji‰ΩçÁΩÆ</label>
                            <div class="button-group">
                                <button class="option-btn ${item.externalEmojiPosition === 'top' ? 'active' : ''}"
                                        onclick="updateItem(${item.id}, 'externalEmojiPosition', 'top'); generateAllVersions();"
                                        style="flex: 0 0 calc(50% - 4px);">
                                    ‚¨ÜÔ∏è ‰∏äÊñπ
                                </button>
                                <button class="option-btn ${item.externalEmojiPosition === 'bottom' ? 'active' : ''}"
                                        onclick="updateItem(${item.id}, 'externalEmojiPosition', 'bottom'); generateAllVersions();"
                                        style="flex: 0 0 calc(50% - 4px);">
                                    ‚¨áÔ∏è ‰∏ãÊñπ
                                </button>
                                <button class="option-btn ${item.externalEmojiPosition === 'left' ? 'active' : ''}"
                                        onclick="updateItem(${item.id}, 'externalEmojiPosition', 'left'); generateAllVersions();"
                                        style="flex: 0 0 calc(50% - 4px);">
                                    ‚¨ÖÔ∏è Â∑¶‰æß
                                </button>
                                <button class="option-btn ${item.externalEmojiPosition === 'right' ? 'active' : ''}"
                                        onclick="updateItem(${item.id}, 'externalEmojiPosition', 'right'); generateAllVersions();"
                                        style="flex: 0 0 calc(50% - 4px);">
                                    ‚û°Ô∏è Âè≥‰æß
                                </button>
                            </div>
                        </div>
                    `}
                `;
                container.appendChild(itemDiv);

                if (item.displayStyle === 'icon') {
                    renderEmojis(item.id, item.emojis);
                }
            });
        }

        // Ê∏≤ÊüìemojiËæìÂÖ•Ê°Ü
        function renderEmojis(itemId, emojis) {
            const container = document.getElementById(`emojis-${itemId}`);
            if (!container) return;
            container.innerHTML = '';
            
            emojis.forEach((emoji, index) => {
                const emojiDiv = document.createElement('div');
                emojiDiv.className = 'emoji-display';
                emojiDiv.style.display = 'flex';
                emojiDiv.style.alignItems = 'center';
                emojiDiv.style.marginBottom = '5px';
                
                const input = document.createElement('input');
                input.type = 'text';
                input.value = emoji;
                input.placeholder = 'ËæìÂÖ•emoji';
                input.style.flex = '1';
                input.oninput = () => {
                    const item = items.find(i => i.id === itemId);
                    item.emojis[index] = input.value;
                    generateAllVersions();
                };
                
                const pickBtn = document.createElement('button');
                pickBtn.className = 'btn-pick-emoji';
                pickBtn.textContent = 'ÈÄâÊã©';
                pickBtn.onclick = () => openEmojiPicker(itemId, index, 'emoji');
                
                const removeBtn = document.createElement('button');
                removeBtn.className = 'btn-remove-emoji';
                removeBtn.textContent = '√ó';
                removeBtn.onclick = () => {
                    const item = items.find(i => i.id === itemId);
                    item.emojis.splice(index, 1);
                    if (item.emojis.length === 0) {
                        item.emojis.push("");
                    }
                    renderConfig();
                    generateAllVersions();
                };
                
                emojiDiv.appendChild(input);
                emojiDiv.appendChild(pickBtn);
                emojiDiv.appendChild(removeBtn);
                container.appendChild(emojiDiv);
            });
        }

        // Ê∑ªÂä†emojiËæìÂÖ•Ê°Ü
        function addEmoji(itemId) {
            const item = items.find(i => i.id === itemId);
            if (item) {
                item.emojis.push("");
                renderConfig();
            }
        }

        // Êõ¥Êñ∞ÂØπÊØîÈ°πÈÖçÁΩÆ
        function updateItem(id, field, value) {
            const item = items.find(i => i.id === id);
            if (item) {
                item[field] = value;
            }
        }

        // Ëß£ÊûêMarkdownÊ†∑ÂºèÊ†áËÆ∞Âπ∂ËΩ¨Êç¢‰∏∫HTML
        function parseTextStyles(text) {
            if (!text) return '';
            
            // ÂÖàËΩ¨‰πâHTMLÁâπÊÆäÂ≠óÁ¨¶
            let html = text
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;');
            
            // MarkdownËØ≠Ê≥ïËß£ÊûêÔºàÊåâ‰ºòÂÖàÁ∫ßÈ°∫Â∫èÔºâ
            
            // 1. ‰ª£Á†ÅÂùóÔºàÂèçÂºïÂè∑Ôºâ- ÊúÄÈ´ò‰ºòÂÖàÁ∫ß
            html = html.replace(/`([^`]+)`/g, '<code style="background-color: rgba(0,0,0,0.1); padding: 2px 4px; border-radius: 3px; font-family: monospace;">$1</code>');
            
            // 2. Âà†Èô§Á∫øÔºà~~ÊñáÂ≠ó~~Ôºâ- Âú®Âä†Á≤ó/Êñú‰Ωì‰πãÂâçÂ§ÑÁêÜ
            html = html.replace(/~~([^~]+)~~/g, '<s>$1</s>');
            
            // 3. Âä†Á≤óÔºà**ÊñáÂ≠ó** Êàñ __ÊñáÂ≠ó__Ôºâ- Âú®Êñú‰Ωì‰πãÂâçÂ§ÑÁêÜ
            html = html.replace(/\*\*([^*]+)\*\*/g, '<strong>$1</strong>');
            html = html.replace(/__([^_]+)__/g, '<strong>$1</strong>');
            
            // 4. Êñú‰ΩìÔºà*ÊñáÂ≠ó* Êàñ _ÊñáÂ≠ó_Ôºâ- ÈÅøÂÖç‰∏éÂä†Á≤óÂÜ≤Á™Å
            // ÂåπÈÖçÂçïÊòüÂè∑ÔºàÂâçÂêé‰∏çÊòØÊòüÂè∑Ôºâ
            html = html.replace(/([^*]|^)\*([^*\n]+?)\*([^*]|$)/g, '$1<em>$2</em>$3');
            // ÂåπÈÖçÂçï‰∏ãÂàíÁ∫øÔºàÂâçÂêé‰∏çÊòØ‰∏ãÂàíÁ∫øÔºå‰∏î‰∏çÂú®ÂçïËØç‰∏≠Èó¥Ôºâ
            html = html.replace(/([^_]|^)_([^_\n]+?)_([^_]|$)/g, '$1<em>$2</em>$3');
            
            // 5. È´ò‰∫ÆÔºà==ÊñáÂ≠ó==Ôºâ
            html = html.replace(/==([^=]+)==/g, '<span style="background-color: #ffff00; padding: 2px 4px; border-radius: 3px;">$1</span>');
            
            // 6. Ëá™ÂÆö‰πâÈ¢úËâ≤Ôºà[color:#ff0000]ÊñáÂ≠ó[/color] - ‰øùÁïôÂêëÂêéÂÖºÂÆπÔºâ
            html = html.replace(/\[color:(#[0-9a-fA-F]{6}|#[0-9a-fA-F]{3}|[a-zA-Z]+)\](.*?)\[\/color\]/gs, 
                '<span style="color: $1;">$2</span>');
            
            // 7. Ëá™ÂÆö‰πâÈ´ò‰∫ÆÔºà[highlight:#ffff00]ÊñáÂ≠ó[/highlight] - ‰øùÁïôÂêëÂêéÂÖºÂÆπÔºâ
            html = html.replace(/\[highlight:(#[0-9a-fA-F]{6}|#[0-9a-fA-F]{3}|[a-zA-Z]+)\](.*?)\[\/highlight\]/gs, 
                '<span style="background-color: $1; padding: 2px 4px; border-radius: 3px;">$2</span>');
            
            // 8. Ëá™ÂÆö‰πâÊ†∑ÂºèÔºà[style:...]ÊñáÂ≠ó[/style] - ‰øùÁïôÂêëÂêéÂÖºÂÆπÔºâ
            html = html.replace(/\[style:(.*?)\](.*?)\[\/style\]/gs, 
                '<span style="$1">$2</span>');
            
            return html;
        }

        // Êõ¥Êñ∞È¢ÑËßà
        function updatePreview() {
            const container = document.getElementById('previewContainer');
            const versionButtons = document.getElementById('versionButtons');

            if (items.length === 0 || allVersions.length === 0) {
                container.innerHTML = '<div class="empty-state">Ê∑ªÂä†ÂØπÊØîÈ°πÂºÄÂßãÈÖçÁΩÆ</div>';
                versionButtons.innerHTML = '';
                return;
            }

            // Êõ¥Êñ∞ÁâàÊú¨ÊåâÈíÆ
            versionButtons.innerHTML = '';
            for (let i = 0; i < allVersions.length; i++) {
                const btn = document.createElement('button');
                btn.className = 'version-btn';
                btn.textContent = allVersions[i].name || `ÁâàÊú¨ ${i + 1}`;
                btn.onclick = () => switchVersion(i);
                if (i === currentVersion) {
                    btn.classList.add('active');
                }
                
                // Ê∑ªÂä†Âà†Èô§ÊåâÈíÆ
                const deleteBtn = document.createElement('button');
                deleteBtn.className = 'btn-delete-version';
                deleteBtn.textContent = '√ó';
                deleteBtn.onclick = (e) => {
                    e.stopPropagation();
                    deleteVersion(i);
                };
                btn.appendChild(deleteBtn);
                
                versionButtons.appendChild(btn);
            }
            
            // Ê∑ªÂä†"Êñ∞Â¢ûÁâàÊú¨"ÊåâÈíÆ
            const addBtn = document.createElement('button');
            addBtn.className = 'btn-add-version';
            addBtn.textContent = '+ Êñ∞Â¢ûÁâàÊú¨';
            addBtn.onclick = addVersion;
            versionButtons.appendChild(addBtn);

            // Êõ¥Êñ∞È¢ÑËßàÂÆπÂô®
            let previewDiv = document.getElementById('previewContainer');
            if (!previewDiv) {
                previewDiv = document.createElement('div');
                previewDiv.className = `comparison-container ${layoutDirection}`;
                previewDiv.id = 'previewContainer';
                container.innerHTML = '';
                container.appendChild(previewDiv);
            } else {
                previewDiv.className = `comparison-container ${layoutDirection}`;
                previewDiv.innerHTML = '';
            }

            const currentVersionData = allVersions[currentVersion];
            const positions = currentVersionData.positions || {};
            
            items.forEach((item, itemIndex) => {
                const itemDiv = document.createElement('div');
                itemDiv.className = 'comparison-item draggable';
                itemDiv.dataset.itemIndex = itemIndex;
                
                // ËÆæÁΩÆ‰ΩçÁΩÆ
                const pos = positions[itemIndex] || {};
                if (pos.x !== undefined && pos.y !== undefined) {
                    itemDiv.style.left = pos.x + 'px';
                    itemDiv.style.top = pos.y + 'px';
                } else {
                    // ÈªòËÆ§‰ΩçÁΩÆÔºàËá™Âä®Â∏ÉÂ±ÄÔºâ
                    // Ê†πÊçÆÊòØÂê¶ÊúâÊ†áÈ¢ò/ÂâØÊ†áÈ¢òË∞ÉÊï¥Èó¥Ë∑ù
                    const hasTitle = items.some(it => it.title || it.subtitle);
                    const horizontalSpacing = hasTitle ? 280 : 220;
                    const verticalSpacing = hasTitle ? 250 : 180;

                    if (layoutDirection === 'vertical') {
                        itemDiv.style.top = (itemIndex * verticalSpacing) + 'px';
                        itemDiv.style.left = '50%';
                        itemDiv.style.transform = 'translateX(-50%)';
                    } else {
                        itemDiv.style.left = (itemIndex * horizontalSpacing + 50) + 'px';
                        itemDiv.style.top = '50%';
                        itemDiv.style.transform = 'translateY(-50%)';
                    }
                }

                if (item.displayStyle === 'icon') {
                    const emoji = currentVersionData.combination[itemIndex] || '';
                    const hasText = item.title || item.subtitle;
                    itemDiv.innerHTML = `
                        <div class="item-actions">
                            <button class="item-action-btn edit" onclick="openItemEditor(${item.id}); event.stopPropagation();" title="ÁºñËæë">‚úèÔ∏è</button>
                            <button class="item-action-btn delete" onclick="deleteItemFromCanvas(${item.id}); event.stopPropagation();" title="Âà†Èô§">üóëÔ∏è</button>
                        </div>
                        <div class="icon-container ${item.shape}" style="background-color: ${item.color}">
                            ${emoji}
                        </div>
                        ${hasText ? `<div class="text-content">
                            ${item.title ? `<div class="title">${item.title}</div>` : ''}
                            ${item.subtitle ? `<div class="subtitle">${item.subtitle}</div>` : ''}
                        </div>` : ''}
                    `;
                } else {
                    const externalEmoji = item.externalEmoji || '';
                    const styledContent = parseTextStyles(item.boxContent || 'ÊñáÊú¨Ê°ÜÂÜÖÂÆπ');
                    const hasText = item.title || item.subtitle;
                    itemDiv.innerHTML = `
                        <div class="item-actions">
                            <button class="item-action-btn edit" onclick="openItemEditor(${item.id}); event.stopPropagation();" title="ÁºñËæë">‚úèÔ∏è</button>
                            <button class="item-action-btn delete" onclick="deleteItemFromCanvas(${item.id}); event.stopPropagation();" title="Âà†Èô§">üóëÔ∏è</button>
                        </div>
                        <div class="text-box-container">
                            ${externalEmoji ? `<div class="external-emoji ${item.externalEmojiPosition}">${externalEmoji}</div>` : ''}
                            <div class="text-box ${item.boxStyle}" style="background-color: ${item.color}; color: white;">
                                ${styledContent}
                            </div>
                        </div>
                        ${hasText ? `<div class="text-content">
                            ${item.title ? `<div class="title">${item.title}</div>` : ''}
                            ${item.subtitle ? `<div class="subtitle">${item.subtitle}</div>` : ''}
                        </div>` : ''}
                    `;
                }
                
                // Ê∑ªÂä†ÊãñÊãΩ‰∫ã‰ª∂
                itemDiv.addEventListener('mousedown', (e) => startDrag(e, itemIndex));
                
                previewDiv.appendChild(itemDiv);
            });
        }

        // ÂºÄÂßãÊãñÊãΩ
        function startDrag(e, itemIndex) {
            // Â¶ÇÊûúÁÇπÂáªÁöÑÊòØÊåâÈíÆÔºå‰∏çËß¶ÂèëÊãñÊãΩ
            if (e.target.closest('.item-action-btn') || e.target.closest('button')) {
                return;
            }

            e.preventDefault();
            const item = e.currentTarget;
            const rect = item.getBoundingClientRect();
            const containerRect = item.parentElement.getBoundingClientRect();

            dragOffset.x = e.clientX - rect.left;
            dragOffset.y = e.clientY - rect.top;
            draggedPreviewItem = itemIndex;

            item.classList.add('dragging');
            item.style.zIndex = '1000';

            document.addEventListener('mousemove', handleDragMove);
            document.addEventListener('mouseup', stopDrag);
        }

        // ÊãñÊãΩÁßªÂä®
        function handleDragMove(e) {
            if (draggedPreviewItem === null) return;
            
            const item = document.querySelector(`[data-item-index="${draggedPreviewItem}"]`);
            if (!item) return;
            
            const container = item.parentElement;
            const containerRect = container.getBoundingClientRect();
            
            let x = e.clientX - containerRect.left - dragOffset.x;
            let y = e.clientY - containerRect.top - dragOffset.y;
            
            // ÈôêÂà∂Âú®ÂÆπÂô®ÂÜÖ
            const itemRect = item.getBoundingClientRect();
            x = Math.max(0, Math.min(x, containerRect.width - itemRect.width));
            y = Math.max(0, Math.min(y, containerRect.height - itemRect.height));
            
            item.style.left = x + 'px';
            item.style.top = y + 'px';
            item.style.transform = 'none';
            
            // ‰øùÂ≠ò‰ΩçÁΩÆ
            if (!allVersions[currentVersion].positions) {
                allVersions[currentVersion].positions = {};
            }
            allVersions[currentVersion].positions[draggedPreviewItem] = { x, y };
        }

        // ÂÅúÊ≠¢ÊãñÊãΩ
        function stopDrag() {
            if (draggedPreviewItem !== null) {
                const item = document.querySelector(`[data-item-index="${draggedPreviewItem}"]`);
                if (item) {
                    item.classList.remove('dragging');
                    item.style.zIndex = '';
                }
                draggedPreviewItem = null;
            }
            
            document.removeEventListener('mousemove', handleDragMove);
            document.removeEventListener('mouseup', stopDrag);
        }

        // ÂàáÊç¢ÁâàÊú¨
        function switchVersion(versionIndex) {
            currentVersion = versionIndex;
            document.querySelectorAll('.version-btn').forEach((btn, index) => {
                if (index === versionIndex) {
                    btn.classList.add('active');
                } else {
                    btn.classList.remove('active');
                }
            });
            updatePreview();
        }

        // ÁÇπÂáªÂºπÁ™óÂ§ñÈÉ®ÂÖ≥Èó≠
        document.getElementById('emojiPickerModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeEmojiPicker();
            }
        });

        // ========== ÁîªÂ∏ÉÊìç‰ΩúÂäüËÉΩ ==========

        // ‰ªéÁîªÂ∏ÉÊ∑ªÂä†ÂÖÉÁ¥†
        function addItemFromCanvas() {
            addItem();
            // ÊªöÂä®Âà∞ÈÖçÁΩÆÈù¢ÊùøÂ∫ïÈÉ®
            const configPanel = document.querySelector('.config-panel');
            if (configPanel) {
                configPanel.scrollTop = configPanel.scrollHeight;
            }
        }

        // ‰ªéÁîªÂ∏ÉÂà†Èô§ÂÖÉÁ¥†
        function deleteItemFromCanvas(itemId) {
            if (confirm('Á°ÆÂÆöË¶ÅÂà†Èô§Ëøô‰∏™ÂÖÉÁ¥†ÂêóÔºü')) {
                deleteItem(itemId);
            }
        }

        // ÂΩìÂâçÁºñËæëÁöÑÂÖÉÁ¥†ID
        let currentEditingItemId = null;

        // ÊâìÂºÄÂÖÉÁ¥†ÁºñËæëÂô®
        function openItemEditor(itemId) {
            currentEditingItemId = itemId;
            const item = items.find(i => i.id === itemId);
            if (!item) return;

            const editorContent = document.getElementById('floatingEditorContent');

            // Ê∏≤ÊüìÁºñËæëÂô®ÂÜÖÂÆπ
            editorContent.innerHTML = `
                <div class="form-group">
                    <label>ÊòæÁ§∫Ê†∑Âºè</label>
                    <div class="button-group">
                        <button class="option-btn ${item.displayStyle === 'icon' ? 'active' : ''}"
                                data-action="updateEditorItem" data-field="displayStyle" data-value="icon">
                            üé® ÂõæÊ†áÊ†∑Âºè
                        </button>
                        <button class="option-btn ${item.displayStyle === 'textbox' ? 'active' : ''}"
                                data-action="updateEditorItem" data-field="displayStyle" data-value="textbox">
                            üí¨ ÊñáÊú¨Ê°ÜÊ†∑Âºè
                        </button>
                    </div>
                </div>
                <div class="form-group">
                    <label>Ê†áÈ¢òÔºàÂèØÈÄâÔºâ</label>
                    <input type="text" value="${item.title}" placeholder="ÁïôÁ©∫Âàô‰∏çÊòæÁ§∫Ê†áÈ¢ò"
                           data-field="title">
                </div>
                <div class="form-group">
                    <label>ÂâØÊ†áÈ¢òÔºàÂèØÈÄâÔºâ</label>
                    <input type="text" value="${item.subtitle}" placeholder="ÁïôÁ©∫Âàô‰∏çÊòæÁ§∫ÂâØÊ†áÈ¢ò"
                           data-field="subtitle">
                </div>
                <div class="form-group">
                    <label>È¢úËâ≤</label>
                    <input type="color" value="${item.color}"
                           data-field="color">
                </div>
                ${item.displayStyle === 'icon' ? `
                    <div class="form-group">
                        <label>ÂΩ¢Áä∂</label>
                        <div class="button-group">
                            <button class="option-btn ${item.shape === 'circle' ? 'active' : ''}"
                                    data-action="updateEditorItem" data-field="shape" data-value="circle">
                                ‚≠ï ÂúÜÂΩ¢
                            </button>
                            <button class="option-btn ${item.shape === 'square' ? 'active' : ''}"
                                    data-action="updateEditorItem" data-field="shape" data-value="square">
                                ‚óªÔ∏è ÊñπÂΩ¢
                            </button>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Emoji</label>
                        <div id="editor-emojis-${item.id}"></div>
                        <button class="btn-add-emoji" data-action="addEmojiInEditor">+ Ê∑ªÂä†Emoji</button>
                    </div>
                ` : `
                    <div class="form-group">
                        <label>ÊñáÊú¨Ê°ÜÂÜÖÂÆπ</label>
                        <textarea placeholder="ËæìÂÖ•ÊñáÂ≠óÂíåemoji"
                                  data-field="boxContent"
                                  style="min-height: 80px;">${item.boxContent || ''}</textarea>
                        <div class="style-help">
                            ÊîØÊåÅMarkdownÔºö<code>**Á≤ó‰Ωì**</code> <code>*Êñú‰Ωì*</code> <code>~~Âà†Èô§Á∫ø~~</code> <code>==È´ò‰∫Æ==</code>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>ÊñáÊú¨Ê°ÜÊ†∑Âºè</label>
                        <div class="button-group">
                            <button class="option-btn ${item.boxStyle === 'rounded' ? 'active' : ''}"
                                    data-action="updateEditorItem" data-field="boxStyle" data-value="rounded">
                                ‚ñ¢ ÂúÜËßíÁü©ÂΩ¢
                            </button>
                            <button class="option-btn ${item.boxStyle === 'rectangle' ? 'active' : ''}"
                                    data-action="updateEditorItem" data-field="boxStyle" data-value="rectangle">
                                ‚ñ≠ ÈïøÊñπÂΩ¢
                            </button>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Ê°ÜÂ§ñEmoji</label>
                        <div style="display: flex; gap: 5px; align-items: center;">
                            <input type="text" value="${item.externalEmoji || ''}" placeholder="ÈÄâÊã©emoji"
                                   style="flex: 1; font-size: 24px; text-align: center;"
                                   data-field="externalEmoji">
                            <button class="btn-pick-emoji" data-action="openEmojiPickerInEditor" data-field="externalEmoji">ÈÄâÊã©</button>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Ê°ÜÂ§ñEmoji‰ΩçÁΩÆ</label>
                        <div class="button-group">
                            <button class="option-btn ${item.externalEmojiPosition === 'top' ? 'active' : ''}"
                                    data-action="updateEditorItem" data-field="externalEmojiPosition" data-value="top"
                                    style="flex: 0 0 calc(50% - 4px);">
                                ‚¨ÜÔ∏è ‰∏äÊñπ
                            </button>
                            <button class="option-btn ${item.externalEmojiPosition === 'bottom' ? 'active' : ''}"
                                    data-action="updateEditorItem" data-field="externalEmojiPosition" data-value="bottom"
                                    style="flex: 0 0 calc(50% - 4px);">
                                ‚¨áÔ∏è ‰∏ãÊñπ
                            </button>
                            <button class="option-btn ${item.externalEmojiPosition === 'left' ? 'active' : ''}"
                                    data-action="updateEditorItem" data-field="externalEmojiPosition" data-value="left"
                                    style="flex: 0 0 calc(50% - 4px);">
                                ‚¨ÖÔ∏è Â∑¶‰æß
                            </button>
                            <button class="option-btn ${item.externalEmojiPosition === 'right' ? 'active' : ''}"
                                    data-action="updateEditorItem" data-field="externalEmojiPosition" data-value="right"
                                    style="flex: 0 0 calc(50% - 4px);">
                                ‚û°Ô∏è Âè≥‰æß
                            </button>
                        </div>
                    </div>
                `}
            `;

            // Â¶ÇÊûúÊòØÂõæÊ†áÊ†∑ÂºèÔºåÊ∏≤ÊüìemojiÂàóË°®
            if (item.displayStyle === 'icon') {
                renderEditorEmojis(item.id, item.emojis);
            }

            // Ê∑ªÂä†‰∫ã‰ª∂ÂßîÊâòÁõëÂê¨Âô®
            attachEditorEventListeners();

            // ÊòæÁ§∫ÁºñËæëÂô®
            document.getElementById('floatingEditorOverlay').classList.add('show');
            document.getElementById('floatingEditor').classList.add('show');
        }

        // ‰∏∫ÁºñËæëÂô®ÈôÑÂä†‰∫ã‰ª∂ÁõëÂê¨Âô®
        function attachEditorEventListeners() {
            const editorContent = document.getElementById('floatingEditorContent');

            // ÁßªÈô§ÊóßÁöÑÁõëÂê¨Âô®ÔºàÂ¶ÇÊûúÊúâÔºâ
            const newEditor = editorContent.cloneNode(true);
            editorContent.parentNode.replaceChild(newEditor, editorContent);

            // ÊåâÈíÆÁÇπÂáª‰∫ã‰ª∂ÂßîÊâò
            newEditor.addEventListener('click', function(e) {
                const button = e.target.closest('[data-action]');
                if (!button) return;

                const action = button.dataset.action;
                const field = button.dataset.field;
                const value = button.dataset.value;

                if (action === 'updateEditorItem' && field && value !== undefined) {
                    updateEditorItem(field, value);
                } else if (action === 'addEmojiInEditor') {
                    addEmojiInEditor();
                } else if (action === 'openEmojiPickerInEditor' && field) {
                    openEmojiPickerInEditor(field);
                }
            });

            // ËæìÂÖ•Ê°ÜÂíåÊñáÊú¨ÂüüÁöÑchange‰∫ã‰ª∂ÂßîÊâò
            newEditor.addEventListener('change', function(e) {
                const field = e.target.dataset.field;
                if (field) {
                    updateEditorItem(field, e.target.value);
                }
            });

            // ÂÆûÊó∂ËæìÂÖ•‰∫ã‰ª∂ÔºàÈíàÂØπÊñáÊú¨ËæìÂÖ•Ê°ÜÔºâ
            newEditor.addEventListener('input', function(e) {
                const field = e.target.dataset.field;
                if (field && (e.target.type === 'text' || e.target.tagName === 'TEXTAREA')) {
                    // ‰ΩøÁî®Èò≤ÊäñÔºåÈÅøÂÖçÈ¢ëÁπÅÊõ¥Êñ∞
                    clearTimeout(window.editorInputTimeout);
                    window.editorInputTimeout = setTimeout(() => {
                        updateEditorItem(field, e.target.value);
                    }, 300);
                }
            });
        }

        // ÂÖ≥Èó≠ÊµÆÂä®ÁºñËæëÂô®
        function closeFloatingEditor() {
            document.getElementById('floatingEditorOverlay').classList.remove('show');
            document.getElementById('floatingEditor').classList.remove('show');
            currentEditingItemId = null;
        }

        // Êõ¥Êñ∞ÁºñËæëÂô®‰∏≠ÁöÑÂÖÉÁ¥†Â±ûÊÄß
        function updateEditorItem(field, value) {
            if (!currentEditingItemId) return;

            updateItem(currentEditingItemId, field, value);

            // Â¶ÇÊûúÊòØÂàáÊç¢ÊòæÁ§∫Ê†∑ÂºèÔºåÈáçÊñ∞Ê∏≤ÊüìÁºñËæëÂô®
            if (field === 'displayStyle') {
                openItemEditor(currentEditingItemId);
            } else {
                generateAllVersions();
            }
        }

        // Âú®ÁºñËæëÂô®‰∏≠Ê∏≤ÊüìemojiÂàóË°®
        function renderEditorEmojis(itemId, emojis) {
            const container = document.getElementById(`editor-emojis-${itemId}`);
            if (!container) return;
            container.innerHTML = '';

            emojis.forEach((emoji, index) => {
                const emojiDiv = document.createElement('div');
                emojiDiv.style.display = 'flex';
                emojiDiv.style.alignItems = 'center';
                emojiDiv.style.marginBottom = '8px';
                emojiDiv.style.gap = '5px';

                const input = document.createElement('input');
                input.type = 'text';
                input.value = emoji;
                input.placeholder = 'ËæìÂÖ•emoji';
                input.style.flex = '1';
                input.style.padding = '8px';
                input.style.border = '1px solid #ddd';
                input.style.borderRadius = '6px';
                input.dataset.emojiIndex = index;
                input.addEventListener('change', function() {
                    const item = items.find(i => i.id === itemId);
                    if (item) {
                        item.emojis[index] = this.value;
                        generateAllVersions();
                    }
                });

                const pickBtn = document.createElement('button');
                pickBtn.className = 'btn-pick-emoji';
                pickBtn.textContent = 'ÈÄâÊã©';
                pickBtn.dataset.emojiIndex = index;
                pickBtn.addEventListener('click', function() {
                    openEmojiPickerInEditor('emoji', index);
                });

                const removeBtn = document.createElement('button');
                removeBtn.className = 'btn-remove-emoji';
                removeBtn.textContent = '√ó';
                removeBtn.addEventListener('click', function() {
                    const item = items.find(i => i.id === itemId);
                    if (item) {
                        item.emojis.splice(index, 1);
                        if (item.emojis.length === 0) {
                            item.emojis.push("");
                        }
                        renderEditorEmojis(itemId, item.emojis);
                        generateAllVersions();
                    }
                });

                emojiDiv.appendChild(input);
                emojiDiv.appendChild(pickBtn);
                emojiDiv.appendChild(removeBtn);
                container.appendChild(emojiDiv);
            });
        }

        // Âú®ÁºñËæëÂô®‰∏≠Ê∑ªÂä†emoji
        function addEmojiInEditor() {
            if (!currentEditingItemId) return;
            const item = items.find(i => i.id === currentEditingItemId);
            if (item) {
                item.emojis.push("");
                renderEditorEmojis(item.id, item.emojis);
            }
        }

        // Âú®ÁºñËæëÂô®‰∏≠ÊâìÂºÄemojiÈÄâÊã©Âô®
        function openEmojiPickerInEditor(field, emojiIndex = 0) {
            currentEmojiPicker.itemId = currentEditingItemId;
            currentEmojiPicker.emojiIndex = emojiIndex;
            currentEmojiPicker.field = field;
            document.getElementById('emojiPickerModal').classList.add('show');
        }

        // È°µÈù¢Âä†ËΩΩÊó∂ÂàùÂßãÂåñ
        init();
    </script>
</body>
</html>
